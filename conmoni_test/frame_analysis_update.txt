# conmoni_test 受信フレーム解析機能追加

## 更新日時
2025-11-13

## 概要
andonプロジェクトの受信フレーム解析実装を参考に、conmoni_testに基本的な解析機能を追加しました。

## 追加機能

### 1. program_single.cs（単一テストプログラム）
詳細な解析機能を追加し、受信データの構造を可視化します。

#### 追加メソッド
- `AnalyzeResponseFrame()`: 受信フレーム解析のメインメソッド
- `DetectFrameType()`: サブヘッダからフレームタイプ判定（3E/4E）
- `Parse3EFrame()`: 3Eフレームの詳細解析と表示
- `Parse4EFrame()`: 4Eフレームの詳細解析と表示

#### 解析内容（3Eフレーム）
- サブヘッダ: 0xD0 0x00
- ネットワーク番号
- PC番号
- I/O番号（リトルエンディアン）
- 局番
- データ長（リトルエンディアン）
- 終了コード（リトルエンディアン）
- デバイスデータ（HEXダンプ表示）

#### 解析内容（4Eフレーム）
- サブヘッダ: 0xD4 0x00
- ネットワーク番号
- PC番号
- I/O番号（リトルエンディアン）
- 局番
- データ長（リトルエンディアン）
- 監視タイマ（リトルエンディアン）
- 終了コード（リトルエンディアン）
- デバイスデータ（HEXダンプ表示）

### 2. program.cs（連続実行プログラム）
簡易的な解析機能を追加し、連続実行時のログ出力を拡張します。

#### 追加メソッド
- `AnalyzeResponseFrame()`: 受信フレーム解析（簡易版）
- `DetectFrameType()`: フレームタイプ判定
- `ParseAndLog3EFrame()`: 3Eフレーム簡易解析とログ出力
- `ParseAndLog4EFrame()`: 4Eフレーム簡易解析とログ出力

#### 出力内容
- フレームタイプ（3E/4E）
- 終了コード（正常/エラー）
- デバイスデータ長

## andonとの対応関係

### andon実装を参考にした部分
1. **DetectFrameTypeFromSubheader** → **DetectFrameType**
   - サブヘッダバイトから3E/4Eフレームを判定
   - 3E: 0xD0 0x00
   - 4E: 0xD4 0x00

2. **Parse3EFrameStructure** → **Parse3EFrame**
   - 3Eフレームの構造解析
   - リトルエンディアンでのデータ抽出
   - 最小長チェック（11バイト）

3. **Parse4EFrameStructure** → **Parse4EFrame**
   - 4Eフレームの構造解析
   - リトルエンディアンでのデータ抽出
   - 最小長チェック（13バイト）

### 簡略化した部分
- エラーハンドリング: 基本的なtry-catch処理のみ
- 検証機能: 最小限の長さチェックのみ
- ログ出力: Console.WriteLineによるシンプルな出力

## 実装メモ

### フレーム構造の違い
- **3Eフレーム**: 応答ヘッダ11バイト（終了コードはIdx 9-10）
- **4Eフレーム**: 応答ヘッダ13バイト（終了コードはIdx 11-12、監視タイマ追加）

### リトルエンディアン処理
```csharp
ushort value = (ushort)(rawData[low] | (rawData[high] << 8));
```

### エンディアン注意事項
PLCからの応答データはリトルエンディアン形式のため、2バイトデータの読み取り時は下位バイトを先に読む必要があります。

## 今後の拡張可能性
- デバイス値の型変換機能（ビット/ワード/Dワード）
- 複数デバイスの自動解析
- エラーコード詳細表示
- 統計情報の収集

## 参照
- andon/Core/Managers/PlcCommunicationManager.cs
  - ProcessReceivedRawData (行864-985)
  - DetectFrameTypeFromSubheader (行1259-1288)
  - Parse3EFrameStructure (行1331-1365)
  - Parse4EFrameStructure (行1370-1408)
