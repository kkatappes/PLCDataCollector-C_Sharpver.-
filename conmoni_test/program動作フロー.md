# program.cs 動作フロー説明

## 📋 プログラムの全体構成

このプログラムは**PLC（Programmable Logic Controller）から定期的にデータを取得し、PostgreSQLデータベースに保存する監視アプリケーション**です。

## 🔄 動作フロー

### 1. **アプリケーション起動** (Main関数: 47-66行)
```
無限ループ開始
  ↓
App インスタンス作成
  ↓
Run() 実行
  ↓
エラー発生時 → 5秒待機 → 再起動
```

### 2. **初期化処理** (Appコンストラクタ: 91-122行)
```
実行ディレクトリ取得
  ↓
dataディレクトリ存在確認
  ↓
全JSONファイル読み込み (*.json)
  ↓
各JSONを SettingData オブジェクトに変換
  ↓
PostgreSQL接続文字列設定
  ↓
データベース接続確立
```

**読み込まれる設定情報:**
- `AccessPlcSetting`: PLCへ送信するコマンド
- `IPAddress`: PLC のIPアドレス
- `Port`: 接続ポート番号
- `ConnectionMethod`: "TCP" or "UDP"
- `Key`: データ識別用キー

### 3. **データベース接続** (EstablishConnection: 128-151行)
```
PostgreSQL接続試行
  ↓
成功 → 次へ
  ↓
失敗 → エラー表示 → 3秒待機 → 再試行（無限ループ）
```

### 4. **メインループ** (Run関数: 214-270行)
```
無限ループ開始
  ↓
  ┌─────────────────────────────┐
  │ 各PLC設定に対して実行      │
  │  (foreachループ)           │
  │   ↓                        │
  │ SocketConnection実行       │
  │   (PLC接続・データ取得)    │
  │   ↓                        │
  │ データ取得成功?            │
  │   No → 次の設定へ          │
  │   Yes ↓                    │
  │ データベースINSERT          │
  │   (成功するまでリトライ)    │
  │   ↓                        │
  │ 接続エラー時は再接続       │
  └─────────────────────────────┘
  ↓
10ms スリープ (CPU負荷軽減)
  ↓
ループ継続
```

### 5. **PLC通信処理** (SocketConnection: 158-208行)
```
接続方式に応じたソケット作成 (TCP/UDP)
  ↓
受信タイムアウト設定 (3ms)
  ↓
PLC に接続
  ↓
コマンドデータ送信 (AccessPlcSetting)
  ↓
応答データ受信 (最大4KB)
  ↓
(Response, Key, TimeStamp) を返す
  ↓
エラー時は (null, null, default) を返す
```

### 6. **データベース保存** (Run関数内: 229-265行)
```
INSERT SQL準備
  ↓
  ┌────────────────────────┐
  │ リトライループ         │
  │   ↓                   │
  │ INSERT実行            │
  │   ↓                   │
  │ 成功 → ループ終了     │
  │   ↓                   │
  │ 失敗 → 接続クローズ    │
  │      → 再接続         │
  │      → リトライ       │
  └────────────────────────┘
```

**保存されるデータ:**
- `c_datetime`: データ取得タイムスタンプ
- `key`: PLC識別キー
- `value`: 受信したバイトデータ

## 🎯 特徴

1. **高可用性設計**: すべてのエラーは自動復旧（再接続・リトライ）
2. **マルチPLC対応**: 複数のJSON設定ファイルで複数PLCを監視可能
3. **TCP/UDP対応**: 接続方式を設定で切り替え可能
4. **負荷制御**: 10msスリープでCPU使用率を抑制
5. **短いタイムアウト**: 3ms受信タイムアウトで高速応答

## 📊 データフロー図

```
[JSON設定ファイル群]
         ↓
    [App初期化]
         ↓
  [DB接続確立]
         ↓
    ┌──────────┐
    │メインループ│ ←─────┐
    └──────────┘        │
         ↓              │
    [PLC接続]           │
         ↓              │
   [データ送信]          │
         ↓              │
   [応答受信]           │
         ↓              │
   [DB保存]             │
         ↓              │
    [10msスリープ]      │
         └──────────────┘
```

## ⚠️ 注意点

- 受信タイムアウトが**3ms**と非常に短い (program.cs:171)
- エラー時の自動復旧により、プログラムは永続的に動作し続ける
- データベース接続文字列がハードコード (program.cs:118)
- 無限ループ設計のため、正常終了の手段がない

## 📁 関連ファイル

- **program.cs**: メインプログラム (本ファイル)
- **data/*.json**: PLC接続設定ファイル群
- **PostgreSQLデータベース**: `cbm_stream.cbm` テーブル

## 🔧 主要な設定項目

### SettingData クラス (24-40行)
| プロパティ | 型 | 説明 |
|-----------|-----|------|
| AccessPlcSetting | List<int> | PLCへ送信するコマンドバイト列 |
| IPAddress | string | PLCのIPアドレス |
| Port | int | 接続ポート番号 |
| ConnectionMethod | string | "TCP" または "UDP" |
| Key | string | データ識別キー |

### データベーステーブル構造
```sql
テーブル名: cbm
- c_datetime (timestamp): データ取得時刻
- key (text): PLC識別キー
- value (bytea): 受信データ（バイナリ）
```

## 📌 コード参照

- **アプリケーション起動**: program.cs:47-66
- **初期化処理**: program.cs:91-122
- **メインループ**: program.cs:214-270
- **PLC通信**: program.cs:158-208
- **DB接続確立**: program.cs:128-151
