# 実行ファイル化 修正履歴

**日付**: 2025年12月1日
**目的**: andonプロジェクトの実行ファイル化と本番環境での動作確認
**結果**: ✅ 成功（開発環境での動作確認完了、本番環境への展開準備完了）

---

## 修正内容サマリー

実行ファイル化（`dotnet publish`）時に発生した問題を修正し、正常に動作する実行ファイルを作成しました。

### 主な問題と修正

1. **複数のMainメソッド競合** → verify_hex_length.cs を除外
2. **config/ディレクトリ不存在** → ディレクトリ作成、README追加
3. **appsettings.json未バインド** → DIコンテナに設定を注入
4. **LoggingManagerの依存性注入エラー** → IOptions<LoggingConfig>対応
5. **ExecutionOrchestratorの依存性注入エラー** → IConfigToFrameManager登録
6. **MultiPlcConfigManagerの複数インスタンス問題** → Singleton化

---

## 詳細な修正内容

### 1. verify_hex_length.cs の除外

**問題**:
- `andon/verify_hex_length.cs` に別の `Main` メソッドが存在
- 実行ファイル化時、こちらの `Main` が実行されていた
- 結果: "Hex文字列長: 254文字" というメッセージだけが表示されて終了

**修正**: `andon/andon.csproj` にコンパイル除外設定を追加

```xml
<!-- andon/andon.csproj -->
<ItemGroup>
  <Compile Remove="verify_hex_length.cs" />
</ItemGroup>
```

**ファイル**: `andon/andon.csproj`
**変更箇所**: 44-47行目

---

### 2. config/ ディレクトリの作成

**問題**:
- `ConfigurationWatcher` が `./config/` ディレクトリの監視を開始
- publishフォルダに `config/` ディレクトリが存在しない
- 結果: `The directory name './config/' does not exist.` エラーで起動失敗

**修正**:
```bash
mkdir publish/config
mv publish/5JRS_N2.xlsx publish/config/
```

**フォルダ構成**:
```
publish/
├── andon.exe
├── appsettings.json
├── config/              ← 新規作成
│   └── 5JRS_N2.xlsx    ← Excelファイルを移動
└── logs/
```

**対応ファイル**: なし（手動作成）

---

### 3. appsettings.json の設定バインド

**問題**:
- `DependencyInjectionConfigurator.Configure` が `IConfiguration` を受け取っていない
- appsettings.json の設定値がDIコンテナにバインドされていない
- 結果: LoggingConfig、DataProcessingConfig などがデフォルト値のまま

**修正1**: `DependencyInjectionConfigurator.Configure` のシグネチャ変更

```csharp
// 修正前
public static void Configure(IServiceCollection services)

// 修正後
public static void Configure(IServiceCollection services, IConfiguration configuration)
```

**修正2**: appsettings.jsonからConfigクラスへのバインド追加

```csharp
// andon/Services/DependencyInjectionConfigurator.cs

// appsettings.jsonから設定をバインド
services.Configure<DataProcessingConfig>(configuration.GetSection("PlcCommunication"));
services.Configure<SystemResourcesConfig>(configuration.GetSection("SystemResources"));
services.Configure<LoggingConfig>(configuration.GetSection("LoggingConfig"));
```

**修正3**: Program.cs で IConfiguration を渡す

```csharp
// andon/Program.cs
Host.CreateDefaultBuilder(args)
    .ConfigureServices((hostContext, services) =>
    {
        DependencyInjectionConfigurator.Configure(services, hostContext.Configuration);
        services.AddHostedService<AndonHostedService>();
    });
```

**修正4**: using追加

```csharp
// andon/Services/DependencyInjectionConfigurator.cs
using Microsoft.Extensions.Configuration;  // 追加
```

**ファイル**:
- `andon/Services/DependencyInjectionConfigurator.cs` (18-32行目)
- `andon/Program.cs` (31行目)

---

### 4. LoggingManager のコンストラクタ修正

**問題**:
- `LoggingManager` のコンストラクタが `LoggingConfig` を直接受け取る設計
- DIコンテナは `IOptions<LoggingConfig>` として登録している
- 結果: LoggingManager の初期化失敗、ログファイルが作成されない

**修正**: コンストラクタを `IOptions<LoggingConfig>` を受け取るように変更

```csharp
// andon/Core/Managers/LoggingManager.cs

// using追加
using Microsoft.Extensions.Options;

// 修正前
public LoggingManager(ILogger<LoggingManager> logger, LoggingConfig config)
{
    _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    _config = config ?? throw new ArgumentNullException(nameof(config));
    // ...
}

// 修正後
public LoggingManager(ILogger<LoggingManager> logger, IOptions<LoggingConfig> configOptions)
{
    _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    if (configOptions == null) throw new ArgumentNullException(nameof(configOptions));
    _config = configOptions.Value ?? throw new ArgumentNullException(nameof(configOptions.Value));
    _currentLogLevel = ParseLogLevel(_config.LogLevel);

    if (_config.EnableFileOutput)
    {
        InitializeFileWriter();
    }
}
```

**ファイル**: `andon/Core/Managers/LoggingManager.cs` (1-2行目, 42-53行目)

---

### 5. IConfigToFrameManager の登録

**問題**:
- `ConfigToFrameManager` がインターフェースなしで登録されていた
- `ExecutionOrchestrator` の完全コンストラクタが使用されない
- 結果: `_configToFrameManager` が null、フレーム構築失敗

**修正**: `IConfigToFrameManager` インターフェースとして登録

```csharp
// andon/Services/DependencyInjectionConfigurator.cs

// 修正前
services.AddTransient<ConfigToFrameManager>(); // インターフェースなし

// 修正後
services.AddTransient<IConfigToFrameManager, ConfigToFrameManager>(); // インターフェースあり
```

**ファイル**: `andon/Services/DependencyInjectionConfigurator.cs` (45行目)

---

### 6. MultiPlcConfigManager を Singleton に変更

**問題**:
- `MultiPlcConfigManager` が **Transient** として登録されていた
- `ConfigurationLoaderExcel` と `ApplicationController` が別々のインスタンスを使用
- 結果: ConfigurationLoaderExcelが設定を追加しても、ApplicationControllerは空の設定を参照

**症状**:
```
[DEBUG Internal] plcManagers: 0, plcConfigs: 0
[DEBUG Internal] plcManagers is null or empty, returning
```

**修正**: **Singleton** に変更

```csharp
// andon/Services/DependencyInjectionConfigurator.cs

// 修正前
services.AddTransient<MultiPlcConfigManager>();

// 修正後
services.AddSingleton<MultiPlcConfigManager>(); // Singleton化
```

**ファイル**: `andon/Services/DependencyInjectionConfigurator.cs` (51行目)

**重要**: この修正により、アプリケーション全体で同じ `MultiPlcConfigManager` インスタンスを共有するようになり、設定が正しく参照されるようになった。

---

## ビルドコマンド

### クリーンビルド
```bash
dotnet clean andon/andon.csproj
```

### リリースビルド（実行ファイル生成）
```bash
dotnet publish andon/andon.csproj -c Release -o publish
```

**生成される実行ファイル**:
- `publish/andon.exe` (約38MB)
- 自己完結型（.NET 9.0 ランタイム内包）

---

## 動作確認結果

### 開発環境（PLC未接続）

✅ **正常に動作**

**ログ出力**:
```
[DEBUG Internal] ExecuteMultiPlcCycleAsync_Internal started
[DEBUG Internal] plcManagers: 1, plcConfigs: 1
[DEBUG Internal] Processing PLC 0: 172.30.40.40:8192
[DEBUG Internal] Building frame...
[DEBUG Internal] Frame built, length: 837
[DEBUG Internal] Executing full cycle...
[INFO] 完全サイクル開始: サーバー=172.30.40.40:8192
[DEBUG Internal] Full cycle completed. IsSuccess: False
```

**確認事項**:
- ✅ 設定ファイル（Excel）読み込み成功
- ✅ 1秒ごとのPLC通信サイクル実行
- ✅ ログファイル出力（`logs/andon.log`）
- ✅ Ctrl+C での適切な終了処理
- ⚠️ `IsSuccess: False` は正常（開発環境にPLCが存在しないため）

---

## 本番環境への展開手順

### 1. フォルダごとコピー

```
開発環境: C:\Users\1010821\Desktop\python\andon\publish\
  ↓
本番環境: C:\Users\PPESAdmin\Desktop\x\
```

### 2. 必須ファイル・フォルダ

```
x/
├── andon.exe               ← 実行ファイル
├── appsettings.json        ← 設定ファイル
├── config/                 ← Excel設定フォルダ（必須）
│   └── *.xlsx              ← PLC接続設定ファイル
└── logs/                   ← ログ出力フォルダ（自動生成）
```

### 3. 設定の確認

**appsettings.json**:
- `PlcCommunication.Connection.IpAddress` → 本番PLCのIPアドレス
- `PlcCommunication.Connection.Port` → 本番PLCのポート番号
- `MonitoringIntervalMs` → データ取得間隔（ミリ秒）

**config/*.xlsx**:
- PLC接続情報（IPアドレス、ポート、通信方式）
- デバイス情報（デバイスタイプ、デバイス番号）

### 4. 実行

```cmd
cd C:\Users\PPESAdmin\Desktop\x
andon.exe
```

### 5. 停止

**Ctrl+C** を押す、またはコマンドプロンプトを閉じる

---

## 本番環境でのトラブルシューティング

### 問題1: config/ディレクトリが存在しない

**エラー**:
```
[ERROR] ExecuteAsync failed | Exception: The directory name './config/' does not exist.
```

**対処**:
```cmd
mkdir C:\Users\PPESAdmin\Desktop\x\config
```

### 問題2: PLC通信サイクルが実行されない

**症状**:
```
[INFO] Starting continuous data cycle
（その後、PLC通信のログが一切出ない）
```

**原因**:
- `config/` フォルダに `*.xlsx` ファイルが存在しない
- または Excelファイルが空

**対処**:
開発環境の `5JRS_N2.xlsx` をコピー
```cmd
copy C:\Users\1010821\Desktop\python\andon\publish\config\5JRS_N2.xlsx C:\Users\PPESAdmin\Desktop\x\config\
```

### 問題3: "Previous cycle still running" の連続発生

**症状**:
```
[WARN] Previous cycle still running, skipping this interval
```

**原因**:
- PLC通信がタイムアウトしている
- タイムアウト設定が長すぎる

**対処**: `appsettings.json` のタイムアウトを短縮
```json
{
  "PlcCommunication": {
    "Timeouts": {
      "ConnectTimeoutMs": 1000,
      "SendTimeoutMs": 300,
      "ReceiveTimeoutMs": 300
    },
    "MonitoringIntervalMs": 2000
  }
}
```

---

## 作成したファイル

### publish/README.txt

本番環境での実行方法、トラブルシューティングをまとめたドキュメント。

**内容**:
- フォルダ構成
- 実行方法
- 設定ファイルの説明
- ログファイルの説明
- トラブルシューティング

**場所**: `C:\Users\1010821\Desktop\python\andon\publish\README.txt`

---

## 関連ファイル一覧

### 修正したファイル

1. `andon/andon.csproj` - verify_hex_length.cs の除外設定
2. `andon/Program.cs` - IConfiguration を DependencyInjectionConfigurator に渡す
3. `andon/Services/DependencyInjectionConfigurator.cs` - 設定バインド、Singleton化
4. `andon/Core/Managers/LoggingManager.cs` - IOptions<LoggingConfig>対応

### 新規作成したファイル

1. `publish/README.txt` - 本番環境用ドキュメント

### 手動操作（コマンド）

1. `mkdir publish/config` - configフォルダ作成
2. `mv publish/5JRS_N2.xlsx publish/config/` - Excelファイル移動

---

## 今後の注意事項

### 1. 新規ファイル追加時の注意

プロジェクトルート（`andon/`）に `Main` メソッドを含むファイルを作成しないこと。
テスト用コードは `Tests/` フォルダに配置する。

### 2. DIコンテナの登録

新しいマネージャークラスを追加する場合：
- **複数のクラスで設定を共有する場合**: `Singleton`
- **要求ごとに新しいインスタンスが必要な場合**: `Transient`

### 3. 設定クラスの使用

新しい設定クラスを追加する場合：
1. `appsettings.json` にセクションを追加
2. `DependencyInjectionConfigurator.Configure` で `services.Configure<T>()` を追加
3. コンストラクタで `IOptions<T>` を受け取る

---

## まとめ

今回の修正により、以下が達成されました：

1. ✅ 実行ファイル（andon.exe）の正常な生成
2. ✅ 開発環境での動作確認
3. ✅ 本番環境への展開準備完了
4. ✅ トラブルシューティング手順の文書化

**重要な修正**:
- MultiPlcConfigManager の **Singleton化** が最も重要な修正でした
- これにより、ConfigurationLoaderExcel と ApplicationController が同じ設定を参照できるようになりました

**次のステップ**:
本番環境でPLCに接続し、実データ取得のテストを実施してください。
