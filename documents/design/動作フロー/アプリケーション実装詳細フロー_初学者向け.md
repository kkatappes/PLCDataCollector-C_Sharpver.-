# PLCãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ - è©³ç´°å‹•ä½œãƒ•ãƒ­ãƒ¼åˆ†æãƒ¬ãƒãƒ¼ãƒˆï¼ˆåˆå­¦è€…å‘ã‘è§£èª¬ç‰ˆï¼‰

**ä½œæˆæ—¥**: 2025-12-02
**æœ€çµ‚æ›´æ–°**: 2025-12-02ï¼ˆPhase12æ’ä¹…å¯¾ç­–åæ˜ ï¼‰
**å¯¾è±¡**: andon/Core å®Ÿè£…ã‚³ãƒ¼ãƒ‰
**ç›®çš„**: Stepé–“ã®ç¹‹ãŒã‚Šãƒ»ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ•ãƒ­ãƒ¼ãƒ»ã‚³ãƒ¼ãƒ‰å„è¡Œã®è©³ç´°è§£èª¬ãƒ»DIã‚³ãƒ³ãƒ†ãƒŠã®å‹•ä½œ

---

## ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¤ã„ã¦

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€C#åˆå­¦è€…ã§ã‚‚ç†è§£ã§ãã‚‹ã‚ˆã†ã«ã€å„ã‚³ãƒ¼ãƒ‰ã®è¡Œå˜ä½ã§ã®è©³ç´°ãªè§£èª¬ã‚’å«ã‚ã¦ã„ã¾ã™ã€‚
ç‰¹ã«DIã‚³ãƒ³ãƒ†ãƒŠï¼ˆDependency Injection Containerï¼‰ã®å‹•ä½œã€ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ©ã‚¤ãƒ•ã‚¿ã‚¤ãƒ ç®¡ç†ã€
è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã®å€¤ã®èª­ã¿è¾¼ã¿ãªã©ã€.NET Coreã®é‡è¦ãªæ¦‚å¿µã‚‚è©³ç´°ã«è§£èª¬ã—ã¦ã„ã¾ã™ã€‚

ä»¥ä¸‹ã®è¨˜å·ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ï¼š

- `//` : ãã®è¡Œã®èª¬æ˜ã‚³ãƒ¡ãƒ³ãƒˆ
- `â˜…` : ç‰¹ã«é‡è¦ãªãƒã‚¤ãƒ³ãƒˆ
- `âœ…` : æ­£å¸¸ãªå‹•ä½œ
- `âš ï¸` : æ³¨æ„ãŒå¿…è¦ãªç‚¹
- `âŒ` : ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹
- `ğŸ”§` : DIé–¢é€£ã®èª¬æ˜

---

## ç›®æ¬¡

1. [ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•ã¨DIã‚³ãƒ³ãƒ†ãƒŠã®ä»•çµ„ã¿](#1-ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•ã¨diã‚³ãƒ³ãƒ†ãƒŠã®ä»•çµ„ã¿)
2. [DIã‚³ãƒ³ãƒ†ãƒŠã®è©³ç´°å‹•ä½œ](#2-diã‚³ãƒ³ãƒ†ãƒŠã®è©³ç´°å‹•ä½œ)
3. [Step1: åˆæœŸåŒ–ãƒ•ã‚§ãƒ¼ã‚º](#3-step1-åˆæœŸåŒ–ãƒ•ã‚§ãƒ¼ã‚º1å›ã®ã¿å®Ÿè¡Œ)
4. [Step2: ãƒ•ãƒ¬ãƒ¼ãƒ æ§‹ç¯‰](#4-step2-ãƒ•ãƒ¬ãƒ¼ãƒ æ§‹ç¯‰)
5. [Step3: PLCæ¥ç¶š](#5-step3-plcæ¥ç¶š)
6. [Step4: ãƒ‡ãƒ¼ã‚¿é€å—ä¿¡](#6-step4-ãƒ‡ãƒ¼ã‚¿é€å—ä¿¡)
7. [Step6: ãƒ‡ãƒ¼ã‚¿è§£æ](#7-step6-ãƒ‡ãƒ¼ã‚¿è§£æ)
8. [Step7: JSONå‡ºåŠ›](#8-step7-jsonå‡ºåŠ›)
9. [ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°](#9-ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°)
10. [C#ã®é‡è¦ãªæ¦‚å¿µï¼ˆåˆå­¦è€…å‘ã‘ï¼‰](#10-cã®é‡è¦ãªæ¦‚å¿µåˆå­¦è€…å‘ã‘)

---

## 1. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•ã¨DIã‚³ãƒ³ãƒ†ãƒŠã®ä»•çµ„ã¿

### Program.cs - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ

```csharp
// ãƒ•ã‚¡ã‚¤ãƒ«: andon/Program.cs
using Microsoft.Extensions.DependencyInjection;  // DIã‚³ãƒ³ãƒ†ãƒŠæ©Ÿèƒ½ã‚’ä½¿ã†ãŸã‚ã®å®£è¨€
using Microsoft.Extensions.Hosting;              // ãƒ›ã‚¹ãƒˆï¼ˆã‚¢ãƒ—ãƒªå®Ÿè¡Œç’°å¢ƒï¼‰ã‚’ä½¿ã†ãŸã‚ã®å®£è¨€
using Andon.Services;                            // è‡ªä½œã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¯ãƒ©ã‚¹ã‚’ä½¿ã†ãŸã‚ã®å®£è¨€

namespace Andon;  // ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ‰€å±ã™ã‚‹åå‰ç©ºé–“ï¼ˆãƒ•ã‚©ãƒ«ãƒ€ã®ã‚ˆã†ãªã‚‚ã®ï¼‰

public class Program  // Programã‚¯ãƒ©ã‚¹ã®å®šç¾©é–‹å§‹
{
    // Main: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒèµ·å‹•ã—ãŸã¨ãæœ€åˆã«å®Ÿè¡Œã•ã‚Œã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
    // static: ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œã‚‰ãªãã¦ã‚‚å‘¼ã³å‡ºã›ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
    // async: éåŒæœŸå‡¦ç†ï¼ˆå¾…æ©ŸãŒå¿…è¦ãªå‡¦ç†ï¼‰ã‚’ä½¿ã†ã“ã¨ã‚’å®£è¨€
    // Task<int>: éåŒæœŸã§æ•´æ•°ã‚’è¿”ã™ã“ã¨ã‚’è¡¨ã™å‹
    public static async Task<int> Main(string[] args)
    {
        try  // ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã‚‹ã‹ã‚‚ã—ã‚Œãªã„å‡¦ç†ã‚’å›²ã‚€
        {
            // ãƒ›ã‚¹ãƒˆï¼ˆã‚¢ãƒ—ãƒªã®å®Ÿè¡Œç’°å¢ƒï¼‰ã‚’ä½œæˆ
            var host = CreateHostBuilder(args).Build();
            // â˜…CreateHostBuilder: DIã‚³ãƒ³ãƒ†ãƒŠã®è¨­å®šã‚’è¡Œã†ãƒ¡ã‚½ãƒƒãƒ‰
            // â˜…Build(): è¨­å®šã‚’å…ƒã«å®Ÿéš›ã®ãƒ›ã‚¹ãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ

            // ãƒ›ã‚¹ãƒˆã‚’éåŒæœŸã§èµ·å‹•ï¼ˆå¾…æ©Ÿï¼‰
            await host.RunAsync();
            // â˜…await: ã“ã®å‡¦ç†ãŒçµ‚ã‚ã‚‹ã¾ã§å¾…ã¤ï¼ˆã§ã‚‚ä»–ã®å‡¦ç†ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ï¼‰
            // â˜…RunAsync(): ãƒ›ã‚¹ãƒˆã‚’èµ·å‹•ã—ã€åœæ­¢ã‚·ã‚°ãƒŠãƒ«ãŒæ¥ã‚‹ã¾ã§å®Ÿè¡Œã‚’ç¶™ç¶š

            return 0;  // æ­£å¸¸çµ‚äº†ï¼ˆçµ‚äº†ã‚³ãƒ¼ãƒ‰0ï¼‰ã‚’è¿”ã™
        }
        catch (Exception ex)  // ã‚¨ãƒ©ãƒ¼ãŒèµ·ããŸå ´åˆã®å‡¦ç†
        {
            // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤º
            Console.WriteLine($"Application failed: {ex.Message}");
            // â˜…$"...": æ–‡å­—åˆ—è£œé–“ï¼ˆå¤‰æ•°ã®å€¤ã‚’åŸ‹ã‚è¾¼ã‚ã‚‹ï¼‰
            // â˜…{ex.Message}: ä¾‹å¤–ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£

            return 1;  // ã‚¨ãƒ©ãƒ¼çµ‚äº†ï¼ˆçµ‚äº†ã‚³ãƒ¼ãƒ‰1ï¼‰ã‚’è¿”ã™
        }
    }

    // CreateHostBuilder: ãƒ›ã‚¹ãƒˆã®è¨­å®šã‚’è¡Œã†ãƒ¡ã‚½ãƒƒãƒ‰
    // IHostBuilder: ãƒ›ã‚¹ãƒˆãƒ“ãƒ«ãƒ€ãƒ¼ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å‹
    public static IHostBuilder CreateHostBuilder(string[] args) =>
        // â˜…=>: ãƒ©ãƒ ãƒ€å¼ï¼ˆçŸ­ã„æ›¸ãæ–¹ï¼‰ã€ãƒ¡ã‚½ãƒƒãƒ‰ã®ä¸­èº«ã‚’1è¡Œã§è¡¨ç¾

        Host.CreateDefaultBuilder(args)  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã®ãƒ›ã‚¹ãƒˆãƒ“ãƒ«ãƒ€ãƒ¼ã‚’ä½œæˆ
        // â˜…CreateDefaultBuilder: ä»¥ä¸‹ã‚’è‡ªå‹•çš„ã«è¨­å®š
        //   - appsettings.jsonã®èª­ã¿è¾¼ã¿
        //   - ç’°å¢ƒå¤‰æ•°ã®èª­ã¿è¾¼ã¿
        //   - ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã®èª­ã¿è¾¼ã¿
        //   - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ­ã‚°è¨­å®š
        //   - DIã‚³ãƒ³ãƒ†ãƒŠã®åŸºæœ¬è¨­å®š

            .ConfigureServices((hostContext, services) =>
            // â˜…ConfigureServices: DIã‚³ãƒ³ãƒ†ãƒŠã«ã‚µãƒ¼ãƒ“ã‚¹ã‚’ç™»éŒ²ã™ã‚‹è¨­å®š
            // â˜…hostContext: ãƒ›ã‚¹ãƒˆã®è¨­å®šæƒ…å ±ï¼ˆappsettings.jsonã®å†…å®¹ãªã©ï¼‰
            // â˜…services: DIã‚³ãƒ³ãƒ†ãƒŠï¼ˆä¾å­˜æ€§æ³¨å…¥ã®ãŸã‚ã®ã‚µãƒ¼ãƒ“ã‚¹ç™»éŒ²å…ˆï¼‰
            {
                // è‡ªä½œã®DIè¨­å®šãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—
                DependencyInjectionConfigurator.Configure(services, hostContext.Configuration);
                // â˜…Configure: å„ã‚¯ãƒ©ã‚¹ã‚’DIã‚³ãƒ³ãƒ†ãƒŠã«ç™»éŒ²
                // â˜…hostContext.Configuration: appsettings.jsonã‹ã‚‰èª­ã¿è¾¼ã‚“ã è¨­å®š

                // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦AndonHostedServiceã‚’ç™»éŒ²
                services.AddHostedService<AndonHostedService>();
                // â˜…AddHostedService: ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«è‡ªå‹•å®Ÿè¡Œã•ã‚Œã‚‹ã‚µãƒ¼ãƒ“ã‚¹
                // â˜…<AndonHostedService>: ã‚¸ã‚§ãƒãƒªãƒƒã‚¯å‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆå‹ã‚’æŒ‡å®šï¼‰
                // ğŸ”§ Hosted Serviceã¯ã€ãƒ›ã‚¹ãƒˆèµ·å‹•æ™‚ã«StartAsync()ãŒè‡ªå‹•å‘¼ã³å‡ºã•ã‚Œã‚‹
            });
}
```

### DependencyInjectionConfigurator.cs - DIã‚³ãƒ³ãƒ†ãƒŠè¨­å®š

```csharp
// ãƒ•ã‚¡ã‚¤ãƒ«: andon/Services/DependencyInjectionConfigurator.cs
using Microsoft.Extensions.DependencyInjection;  // DIã‚³ãƒ³ãƒ†ãƒŠæ©Ÿèƒ½
using Microsoft.Extensions.Logging;              // ãƒ­ã‚°æ©Ÿèƒ½
using Microsoft.Extensions.Configuration;        // è¨­å®šèª­ã¿è¾¼ã¿æ©Ÿèƒ½
using Andon.Core.Interfaces;                     // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å®šç¾©
using Andon.Core.Controllers;                    // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚¯ãƒ©ã‚¹
using Andon.Core.Managers;                       // ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚¯ãƒ©ã‚¹
using Andon.Core.Models.ConfigModels;            // è¨­å®šãƒ¢ãƒ‡ãƒ«
using Andon.Infrastructure.Configuration;        // è¨­å®šãƒ­ãƒ¼ãƒ€ãƒ¼

namespace Andon.Services;

public static class DependencyInjectionConfigurator
// â˜…static class: ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã§ããªã„ã‚¯ãƒ©ã‚¹ï¼ˆãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚¯ãƒ©ã‚¹ï¼‰
{
    // Configure: DIã‚³ãƒ³ãƒ†ãƒŠã«ã‚µãƒ¼ãƒ“ã‚¹ã‚’ç™»éŒ²ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
    // IServiceCollection: ã‚µãƒ¼ãƒ“ã‚¹ã‚’ç™»éŒ²ã™ã‚‹ãŸã‚ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
    // IConfiguration: appsettings.jsonã‹ã‚‰èª­ã¿è¾¼ã‚“ã è¨­å®šæƒ…å ±
    public static void Configure(IServiceCollection services, IConfiguration configuration)
    {
        // ===== ãƒ­ã‚°è¨­å®š =====
        services.AddLogging(builder =>
        // â˜…AddLogging: ãƒ­ã‚°æ©Ÿèƒ½ã‚’è¿½åŠ 
        // â˜…builder: ãƒ­ã‚°ã®è¨­å®šã‚’è¡Œã†ãƒ“ãƒ«ãƒ€ãƒ¼
        {
            builder.AddConsole();  // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ãƒ­ã‚°ã‚’å‡ºåŠ›
            builder.SetMinimumLevel(LogLevel.Information);
            // â˜…SetMinimumLevel: å‡ºåŠ›ã™ã‚‹æœ€ä½ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«
            // â˜…LogLevel.Information: æƒ…å ±ãƒ¬ãƒ™ãƒ«ä»¥ä¸Šã®ãƒ­ã‚°ã‚’å‡ºåŠ›
        });

        // ===== appsettings.jsonã‹ã‚‰è¨­å®šã‚’ãƒã‚¤ãƒ³ãƒ‰ =====
        services.Configure<DataProcessingConfig>(configuration.GetSection("PlcCommunication"));
        // â˜…Configure<T>: appsettings.jsonã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’C#ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ãƒã‚¤ãƒ³ãƒ‰
        // â˜…GetSection("PlcCommunication"): appsettings.jsonã®"PlcCommunication"ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å–å¾—
        // â˜…DataProcessingConfig: ãƒã‚¤ãƒ³ãƒ‰å…ˆã®ã‚¯ãƒ©ã‚¹ï¼ˆMonitoringIntervalMsãªã©ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æŒã¤ï¼‰
        // ğŸ”§ ãƒã‚¤ãƒ³ãƒ‰å¾Œã€IOptions<DataProcessingConfig>ã§DIçµŒç”±ã§å–å¾—ã§ãã‚‹

        services.Configure<SystemResourcesConfig>(configuration.GetSection("SystemResources"));
        // â˜…SystemResourcesConfig: ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹è¨­å®šï¼ˆãƒ¡ãƒ¢ãƒªã€ã‚¹ãƒ¬ãƒƒãƒ‰æ•°ãªã©ï¼‰

        services.Configure<LoggingConfig>(configuration.GetSection("LoggingConfig"));
        // â˜…LoggingConfig: ãƒ­ã‚°è¨­å®šï¼ˆãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã€ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›å…ˆãªã©ï¼‰

        // ===== Singletonç™»éŒ² - ã‚¢ãƒ—ãƒªå…¨ä½“ã§1ã¤ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å…±æœ‰ =====
        services.AddSingleton<IApplicationController, ApplicationController>();
        // â˜…AddSingleton: ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ï¼ˆ1ã¤ã ã‘ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼‰ã¨ã—ã¦ç™»éŒ²
        // â˜…IApplicationController: ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼ˆæŠ½è±¡çš„ãªå‹ï¼‰
        // â˜…ApplicationController: å®Ÿè£…ã‚¯ãƒ©ã‚¹ï¼ˆå®Ÿéš›ã®å‹ï¼‰
        // ğŸ”§ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•æ™‚ã«1åº¦ã ã‘ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆã€ã‚¢ãƒ—ãƒªçµ‚äº†ã¾ã§åŒã˜ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½¿ç”¨
        // ğŸ”§ ApplicationControllerã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã«å¿…è¦ãªä¾å­˜æ€§ï¼ˆMultiPlcConfigManagerãªã©ï¼‰ã¯
        //    DIã‚³ãƒ³ãƒ†ãƒŠãŒè‡ªå‹•çš„ã«è§£æ±ºã—ã¦æ³¨å…¥ã™ã‚‹

        services.AddSingleton<ILoggingManager, LoggingManager>();
        // â˜…ã‚¢ãƒ—ãƒªå…¨ä½“ã§ãƒ­ã‚°ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚’å…±æœ‰
        // ğŸ”§ ãƒ­ã‚°ã¯å…¨ã¦ã®ã‚¯ãƒ©ã‚¹ã‹ã‚‰ä½¿ç”¨ã•ã‚Œã‚‹ãŸã‚ã€SingletonãŒé©åˆ‡

        services.AddSingleton<IErrorHandler, ErrorHandler>();
        // â˜…ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚‚ã‚¢ãƒ—ãƒªå…¨ä½“ã§å…±æœ‰

        services.AddSingleton<ResourceManager>();  // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ãªã—
        // â˜…<ResourceManager>: ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ãŒãªã„å ´åˆã¯å‹ã ã‘æŒ‡å®š
        // ğŸ”§ ãƒªã‚½ãƒ¼ã‚¹ç®¡ç†ï¼ˆãƒ¡ãƒ¢ãƒªã€æ¥ç¶šãƒ—ãƒ¼ãƒ«ãªã©ï¼‰ã¯çŠ¶æ…‹ã‚’æŒã¤ãŸã‚Singleton

        // ===== Phase3å®Ÿè£…ã‚¯ãƒ©ã‚¹ï¼ˆSingletonï¼‰=====
        services.AddSingleton<AsyncExceptionHandler>();
        services.AddSingleton<CancellationCoordinator>();
        services.AddSingleton<ResourceSemaphoreManager>();
        services.AddSingleton<GracefulShutdownHandler>();
        services.AddSingleton<IConfigurationWatcher, ConfigurationWatcher>();
        // ğŸ”§ ã“ã‚Œã‚‰ã¯çŠ¶æ…‹ã‚’æŒã¡ã€ã‚¢ãƒ—ãƒªå…¨ä½“ã§å…±æœ‰ã•ã‚Œã‚‹ã¹ãã‚¯ãƒ©ã‚¹

        // ===== MultiConfigé–¢é€£ - Singletonç™»éŒ² =====
        services.AddSingleton<MultiPlcConfigManager>();
        // â˜…MultiPlcConfigManager: è¤‡æ•°PLCè¨­å®šã‚’ç®¡ç†
        // ğŸ”§ è¨­å®šæƒ…å ±ã¯è¤‡æ•°ã®ã‚¯ãƒ©ã‚¹ã§å…±æœ‰ã™ã‚‹ãŸã‚Singleton

        services.AddSingleton<MultiPlcCoordinator>();
        // â˜…MultiPlcCoordinator: è¤‡æ•°PLCä¸¦åˆ—å®Ÿè¡Œèª¿æ•´

        // ===== ConfigurationLoaderExcelç™»éŒ²ï¼ˆSingletonã€ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰=====
        services.AddSingleton(provider =>
        // â˜…AddSingleton(Func<...>): ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã—ãŸSingletonç™»éŒ²
        // â˜…provider: IServiceProviderï¼ˆDIã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰ã‚µãƒ¼ãƒ“ã‚¹ã‚’å–å¾—ã™ã‚‹ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼‰
        {
            var baseDirectory = AppContext.BaseDirectory;
            // â˜…AppContext.BaseDirectory: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª

            var configManager = provider.GetRequiredService<MultiPlcConfigManager>();
            // â˜…GetRequiredService<T>: DIã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰Tã‚’å–å¾—ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆã¯ä¾‹å¤–ï¼‰
            // ğŸ”§ MultiPlcConfigManagerã¯æ—¢ã«Singletonã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€
            //    ã“ã“ã§å–å¾—ã•ã‚Œã‚‹ã®ã¯åŒã˜ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹

            return new ConfigurationLoaderExcel(baseDirectory, configManager);
            // â˜…ConfigurationLoaderExcelã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã—ã¦è¿”ã™
            // ğŸ”§ ä¾å­˜æ€§ï¼ˆconfigManagerï¼‰ã¯DIã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰è§£æ±ºã•ã‚Œã¦ã„ã‚‹
        });

        // ===== Transientç™»éŒ² - è¦æ±‚ã”ã¨ã«æ–°ã—ã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆ =====
        services.AddTransient<IExecutionOrchestrator>(provider =>
        // â˜…AddTransient(Func<...>): ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã—ãŸTransientç™»éŒ²
        // ğŸ”§ æ¯å›æ–°ã—ã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒç”Ÿæˆã•ã‚Œã‚‹
        {
            // ä¾å­˜æ€§ã‚’æ‰‹å‹•ã§è§£æ±º
            var timerService = provider.GetRequiredService<ITimerService>();
            var dataProcessingConfig = provider.GetRequiredService<IOptions<DataProcessingConfig>>();
            var configToFrameManager = provider.GetRequiredService<IConfigToFrameManager>();
            var dataOutputManager = provider.GetRequiredService<IDataOutputManager>();
            var loggingManager = provider.GetRequiredService<ILoggingManager>();
            // ğŸ”§ å…¨ã¦ã®ä¾å­˜æ€§ã‚’DIã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰å–å¾—ã—ã€æ‰‹å‹•ã§ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã«æ¸¡ã™
            // ğŸ”§ ã“ã®æ–¹æ³•ã¯ã€ç‰¹å®šã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚’ä½¿ç”¨ã—ãŸã„å ´åˆã«æœ‰åŠ¹

            return new ExecutionOrchestrator(
                timerService,
                dataProcessingConfig,
                configToFrameManager,
                dataOutputManager,
                loggingManager);
        });

        services.AddTransient<IConfigToFrameManager, ConfigToFrameManager>();
        // â˜…ConfigToFrameManager: è¨­å®šã‹ã‚‰ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’æ§‹ç¯‰
        // ğŸ”§ çŠ¶æ…‹ã‚’æŒãŸãªã„ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£çš„ãªã‚¯ãƒ©ã‚¹ã¯TransientãŒé©åˆ‡

        services.AddTransient<IDataOutputManager, DataOutputManager>();
        // â˜…DataOutputManager: ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›å‡¦ç†
        // ğŸ”§ I/Oå‡¦ç†ã¯æ¯å›æ–°ã—ã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§å®Ÿè¡Œã™ã‚‹æ–¹ãŒå®‰å…¨

        services.AddTransient<ITimerService, TimerService>();
        // â˜…TimerService: å‘¨æœŸå®Ÿè¡Œã‚¿ã‚¤ãƒãƒ¼
        // ğŸ”§ å®Ÿéš›ã¯Singletonã§ã‚‚è‰¯ã„ãŒã€Transientã«ã™ã‚‹ã“ã¨ã§æŸ”è»Ÿæ€§ã‚’ä¿ã¤

        // ===== Phase3å®Ÿè£…ã‚¯ãƒ©ã‚¹ï¼ˆTransientï¼‰=====
        services.AddTransient<IProgressReporter<ProgressInfo>, ProgressReporter<ProgressInfo>>();
        services.AddTransient<IParallelExecutionController, ParallelExecutionController>();
        // ğŸ”§ ã“ã‚Œã‚‰ã¯å‡¦ç†ã”ã¨ã«ç•°ãªã‚‹çŠ¶æ…‹ã‚’æŒã¤ãŸã‚Transient
    }
}
```

## 2. DIã‚³ãƒ³ãƒ†ãƒŠã®è©³ç´°å‹•ä½œ

### DIã‚³ãƒ³ãƒ†ãƒŠã¨ã¯ä½•ã‹ï¼Ÿ

DIã‚³ãƒ³ãƒ†ãƒŠï¼ˆDependency Injection Containerï¼‰ã¯ã€ã‚¯ãƒ©ã‚¹é–“ã®ä¾å­˜é–¢ä¿‚ã‚’è‡ªå‹•çš„ã«è§£æ±ºã—ã€
å¿…è¦ãªã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆãƒ»æ³¨å…¥ã—ã¦ãã‚Œã‚‹ä»•çµ„ã¿ã§ã™ã€‚

**ä¾å­˜æ€§æ³¨å…¥ï¼ˆDIï¼‰ã®ä¾‹:**

```csharp
// âŒ æ‚ªã„ä¾‹: ä¾å­˜æ€§ã‚’ç›´æ¥ç”Ÿæˆï¼ˆå¯†çµåˆï¼‰
public class ApplicationController
{
    private readonly MultiPlcConfigManager _configManager;

    public ApplicationController()
    {
        _configManager = new MultiPlcConfigManager();  // ç›´æ¥ç”Ÿæˆ
        // â˜…å•é¡Œç‚¹:
        // - ãƒ†ã‚¹ãƒˆãŒå›°é›£ï¼ˆMultiPlcConfigManagerã‚’å·®ã—æ›¿ãˆã§ããªã„ï¼‰
        // - MultiPlcConfigManagerã®ä¾å­˜æ€§ã‚‚å…¨ã¦ç®¡ç†ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
        // - ã‚³ãƒ¼ãƒ‰ã®å¤‰æ›´ãŒå›°é›£ï¼ˆå¯†çµåˆï¼‰
    }
}

// âœ… è‰¯ã„ä¾‹: DIã‚³ãƒ³ãƒ†ãƒŠã«ã‚ˆã‚‹æ³¨å…¥ï¼ˆç–çµåˆï¼‰
public class ApplicationController
{
    private readonly MultiPlcConfigManager _configManager;

    public ApplicationController(MultiPlcConfigManager configManager)
    // ğŸ”§ ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§ä¾å­˜æ€§ã‚’å—ã‘å–ã‚‹ï¼ˆã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
    {
        _configManager = configManager;  // å—ã‘å–ã£ãŸã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¿å­˜
        // â˜…åˆ©ç‚¹:
        // - ãƒ†ã‚¹ãƒˆãŒå®¹æ˜“ï¼ˆãƒ¢ãƒƒã‚¯ã‚’æ³¨å…¥ã§ãã‚‹ï¼‰
        // - DIã‚³ãƒ³ãƒ†ãƒŠãŒä¾å­˜æ€§ã‚’è‡ªå‹•è§£æ±º
        // - ã‚³ãƒ¼ãƒ‰ã®å¤‰æ›´ãŒå®¹æ˜“ï¼ˆç–çµåˆï¼‰
    }
}
```

### ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ©ã‚¤ãƒ•ã‚¿ã‚¤ãƒ ï¼ˆé‡è¦æ¦‚å¿µï¼‰

DIã‚³ãƒ³ãƒ†ãƒŠã«ç™»éŒ²ã•ã‚ŒãŸã‚µãƒ¼ãƒ“ã‚¹ã«ã¯ã€3ç¨®é¡ã®ãƒ©ã‚¤ãƒ•ã‚¿ã‚¤ãƒ ãŒã‚ã‚Šã¾ã™ï¼š

#### 1. Singletonï¼ˆã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ï¼‰

```csharp
services.AddSingleton<IApplicationController, ApplicationController>();
```

**ç‰¹å¾´:**
- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•æ™‚ã«1åº¦ã ã‘ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆ
- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†ã¾ã§åŒã˜ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½¿ç”¨
- å…¨ã¦ã®ã‚¯ãƒ©ã‚¹ã§åŒã˜ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å…±æœ‰

**ä½¿ç”¨ä¾‹:**
- ãƒ­ã‚°ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ï¼ˆå…¨ä½“ã§å…±æœ‰ï¼‰
- è¨­å®šãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ï¼ˆå…¨ä½“ã§å…±æœ‰ï¼‰
- ãƒªã‚½ãƒ¼ã‚¹ç®¡ç†ï¼ˆçŠ¶æ…‹ã‚’æŒã¤ï¼‰

**ãƒ¡ãƒ¢ãƒªã‚¤ãƒ¡ãƒ¼ã‚¸:**
```
ã‚¢ãƒ—ãƒªèµ·å‹• â”€â”¬â”€> ApplicationControllerç”Ÿæˆï¼ˆ1å›ã®ã¿ï¼‰
           â”œâ”€> ã‚¯ãƒ©ã‚¹A â†’ ApplicationControllerï¼ˆåŒã˜ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼‰
           â”œâ”€> ã‚¯ãƒ©ã‚¹B â†’ ApplicationControllerï¼ˆåŒã˜ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼‰
           â””â”€> ã‚¯ãƒ©ã‚¹C â†’ ApplicationControllerï¼ˆåŒã˜ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼‰
```

#### 2. Transientï¼ˆãƒˆãƒ©ãƒ³ã‚¸ã‚¨ãƒ³ãƒˆï¼‰

```csharp
services.AddTransient<IExecutionOrchestrator, ExecutionOrchestrator>();
```

**ç‰¹å¾´:**
- è¦æ±‚ã•ã‚Œã‚‹ãŸã³ã«æ–°ã—ã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆ
- ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯ãã‚Œãã‚Œç‹¬ç«‹ï¼ˆçŠ¶æ…‹ã‚’å…±æœ‰ã—ãªã„ï¼‰
- ä½¿ç”¨å¾Œã¯è‡ªå‹•çš„ã«ã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§ç ´æ£„

**ä½¿ç”¨ä¾‹:**
- çŠ¶æ…‹ã‚’æŒãŸãªã„ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚¯ãƒ©ã‚¹
- I/Oå‡¦ç†ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ï¼‰
- å‡¦ç†ã”ã¨ã«ç•°ãªã‚‹çŠ¶æ…‹ã‚’æŒã¤ã‚¯ãƒ©ã‚¹

**ãƒ¡ãƒ¢ãƒªã‚¤ãƒ¡ãƒ¼ã‚¸:**
```
ã‚¯ãƒ©ã‚¹Aè¦æ±‚ â”€> ExecutionOrchestratorç”Ÿæˆï¼ˆæ–°è¦ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹1ï¼‰
ã‚¯ãƒ©ã‚¹Bè¦æ±‚ â”€> ExecutionOrchestratorç”Ÿæˆï¼ˆæ–°è¦ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹2ï¼‰
ã‚¯ãƒ©ã‚¹Cè¦æ±‚ â”€> ExecutionOrchestratorç”Ÿæˆï¼ˆæ–°è¦ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹3ï¼‰
```

#### 3. Scopedï¼ˆã‚¹ã‚³ãƒ¼ãƒ—ãƒ‰ï¼‰

```csharp
services.AddScoped<IOrderService, OrderService>();
```

**ç‰¹å¾´:**
- HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã”ã¨ã«1ã¤ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆ
- åŒã˜ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…ã§ã¯åŒã˜ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½¿ç”¨
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆçµ‚äº†æ™‚ã«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç ´æ£„

âš ï¸ **æœ¬ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ä½¿ç”¨ã—ã¦ã„ã¾ã›ã‚“**ï¼ˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¢ãƒ—ãƒªã®ãŸã‚ï¼‰

### ä¾å­˜æ€§ã®è§£æ±ºãƒ—ãƒ­ã‚»ã‚¹

DIã‚³ãƒ³ãƒ†ãƒŠãŒã©ã®ã‚ˆã†ã«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆã™ã‚‹ã‹ã€å…·ä½“ä¾‹ã§è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ï¼š

```csharp
// ===== DIã‚³ãƒ³ãƒ†ãƒŠã¸ã®ç™»éŒ² =====
services.AddSingleton<MultiPlcConfigManager>();
services.AddSingleton<IExecutionOrchestrator, ExecutionOrchestrator>();
services.AddSingleton<ILoggingManager, LoggingManager>();
services.AddSingleton<IApplicationController, ApplicationController>();

// ===== ApplicationControllerã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ =====
public class ApplicationController : IApplicationController
{
    public ApplicationController(
        MultiPlcConfigManager configManager,      // ä¾å­˜æ€§1
        IExecutionOrchestrator orchestrator,      // ä¾å­˜æ€§2
        ILoggingManager loggingManager)           // ä¾å­˜æ€§3
    {
        // ...
    }
}

// ===== DIã‚³ãƒ³ãƒ†ãƒŠã«ã‚ˆã‚‹è§£æ±ºãƒ—ãƒ­ã‚»ã‚¹ =====
// 1. IApplicationControllerãŒè¦æ±‚ã•ã‚Œã‚‹
// 2. DIã‚³ãƒ³ãƒ†ãƒŠã¯ã€ApplicationControllerã‚’ç”Ÿæˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã¨åˆ¤æ–­
// 3. ApplicationControllerã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚’ç¢ºèª
//    - MultiPlcConfigManager ãŒå¿…è¦ â†’ DIã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰å–å¾—ï¼ˆSingletonï¼‰
//    - IExecutionOrchestrator ãŒå¿…è¦ â†’ ExecutionOrchestratorã‚’ç”Ÿæˆ
//      â†’ ã•ã‚‰ã«ExecutionOrchestratorã®ä¾å­˜æ€§ã‚’è§£æ±º...ï¼ˆå†å¸°çš„ï¼‰
//    - ILoggingManager ãŒå¿…è¦ â†’ LoggingManagerã‚’ç”Ÿæˆ
// 4. å…¨ã¦ã®ä¾å­˜æ€§ãŒè§£æ±ºã•ã‚ŒãŸã®ã§ã€ApplicationControllerã‚’ç”Ÿæˆ
// 5. ç”Ÿæˆã—ãŸApplicationControllerã‚’è¿”ã™
```

**ä¾å­˜æ€§è§£æ±ºã®å›³:**

```
è¦æ±‚: IApplicationController
  â†“
DIã‚³ãƒ³ãƒ†ãƒŠãŒè§£æ±º
  â”œâ”€> MultiPlcConfigManagerï¼ˆSingletonã€æ—¢å­˜ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼‰
  â”œâ”€> IExecutionOrchestrator
  â”‚     â†“
  â”‚   ExecutionOrchestratorã‚’ç”Ÿæˆ
  â”‚     â”œâ”€> ITimerService
  â”‚     â”‚     â†“
  â”‚     â”‚   TimerServiceã‚’ç”Ÿæˆ
  â”‚     â”‚     â””â”€> ILoggingManagerï¼ˆSingletonã€æ—¢å­˜ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼‰
  â”‚     â”œâ”€> IOptions<DataProcessingConfig>ï¼ˆè¨­å®šã‹ã‚‰è‡ªå‹•ç”Ÿæˆï¼‰
  â”‚     â”œâ”€> IConfigToFrameManagerï¼ˆæ–°è¦ç”Ÿæˆï¼‰
  â”‚     â”œâ”€> IDataOutputManagerï¼ˆæ–°è¦ç”Ÿæˆï¼‰
  â”‚     â””â”€> ILoggingManagerï¼ˆSingletonã€æ—¢å­˜ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼‰
  â””â”€> ILoggingManagerï¼ˆSingletonã€æ—¢å­˜ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼‰
  â†“
ApplicationControllerã‚’ç”Ÿæˆã—ã¦è¿”ã™
```

### AndonHostedServiceã®å‹•ä½œãƒ•ãƒ­ãƒ¼

```csharp
// ãƒ•ã‚¡ã‚¤ãƒ«: andon/Services/AndonHostedService.cs

public class AndonHostedService : BackgroundService
// â˜…BackgroundService: .NET Coreã®ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å®Ÿè¡ŒåŸºåº•ã‚¯ãƒ©ã‚¹
{
    private readonly IApplicationController _controller;
    private readonly ILoggingManager _loggingManager;

    public AndonHostedService(
        IApplicationController controller,
        ILoggingManager loggingManager)
    // ğŸ”§ DIã‚³ãƒ³ãƒ†ãƒŠãŒè‡ªå‹•çš„ã«IApplicationControllerã¨ILoggingManagerã‚’æ³¨å…¥
    {
        _controller = controller;
        _loggingManager = loggingManager;
    }

    // StartAsync: ãƒ›ã‚¹ãƒˆèµ·å‹•æ™‚ã«è‡ªå‹•å‘¼ã³å‡ºã•ã‚Œã‚‹
    public override async Task StartAsync(CancellationToken cancellationToken)
    {
        await _loggingManager.LogInfo("AndonHostedService starting");
        await base.StartAsync(cancellationToken);
        // â˜…base.StartAsync(): åŸºåº•ã‚¯ãƒ©ã‚¹ã®åˆæœŸåŒ–å‡¦ç†
        // â˜…ã“ã®å¾Œã€è‡ªå‹•çš„ã«ExecuteAsync()ãŒå‘¼ã°ã‚Œã‚‹
    }

    // ExecuteAsync: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ã®ãƒ¡ã‚¤ãƒ³ãƒ¡ã‚½ãƒƒãƒ‰
    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    // â˜…stoppingToken: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åœæ­¢æ™‚ã«ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚·ã‚°ãƒŠãƒ«ãŒæ¥ã‚‹
    {
        try
        {
            await _controller.StartAsync(stoppingToken);
            // â˜…ApplicationController.StartAsync()ã‚’å‘¼ã³å‡ºã—
            // â˜…ã“ã®ä¸­ã§ã€Step1åˆæœŸåŒ–ã¨ç¶™ç¶šå®Ÿè¡ŒãŒé–‹å§‹ã•ã‚Œã‚‹
        }
        catch (OperationCanceledException)
        {
            // æ­£å¸¸ãªã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¯ç„¡è¦–
        }
        catch (Exception ex)
        {
            await _loggingManager.LogError(ex, "ExecuteAsync failed");
            throw;  // ä¾‹å¤–ã‚’å†ã‚¹ãƒ­ãƒ¼ï¼ˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†ï¼‰
        }
    }

    // StopAsync: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åœæ­¢æ™‚ã«è‡ªå‹•å‘¼ã³å‡ºã•ã‚Œã‚‹
    public override async Task StopAsync(CancellationToken cancellationToken)
    {
        await _loggingManager.LogInfo("AndonHostedService stopping");
        await _controller.StopAsync(cancellationToken);
        // â˜…ApplicationController.StopAsync()ã‚’å‘¼ã³å‡ºã—
        // â˜…ãƒªã‚½ãƒ¼ã‚¹ã®è§£æ”¾ã€æ¥ç¶šã®åˆ‡æ–­ãªã©ã‚’å®Ÿè¡Œ

        await base.StopAsync(cancellationToken);
    }
}
```

**AndonHostedServiceã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«:**

```
1. host.RunAsync()å‘¼ã³å‡ºã—
   â†“
2. AndonHostedService.StartAsync()è‡ªå‹•å‘¼ã³å‡ºã—
   â†“
3. AndonHostedService.ExecuteAsync()è‡ªå‹•å‘¼ã³å‡ºã—
   â”œâ”€> ApplicationController.StartAsync()
   â”‚     â”œâ”€> Step1åˆæœŸåŒ–
   â”‚     â””â”€> ç¶™ç¶šå®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰é–‹å§‹ï¼ˆç„¡é™ãƒ«ãƒ¼ãƒ—ï¼‰
   â”‚           â””â”€> Step2-7ã‚’å‘¨æœŸå®Ÿè¡Œ
   â†“
4. Ctrl+Cãªã©ã§åœæ­¢ã‚·ã‚°ãƒŠãƒ«
   â†“
5. AndonHostedService.StopAsync()è‡ªå‹•å‘¼ã³å‡ºã—
   â”œâ”€> ApplicationController.StopAsync()
   â”‚     â””â”€> ãƒªã‚½ãƒ¼ã‚¹è§£æ”¾
   â†“
6. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†
```

---

## 3. Step1: åˆæœŸåŒ–ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆ1å›ã®ã¿å®Ÿè¡Œï¼‰

### ApplicationController.cs - Step1å®Ÿè£…

```csharp
// ãƒ•ã‚¡ã‚¤ãƒ«: andon/Core/Controllers/ApplicationController.cs
// ExecuteStep1InitializationAsync: Step1åˆæœŸåŒ–ãƒ¡ã‚½ãƒƒãƒ‰
public async Task<InitializationResult> ExecuteStep1InitializationAsync(
    string configDirectory = "./config/",  // è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ‘ã‚¹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼‰
    CancellationToken cancellationToken = default)  // ã‚­ãƒ£ãƒ³ã‚»ãƒ«é€šçŸ¥ç”¨ãƒˆãƒ¼ã‚¯ãƒ³
    // â˜…async Task<InitializationResult>: éåŒæœŸã§InitializationResultã‚’è¿”ã™
    // â˜…CancellationToken: å‡¦ç†ã‚’é€”ä¸­ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹ãŸã‚ã®ä»•çµ„ã¿
    // â˜…= default: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆçœç•¥å¯èƒ½ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼‰
{
    try  // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°é–‹å§‹
    {
        // ----- ãƒ­ã‚°å‡ºåŠ›: é–‹å§‹ -----
        await _loggingManager.LogInfo("Starting Step1 initialization");
        // â˜…await: LogInfoãƒ¡ã‚½ãƒƒãƒ‰ã®å®Œäº†ã‚’å¾…ã¤
        // â˜…_loggingManager: ã‚¯ãƒ©ã‚¹ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆãƒ¡ãƒ³ãƒå¤‰æ•°ï¼‰
        // â˜…LogInfo: æƒ…å ±ãƒ¬ãƒ™ãƒ«ã®ãƒ­ã‚°ã‚’å‡ºåŠ›ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰

        // ----- è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰è¤‡æ•°PLCè¨­å®šã‚’èª­ã¿è¾¼ã¿ -----
        var configs = _configManager.GetAllConfigurations();
        // â˜…var: å‹æ¨è«–ï¼ˆã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãŒè‡ªå‹•ã§å‹ã‚’åˆ¤æ–­ï¼‰
        // â˜…configs: èª­ã¿è¾¼ã‚“ã è¨­å®šã®ãƒªã‚¹ãƒˆï¼ˆList<PlcConfiguration>å‹ï¼‰
        // â˜…GetAllConfigurations(): Excelãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰è¨­å®šã‚’èª­ã¿è¾¼ã‚€ãƒ¡ã‚½ãƒƒãƒ‰

        _plcConfigs = configs.ToList();  // Listã«å¤‰æ›ã—ã¦ä¿å­˜
        // â˜…_plcConfigs: ã‚¯ãƒ©ã‚¹ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆç¶™ç¶šå®Ÿè¡Œã§å†åˆ©ç”¨ï¼‰
        // â˜…ToList(): IEnumerableã‚’Listã«å¤‰æ›

        _plcManagers = new List<IPlcCommunicationManager>();
        // â˜…new List<...>(): æ–°ã—ã„ãƒªã‚¹ãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
        // â˜…IPlcCommunicationManager: é€šä¿¡ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹

        // ----- è¨­å®šã”ã¨ã«PlcCommunicationManagerã‚’ä½œæˆ -----
        foreach (var config in configs)  // å„è¨­å®šã«å¯¾ã—ã¦ãƒ«ãƒ¼ãƒ—
        // â˜…foreach: ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®å„è¦ç´ ã«å¯¾ã—ã¦ç¹°ã‚Šè¿”ã—å‡¦ç†
        // â˜…var config: ç¾åœ¨å‡¦ç†ä¸­ã®è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        {
            // === ConnectionConfigä½œæˆ ===
            var connectionConfig = new ConnectionConfig
            // â˜…new: æ–°ã—ã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
            // â˜…ConnectionConfig: æ¥ç¶šè¨­å®šã‚’ä¿æŒã™ã‚‹ã‚¯ãƒ©ã‚¹
            {
                // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆåˆæœŸåŒ–å­ï¼ˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä¸€æ‹¬è¨­å®šï¼‰
                IpAddress = config.IpAddress,
                // â˜…IpAddress: IPã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆä¾‹: "192.168.1.100"ï¼‰

                Port = config.Port,
                // â˜…Port: ãƒãƒ¼ãƒˆç•ªå·ï¼ˆä¾‹: 5000ï¼‰

                UseTcp = config.ConnectionMethod == "TCP"
                // â˜…UseTcp: TCPæ¥ç¶šã‹ã©ã†ã‹ï¼ˆtrue/falseï¼‰
                // â˜…==: ç­‰ä¾¡æ¯”è¼ƒæ¼”ç®—å­ï¼ˆåŒã˜ã‹ã©ã†ã‹åˆ¤å®šï¼‰
                // â˜…"TCP"ã¨ä¸€è‡´ã™ã‚Œã°trueã€ãã‚Œä»¥å¤–ï¼ˆ"UDP"ï¼‰ã¯false
            };

            // === TimeoutConfigä½œæˆ ===
            var timeoutConfig = new TimeoutConfig
            {
                ConnectTimeoutMs = config.Timeout,
                // â˜…ConnectTimeoutMs: æ¥ç¶šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆãƒŸãƒªç§’ï¼‰

                SendTimeoutMs = config.Timeout,
                // â˜…SendTimeoutMs: é€ä¿¡ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆãƒŸãƒªç§’ï¼‰

                ReceiveTimeoutMs = config.Timeout
                // â˜…ReceiveTimeoutMs: å—ä¿¡ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆãƒŸãƒªç§’ï¼‰
            };

            // === PlcCommunicationManagerä½œæˆ ===
            var manager = new PlcCommunicationManager(
                connectionConfig,  // ç¬¬1å¼•æ•°: æ¥ç¶šè¨­å®š
                timeoutConfig);    // ç¬¬2å¼•æ•°: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
            // â˜…PlcCommunicationManager: PLCé€šä¿¡ã‚’ç®¡ç†ã™ã‚‹ã‚¯ãƒ©ã‚¹
            // â˜…ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿: ã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
            // â˜…çœç•¥ã•ã‚ŒãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆsocketFactoryï¼‰ã¯nullï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰

            // === ãƒªã‚¹ãƒˆã«è¿½åŠ  ===
            _plcManagers.Add(manager);
            // â˜…Add: ãƒªã‚¹ãƒˆã®æœ«å°¾ã«è¦ç´ ã‚’è¿½åŠ 
            // â˜…_plcManagers: ä½œæˆã—ãŸãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚’ä¿å­˜ã™ã‚‹ãƒªã‚¹ãƒˆ
        }  // foreachçµ‚äº†

        // ----- ãƒ­ã‚°å‡ºåŠ›: å®Œäº† -----
        await _loggingManager.LogInfo("Step1 initialization completed");

        // ----- æˆåŠŸçµæœã‚’è¿”ã™ -----
        return new InitializationResult
        // â˜…return: ãƒ¡ã‚½ãƒƒãƒ‰ã®æˆ»ã‚Šå€¤ã‚’è¿”ã™
        {
            Success = true,           // æˆåŠŸãƒ•ãƒ©ã‚°
            PlcCount = configs.Count  // èª­ã¿è¾¼ã‚“ã PLCæ•°
            // â˜…Count: ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®è¦ç´ æ•°ã‚’å–å¾—ã™ã‚‹ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£
        };
    }
    catch (Exception ex)  // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆ
    // â˜…Exception: ã™ã¹ã¦ã®ä¾‹å¤–ã®åŸºåº•ã‚¯ãƒ©ã‚¹
    // â˜…ex: ä¾‹å¤–ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆã‚¨ãƒ©ãƒ¼ã®è©³ç´°æƒ…å ±ã‚’æŒã¤ï¼‰
    {
        // ----- ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°å‡ºåŠ› -----
        await _loggingManager.LogError(ex, "Step1 initialization failed");
        // â˜…LogError: ã‚¨ãƒ©ãƒ¼ãƒ¬ãƒ™ãƒ«ã®ãƒ­ã‚°å‡ºåŠ›
        // â˜…ex: ä¾‹å¤–ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¸¡ã™

        // ----- å¤±æ•—çµæœã‚’è¿”ã™ -----
        return new InitializationResult
        {
            Success = false,              // å¤±æ•—ãƒ•ãƒ©ã‚°
            ErrorMessage = ex.Message     // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            // â˜…ex.Message: ä¾‹å¤–ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£
        };
    }
}
```

---

## 3. Step2: ãƒ•ãƒ¬ãƒ¼ãƒ æ§‹ç¯‰

### SlmpFrameBuilder.cs - ReadRandomãƒ•ãƒ¬ãƒ¼ãƒ æ§‹ç¯‰

```csharp
// ãƒ•ã‚¡ã‚¤ãƒ«: andon/Utilities/SlmpFrameBuilder.cs
// BuildReadRandomRequest: ReadRandomã‚³ãƒãƒ³ãƒ‰ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’æ§‹ç¯‰
public static byte[] BuildReadRandomRequest(
    List<DeviceSpecification>? devices,  // ãƒ‡ãƒã‚¤ã‚¹ãƒªã‚¹ãƒˆï¼ˆnullã‹ã‚‚ã—ã‚Œãªã„ï¼‰
    // â˜…?: nullè¨±å®¹å‹ï¼ˆnullã‚’è¨±å®¹ã™ã‚‹å‚ç…§å‹ï¼‰
    // â˜…DeviceSpecification: ãƒ‡ãƒã‚¤ã‚¹æŒ‡å®šæƒ…å ±ã‚’æŒã¤ã‚¯ãƒ©ã‚¹

    string frameType = "3E",             // ãƒ•ãƒ¬ãƒ¼ãƒ ã‚¿ã‚¤ãƒ—ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ"3E"ï¼‰
    ushort timeout = 32)                 // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå€¤ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ32ï¼‰
    // â˜…ushort: ç¬¦å·ãªã—16ãƒ“ãƒƒãƒˆæ•´æ•°ï¼ˆ0ï½65535ï¼‰
{
    // ----- 1. å…¥åŠ›æ¤œè¨¼ -----
    ValidateInputs(devices, frameType);
    // â˜…ValidateInputs: å…¥åŠ›å€¤ãŒæ­£ã—ã„ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
    // â˜…ä¸æ­£ãªå€¤ã®å ´åˆã¯ä¾‹å¤–ã‚’ã‚¹ãƒ­ãƒ¼

    // ----- 2. ãƒ•ãƒ¬ãƒ¼ãƒ æ§‹ç¯‰é–‹å§‹ -----
    var frame = new List<byte>();
    // â˜…List<byte>: ãƒã‚¤ãƒˆé…åˆ—ã®ãƒªã‚¹ãƒˆï¼ˆå¯å¤‰é•·ï¼‰
    // â˜…byte: 8ãƒ“ãƒƒãƒˆæ•´æ•°ï¼ˆ0ï½255ï¼‰ã€SLMPãƒ•ãƒ¬ãƒ¼ãƒ ã¯1ãƒã‚¤ãƒˆå˜ä½

    // ----- 3. ã‚µãƒ–ãƒ˜ãƒƒãƒ€æ§‹ç¯‰ -----
    ushort sequenceNumber = _sequenceManager.GetNext(frameType);
    // â˜…sequenceNumber: ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå·ï¼ˆ4Eãƒ•ãƒ¬ãƒ¼ãƒ ã§ä½¿ç”¨ï¼‰
    // â˜…_sequenceManager: ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå·ã‚’ç®¡ç†ã™ã‚‹ã‚¯ãƒ©ã‚¹

    frame.AddRange(BuildSubHeader(frameType, sequenceNumber));
    // â˜…AddRange: è¤‡æ•°ã®è¦ç´ ã‚’ä¸€åº¦ã«è¿½åŠ 
    // â˜…BuildSubHeader: ã‚µãƒ–ãƒ˜ãƒƒãƒ€ãƒã‚¤ãƒˆåˆ—ã‚’ä½œæˆ
    // â˜…3Eãƒ•ãƒ¬ãƒ¼ãƒ : [0x50, 0x00]
    // â˜…4Eãƒ•ãƒ¬ãƒ¼ãƒ : [0x54, 0x00, seq_low, seq_high, 0x00, 0x00]

    // ----- 4. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®šæ§‹ç¯‰ -----
    frame.AddRange(BuildNetworkConfig());
    // â˜…BuildNetworkConfig: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®šãƒã‚¤ãƒˆåˆ—ã‚’ä½œæˆ
    // â˜…[0x00, 0xFF, 0xFF, 0x03, 0x00]
    //   ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç•ªå·, PCç•ªå·, I/Oç•ªå·(LE), å±€ç•ª

    // ----- 5. ãƒ‡ãƒ¼ã‚¿é•·ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ -----
    int dataLengthPosition = frame.Count;
    // â˜…dataLengthPosition: ãƒ‡ãƒ¼ã‚¿é•·ã‚’æ›¸ãè¾¼ã‚€ä½ç½®ã‚’è¨˜éŒ²
    // â˜…frame.Count: ç¾åœ¨ã®ãƒ•ãƒ¬ãƒ¼ãƒ é•·ï¼ˆè¦ç´ æ•°ï¼‰

    frame.AddRange(new byte[] { 0x00, 0x00 });
    // â˜…new byte[]: æ–°ã—ã„ãƒã‚¤ãƒˆé…åˆ—ã‚’ä½œæˆ
    // â˜…{ 0x00, 0x00 }: é…åˆ—åˆæœŸåŒ–å­ï¼ˆåˆæœŸå€¤ã‚’æŒ‡å®šï¼‰
    // â˜…å¾Œã§ã“ã“ã«ãƒ‡ãƒ¼ã‚¿é•·ã‚’æ›¸ãè¾¼ã‚€

    // ----- 6. ã‚³ãƒãƒ³ãƒ‰éƒ¨æ§‹ç¯‰ -----
    frame.AddRange(BuildCommandSection(
        timeout,                    // ç›£è¦–ã‚¿ã‚¤ãƒ
        0x0403,                    // ReadRandomã‚³ãƒãƒ³ãƒ‰
        // â˜…0x0403: 16é€²æ•°ãƒªãƒ†ãƒ©ãƒ«ï¼ˆ10é€²æ•°ã§1027ï¼‰

        0x0000,                    // ã‚µãƒ–ã‚³ãƒãƒ³ãƒ‰ï¼ˆå›ºå®šï¼‰
        (byte)devices!.Count,      // ãƒ¯ãƒ¼ãƒ‰ç‚¹æ•°
        // â˜…(byte): ã‚­ãƒ£ã‚¹ãƒˆï¼ˆå‹å¤‰æ›ï¼‰
        // â˜…devices!: nulléè¨±å®¹æ¼”ç®—å­ï¼ˆnullã§ãªã„ã“ã¨ã‚’ä¿è¨¼ï¼‰
        // â˜….Count: ãƒ‡ãƒã‚¤ã‚¹ã®å€‹æ•°

        0x00));                    // Dwordç‚¹æ•°=0å›ºå®š

    // ----- 7. ãƒ‡ãƒã‚¤ã‚¹æŒ‡å®šéƒ¨æ§‹ç¯‰ -----
    frame.AddRange(BuildDeviceSpecificationSection(devices));
    // â˜…foreach device in devices
    //   device.ToDeviceSpecificationBytes() ã‚’å‘¼ã³å‡ºã—
    //   [ãƒ‡ãƒã‚¤ã‚¹ç•ªå·3ãƒã‚¤ãƒˆ(LE), ãƒ‡ãƒã‚¤ã‚¹ã‚³ãƒ¼ãƒ‰1ãƒã‚¤ãƒˆ] ã‚’è¿½åŠ 

    // ----- 8. ãƒ‡ãƒ¼ã‚¿é•·æ›´æ–° -----
    UpdateDataLength(frame, dataLengthPosition, frameType);
    // â˜…dataLength = frame.Count - dataLengthPosition - 2
    // â˜…frame[dataLengthPosition] = dataLength ã®ä¸‹ä½ãƒã‚¤ãƒˆ
    // â˜…frame[dataLengthPosition + 1] = dataLength ã®ä¸Šä½ãƒã‚¤ãƒˆ

    // ----- 9. ãƒ•ãƒ¬ãƒ¼ãƒ æ¤œè¨¼ -----
    ValidateFrame(frame.ToArray());
    // â˜…ToArray(): Listã‚’Arrayï¼ˆé…åˆ—ï¼‰ã«å¤‰æ›
    // â˜…ValidateFrame: ãƒ•ãƒ¬ãƒ¼ãƒ ãŒæ­£ã—ã„å½¢å¼ã‹æ¤œè¨¼

    // ----- 10. è¿”å´ -----
    return frame.ToArray();
    // â˜…byte[]: ãƒã‚¤ãƒˆé…åˆ—ã¨ã—ã¦è¿”ã™
}
```

### DeviceSpecification.cs - ãƒ‡ãƒã‚¤ã‚¹æŒ‡å®šãƒã‚¤ãƒˆåˆ—ä½œæˆ

```csharp
// ãƒ•ã‚¡ã‚¤ãƒ«: andon/Core/Models/DeviceSpecification.cs
// ToDeviceSpecificationBytes: ãƒ‡ãƒã‚¤ã‚¹æŒ‡å®šã‚’4ãƒã‚¤ãƒˆé…åˆ—ã«å¤‰æ›
public byte[] ToDeviceSpecificationBytes()
{
    // ----- çµæœæ ¼ç´ç”¨ã®é…åˆ—ã‚’ä½œæˆ -----
    var result = new byte[4];
    // â˜…byte[4]: 4è¦ç´ ã®ãƒã‚¤ãƒˆé…åˆ—
    // â˜…SLMPä»•æ§˜: [ãƒ‡ãƒã‚¤ã‚¹ç•ªå·3ãƒã‚¤ãƒˆ(LE), ãƒ‡ãƒã‚¤ã‚¹ã‚³ãƒ¼ãƒ‰1ãƒã‚¤ãƒˆ]

    // ----- ãƒ‡ãƒã‚¤ã‚¹ç•ªå·ã‚’3ãƒã‚¤ãƒˆã«å¤‰æ› -----
    var deviceNumberBytes = ToDeviceNumberBytes();
    // â˜…ToDeviceNumberBytes(): ãƒ‡ãƒã‚¤ã‚¹ç•ªå·ã‚’3ãƒã‚¤ãƒˆã«å¤‰æ›ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
    // â˜…ãƒªãƒˆãƒ«ã‚¨ãƒ³ãƒ‡ã‚£ã‚¢ãƒ³å½¢å¼ï¼ˆä¸‹ä½ãƒã‚¤ãƒˆã‹ã‚‰é †ã«ï¼‰

    // ----- ãƒ‡ãƒã‚¤ã‚¹ç•ªå·ï¼ˆ3ãƒã‚¤ãƒˆï¼‰ã‚’ã‚³ãƒ”ãƒ¼ -----
    Array.Copy(deviceNumberBytes, 0, result, 0, 3);
    // â˜…Array.Copy: é…åˆ—ã®ã‚³ãƒ”ãƒ¼
    // â˜…ç¬¬1å¼•æ•°: ã‚³ãƒ”ãƒ¼å…ƒé…åˆ—
    // â˜…ç¬¬2å¼•æ•°: ã‚³ãƒ”ãƒ¼å…ƒã®é–‹å§‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆ0ã‹ã‚‰ï¼‰
    // â˜…ç¬¬3å¼•æ•°: ã‚³ãƒ”ãƒ¼å…ˆé…åˆ—
    // â˜…ç¬¬4å¼•æ•°: ã‚³ãƒ”ãƒ¼å…ˆã®é–‹å§‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆ0ã‹ã‚‰ï¼‰
    // â˜…ç¬¬5å¼•æ•°: ã‚³ãƒ”ãƒ¼ã™ã‚‹ãƒã‚¤ãƒˆæ•°ï¼ˆ3ãƒã‚¤ãƒˆï¼‰

    // ----- ãƒ‡ãƒã‚¤ã‚¹ã‚³ãƒ¼ãƒ‰ï¼ˆ1ãƒã‚¤ãƒˆï¼‰ã‚’è¨­å®š -----
    result[3] = (byte)Code;
    // â˜…result[3]: é…åˆ—ã®4ç•ªç›®ã®è¦ç´ ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯0ã‹ã‚‰å§‹ã¾ã‚‹ï¼‰
    // â˜…(byte)Code: DeviceCodeåˆ—æŒ™å‹ã‚’byteã«ã‚­ãƒ£ã‚¹ãƒˆ
    // â˜…ä¾‹: DeviceCode.D (0xA8) â†’ 0xA8

    // ----- å®Œæˆã—ãŸãƒã‚¤ãƒˆé…åˆ—ã‚’è¿”ã™ -----
    return result;
    // â˜…ä¾‹: D100ã®å ´åˆ
    //   [0x64, 0x00, 0x00, 0xA8]
    //    ^^^^^^^^^^^^^^^^^^^^  ^^^^
    //    ãƒ‡ãƒã‚¤ã‚¹ç•ªå·(LE)      ã‚³ãƒ¼ãƒ‰
}

// ToDeviceNumberBytes: ãƒ‡ãƒã‚¤ã‚¹ç•ªå·ã‚’3ãƒã‚¤ãƒˆé…åˆ—ã«å¤‰æ›ï¼ˆLEï¼‰
public byte[] ToDeviceNumberBytes()
{
    return new byte[]
    {
        (byte)(DeviceNumber & 0xFF),           // ä¸‹ä½ãƒã‚¤ãƒˆ
        // â˜…DeviceNumber: ãƒ‡ãƒã‚¤ã‚¹ç•ªå·ï¼ˆintå‹ã€ä¾‹: 100ï¼‰
        // â˜…& 0xFF: ãƒ“ãƒƒãƒˆANDæ¼”ç®—ï¼ˆä¸‹ä½8ãƒ“ãƒƒãƒˆã ã‘ã‚’å–ã‚Šå‡ºã™ï¼‰
        // â˜…(byte): çµæœã‚’byteã«ã‚­ãƒ£ã‚¹ãƒˆ

        (byte)((DeviceNumber >> 8) & 0xFF),    // ä¸­ä½ãƒã‚¤ãƒˆ
        // â˜…>> 8: å³ã‚·ãƒ•ãƒˆæ¼”ç®—ï¼ˆ8ãƒ“ãƒƒãƒˆå³ã«ã‚·ãƒ•ãƒˆï¼‰
        // â˜…ä¾‹: 0x1234 >> 8 = 0x0012
        // â˜…& 0xFF: ä¸‹ä½8ãƒ“ãƒƒãƒˆã ã‘ã‚’å–ã‚Šå‡ºã™

        (byte)((DeviceNumber >> 16) & 0xFF)    // ä¸Šä½ãƒã‚¤ãƒˆ
        // â˜…>> 16: 16ãƒ“ãƒƒãƒˆå³ã«ã‚·ãƒ•ãƒˆ
    };
    // â˜…ä¾‹: DeviceNumber = 100 (0x000064)
    //   ä¸‹ä½: 0x64, ä¸­ä½: 0x00, ä¸Šä½: 0x00
    //   â†’ [0x64, 0x00, 0x00]
}
```

---

## 4. Step3: PLCæ¥ç¶š

### PlcCommunicationManager.cs - ConnectAsyncå®Ÿè£…

```csharp
// ãƒ•ã‚¡ã‚¤ãƒ«: andon/Core/Managers/PlcCommunicationManager.cs
// ConnectAsync: PLCã«æ¥ç¶šã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
public async Task<ConnectionResponse> ConnectAsync()
{
    // ----- æ¥ç¶šé–‹å§‹æ™‚åˆ»ã‚’è¨˜éŒ² -----
    var startTime = DateTime.UtcNow;
    // â˜…DateTime.UtcNow: ç¾åœ¨ã®UTCæ™‚åˆ»ã‚’å–å¾—
    // â˜…UTC: å”å®šä¸–ç•Œæ™‚ï¼ˆã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³éä¾å­˜ï¼‰

    try
    {
        // ----- 1. IPæ¤œè¨¼ -----
        if (!System.Net.IPAddress.TryParse(_connectionConfig.IpAddress, out _))
        // â˜…TryParse: æ–‡å­—åˆ—ãŒIPã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ã—ã¦æœ‰åŠ¹ã‹æ¤œè¨¼
        // â˜…out _: å‡ºåŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆçµæœã¯ä½¿ã‚ãªã„ã®ã§_ã§ç ´æ£„ï¼‰
        // â˜…!: è«–ç†å¦å®šæ¼”ç®—å­ï¼ˆfalseã®å ´åˆã«trueï¼‰
        {
            // === IPä¸æ­£ã®å ´åˆ ===
            _stats.AddConnection(false);
            // â˜…_stats: çµ±è¨ˆæƒ…å ±ã‚’ç®¡ç†ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
            // â˜…AddConnection(false): å¤±æ•—ã—ãŸæ¥ç¶šã‚’è¨˜éŒ²

            _stats.AddConnectionError(ErrorConstants.ValidationError);
            // â˜…AddConnectionError: ã‚¨ãƒ©ãƒ¼ç¨®åˆ¥ã‚’è¨˜éŒ²

            throw new PlcConnectionException(
                $"ä¸æ­£ãªIPã‚¢ãƒ‰ãƒ¬ã‚¹: {_connectionConfig.IpAddress}",
                new ArgumentException($"Invalid IP address: {_connectionConfig.IpAddress}"));
            // â˜…throw: ä¾‹å¤–ã‚’ã‚¹ãƒ­ãƒ¼ï¼ˆã‚¨ãƒ©ãƒ¼ã‚’ç™ºç”Ÿã•ã›ã‚‹ï¼‰
            // â˜…PlcConnectionException: ã‚«ã‚¹ã‚¿ãƒ ä¾‹å¤–ã‚¯ãƒ©ã‚¹
            // â˜…new ArgumentException: å†…éƒ¨ä¾‹å¤–ã‚’ä½œæˆ
        }

        // ----- 2. æ—¢å­˜æ¥ç¶šãƒã‚§ãƒƒã‚¯ -----
        if (_connectionResponse?.Status == ConnectionStatus.Connected)
        // â˜…?: nullæ¡ä»¶æ¼”ç®—å­ï¼ˆnullã®å ´åˆã¯è©•ä¾¡ã—ãªã„ï¼‰
        // â˜…== ConnectionStatus.Connected: æ—¢ã«æ¥ç¶šæ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
        {
            throw new InvalidOperationException(Constants.ErrorMessages.AlreadyConnected);
            // â˜…InvalidOperationException: ä¸æ­£ãªæ“ä½œã®ä¾‹å¤–
        }

        // ----- 3. Socketä½œæˆ -----
        Socket socket;
        // â˜…Socket: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é€šä¿¡ç”¨ã®ã‚¯ãƒ©ã‚¹

        if (_socketFactory != null)  // â˜…ãƒ†ã‚¹ãƒˆç’°å¢ƒã®å ´åˆ
        {
            // === ãƒ†ã‚¹ãƒˆç”¨ã®Socketã‚’ä½œæˆ ===
            socket = _socketFactory.CreateSocket(_connectionConfig.UseTcp);
            // â˜…_socketFactory: ãƒ†ã‚¹ãƒˆç”¨ã®Socketä½œæˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
            // â˜…æœ¬ç•ªç’°å¢ƒã§ã¯å¸¸ã«null
        }
        else  // â˜…æœ¬ç•ªç’°å¢ƒã®å ´åˆï¼ˆå¸¸ã«ã“ã¡ã‚‰ï¼‰
        {
            // === å®Ÿéš›ã®Socketã‚’ä½œæˆ ===
            if (_connectionConfig.UseTcp)  // TCPæ¥ç¶šã®å ´åˆ
            {
                socket = new Socket(
                    AddressFamily.InterNetwork,  // IPv4ã‚’ä½¿ç”¨
                    // â˜…AddressFamily: ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒ•ã‚¡ãƒŸãƒªï¼ˆãƒ—ãƒ­ãƒˆã‚³ãƒ«ç³»çµ±ï¼‰

                    SocketType.Stream,           // ã‚¹ãƒˆãƒªãƒ¼ãƒ å‹ï¼ˆTCPï¼‰
                    // â˜…Stream: ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ãƒˆãƒªãƒ¼ãƒ ï¼ˆé€£ç¶šãƒ‡ãƒ¼ã‚¿ï¼‰ã¨ã—ã¦æ‰±ã†

                    ProtocolType.Tcp);           // TCPãƒ—ãƒ­ãƒˆã‚³ãƒ«
                // â˜…Tcp: Transmission Control Protocolï¼ˆä¿¡é ¼æ€§ã®é«˜ã„é€šä¿¡ï¼‰
            }
            else  // UDPæ¥ç¶šã®å ´åˆ
            {
                socket = new Socket(
                    AddressFamily.InterNetwork,  // IPv4ã‚’ä½¿ç”¨
                    SocketType.Dgram,            // ãƒ‡ãƒ¼ã‚¿ã‚°ãƒ©ãƒ å‹ï¼ˆUDPï¼‰
                    // â˜…Dgram: ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‘ã‚±ãƒƒãƒˆå˜ä½ã§æ‰±ã†

                    ProtocolType.Udp);           // UDPãƒ—ãƒ­ãƒˆã‚³ãƒ«
                // â˜…Udp: User Datagram Protocolï¼ˆé«˜é€Ÿã ãŒä¿¡é ¼æ€§ã¯ä½ã„ï¼‰
            }
        }

        // ----- 4. æ¥ç¶šå®Ÿè¡Œ -----
        var ipAddress = System.Net.IPAddress.Parse(_connectionConfig.IpAddress);
        // â˜…Parse: æ–‡å­—åˆ—ã‚’IPAddressã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›

        var endpoint = new IPEndPoint(ipAddress, _connectionConfig.Port);
        // â˜…IPEndPoint: IPã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒãƒ¼ãƒˆç•ªå·ã®ãƒšã‚¢
        // â˜…ä¾‹: 192.168.1.100:5000

        var connectTimeoutMs = _timeoutConfig.ConnectTimeoutMs;
        // â˜…æ¥ç¶šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå€¤ã‚’å–å¾—ï¼ˆãƒŸãƒªç§’ï¼‰

        var cts = new CancellationTokenSource(connectTimeoutMs);
        // â˜…CancellationTokenSource: ã‚­ãƒ£ãƒ³ã‚»ãƒ«é€šçŸ¥ã‚’ç™ºè¡Œã™ã‚‹ã‚¯ãƒ©ã‚¹
        // â˜…ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚é–“ã‚’æŒ‡å®šã—ã¦ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ

        await socket.ConnectAsync(endpoint, cts.Token);
        // â˜…ConnectAsync: éåŒæœŸã§æ¥ç¶š
        // â˜…endpoint: æ¥ç¶šå…ˆï¼ˆIPã‚¢ãƒ‰ãƒ¬ã‚¹:ãƒãƒ¼ãƒˆï¼‰
        // â˜…cts.Token: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç”¨ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒˆãƒ¼ã‚¯ãƒ³
        // â˜…await: æ¥ç¶šå®Œäº†ã¾ã§å¾…æ©Ÿ

        // ----- 5. ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š -----
        socket.SendTimeout = _timeoutConfig.SendTimeoutMs;
        // â˜…SendTimeout: é€ä¿¡ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰

        socket.ReceiveTimeout = _timeoutConfig.ReceiveTimeoutMs;
        // â˜…ReceiveTimeout: å—ä¿¡ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰

        // ----- 6. æ¥ç¶šæƒ…å ±è¨˜éŒ² -----
        _connectionResponse = new ConnectionResponse
        {
            Status = ConnectionStatus.Connected,  // æ¥ç¶šæ¸ˆã¿çŠ¶æ…‹
            Socket = socket,                      // Socketã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
            ConnectedAt = DateTime.UtcNow,        // æ¥ç¶šæ™‚åˆ»
            IpAddress = _connectionConfig.IpAddress,  // IPã‚¢ãƒ‰ãƒ¬ã‚¹
            Port = _connectionConfig.Port         // ãƒãƒ¼ãƒˆç•ªå·
        };
        // â˜…_connectionResponse: ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ä¿å­˜ï¼ˆå¾Œç¶šå‡¦ç†ã§ä½¿ç”¨ï¼‰

        // ----- 7. è¿”å´ -----
        return _connectionResponse;
    }
    catch (Exception ex)  // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆ
    {
        // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°å‡ºåŠ›ãƒ»çµ±è¨ˆè¨˜éŒ²ãªã©ã®å‡¦ç†
        // ï¼ˆçœç•¥ï¼‰
        throw;  // ä¾‹å¤–ã‚’å†ã‚¹ãƒ­ãƒ¼ï¼ˆå‘¼ã³å‡ºã—å…ƒã«ä¼æ’­ï¼‰
    }
}
```

---

## 5. Step4: ãƒ‡ãƒ¼ã‚¿é€å—ä¿¡

### Step4-1: SendFrameAsync - é€ä¿¡å‡¦ç†

```csharp
// ãƒ•ã‚¡ã‚¤ãƒ«: andon/Core/Managers/PlcCommunicationManager.cs
// SendFrameAsync: ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’é€ä¿¡ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
public async Task SendFrameAsync(string frameHexString)
// â˜…frameHexString: 16é€²æ•°æ–‡å­—åˆ—ï¼ˆä¾‹: "5000..."ï¼‰
{
    // ----- 1. å…¥åŠ›æ¤œè¨¼ -----
    if (string.IsNullOrEmpty(frameHexString))
    // â˜…string.IsNullOrEmpty: nullã¾ãŸã¯ç©ºæ–‡å­—åˆ—ã‹ãƒã‚§ãƒƒã‚¯
    {
        throw new ArgumentException(Constants.ErrorMessages.InvalidFrame, nameof(frameHexString));
        // â˜…nameof: ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åã‚’æ–‡å­—åˆ—ã¨ã—ã¦å–å¾—
    }

    // ----- 2. æœªæ¥ç¶šãƒã‚§ãƒƒã‚¯ -----
    if (_connectionResponse?.Status != ConnectionStatus.Connected || _connectionResponse?.Socket == null)
    // â˜…||: è«–ç†ORæ¼”ç®—å­ï¼ˆã©ã¡ã‚‰ã‹ãŒtrueãªã‚‰trueï¼‰
    {
        throw new InvalidOperationException(Constants.ErrorMessages.NotConnected);
    }

    // ----- 3. ãƒ•ãƒ¬ãƒ¼ãƒ æ–‡å­—åˆ—ã‚’ãƒã‚¤ãƒˆé…åˆ—ã«å¤‰æ› -----
    byte[] frameBytes;

    if (_connectionConfig.IsBinary)  // Binaryå½¢å¼ã®å ´åˆ
    {
        // === 16é€²æ•°æ–‡å­—åˆ—ã‚’ãƒã‚¤ãƒŠãƒªã«å¤‰æ› ===
        frameBytes = ConvertHexStringToBytes(frameHexString);
        // â˜…"5000" â†’ [0x50, 0x00]
    }
    else  // ASCIIå½¢å¼ã®å ´åˆ
    {
        // === æ–‡å­—åˆ—ã‚’ãã®ã¾ã¾ASCIIãƒã‚¤ãƒˆã«å¤‰æ› ===
        frameBytes = System.Text.Encoding.ASCII.GetBytes(frameHexString);
        // â˜…Encoding.ASCII: ASCIIæ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
        // â˜…GetBytes: æ–‡å­—åˆ—ã‚’ãƒã‚¤ãƒˆé…åˆ—ã«å¤‰æ›
    }

    // ----- 4. ã‚½ã‚±ãƒƒãƒˆé€ä¿¡ -----
    try
    {
        int sentBytes = await _connectionResponse.Socket.SendAsync(
            frameBytes,        // é€ä¿¡ã™ã‚‹ãƒã‚¤ãƒˆé…åˆ—
            SocketFlags.None); // ãƒ•ãƒ©ã‚°ï¼ˆé€šå¸¸ã¯Noneï¼‰
        // â˜…SendAsync: éåŒæœŸã§é€ä¿¡
        // â˜…æˆ»ã‚Šå€¤: é€ä¿¡ã—ãŸãƒã‚¤ãƒˆæ•°
        // â˜…await: é€ä¿¡å®Œäº†ã¾ã§å¾…æ©Ÿ

        // ----- 5. é€ä¿¡çµ±è¨ˆè¨˜éŒ² -----
        _stats.SentFrames++;
        // â˜…++: ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆæ¼”ç®—å­ï¼ˆ1å¢—ã‚„ã™ï¼‰

        _stats.SentBytes += sentBytes;
        // â˜…+=: è¤‡åˆä»£å…¥æ¼”ç®—å­ï¼ˆåŠ ç®—ã—ã¦ä»£å…¥ï¼‰

        _stats.LastSentAt = DateTime.UtcNow;
        // â˜…æœ€çµ‚é€ä¿¡æ™‚åˆ»ã‚’è¨˜éŒ²
    }
    catch (SocketException ex)  // ã‚½ã‚±ãƒƒãƒˆã‚¨ãƒ©ãƒ¼ã®å ´åˆ
    // â˜…SocketException: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼å°‚ç”¨ã®ä¾‹å¤–
    {
        // ã‚¨ãƒ©ãƒ¼å‡¦ç†
        throw;
    }
}
```

### Step4-2: ReceiveResponseAsync - å—ä¿¡å‡¦ç†

```csharp
// ãƒ•ã‚¡ã‚¤ãƒ«: andon/Core/Managers/PlcCommunicationManager.cs
// ReceiveResponseAsync: ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å—ä¿¡ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
public async Task<RawResponseData> ReceiveResponseAsync(int receiveTimeoutMs)
// â˜…receiveTimeoutMs: å—ä¿¡ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
{
    // ----- 1. æ¥ç¶šçŠ¶æ…‹ãƒã‚§ãƒƒã‚¯ -----
    if (_socket == null)
    {
        throw new InvalidOperationException(ErrorMessages.NotConnectedForReceive);
    }

    // ----- 2. å—ä¿¡ãƒãƒƒãƒ•ã‚¡æº–å‚™ -----
    byte[] buffer = new byte[8192];
    // â˜…buffer: å—ä¿¡ãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´ã™ã‚‹é…åˆ—ï¼ˆ8KBã‚µã‚¤ã‚ºï¼‰
    // â˜…8192 = 8 * 1024ï¼ˆé€šå¸¸ã®ãƒãƒƒãƒ•ã‚¡ã‚µã‚¤ã‚ºï¼‰

    var startTime = DateTime.UtcNow;
    // â˜…å—ä¿¡é–‹å§‹æ™‚åˆ»ã‚’è¨˜éŒ²

    // ----- 3. ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆåˆ¶å¾¡ä»˜ãå—ä¿¡ -----
    var cts = new CancellationTokenSource(receiveTimeoutMs);
    // â˜…ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚é–“ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½œæˆ

    try
    {
        int receivedBytes;
        // â˜…receivedBytes: å—ä¿¡ã—ãŸãƒã‚¤ãƒˆæ•°ã‚’æ ¼ç´ã™ã‚‹å¤‰æ•°

        // === Socketå‹åˆ¤å®šï¼ˆãƒ†ã‚¹ãƒˆç’°å¢ƒ or æœ¬ç•ªç’°å¢ƒï¼‰===
        if (_socket.GetType().Name == "MockSocket")  // â˜…ãƒ†ã‚¹ãƒˆç’°å¢ƒ
        {
            // === ãƒ†ã‚¹ãƒˆç’°å¢ƒç”¨ã®å‡¦ç† ===
            var mockSocket = _socket as dynamic;
            // â˜…dynamic: å‹•çš„å‹ï¼ˆå®Ÿè¡Œæ™‚ã«å‹ãŒæ±ºã¾ã‚‹ï¼‰
            // â˜…as: ã‚­ãƒ£ã‚¹ãƒˆæ¼”ç®—å­ï¼ˆå¤‰æ›ï¼‰

            receivedBytes = await mockSocket.ReceiveAsync(
                new ArraySegment<byte>(buffer),  // å—ä¿¡ãƒãƒƒãƒ•ã‚¡ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ
                // â˜…ArraySegment<byte>: é…åˆ—ã®ä¸€éƒ¨ã‚’è¡¨ã™æ§‹é€ ä½“

                SocketFlags.None,
                cts.Token);
        }
        else  // â˜…æœ¬ç•ªç’°å¢ƒï¼ˆå¸¸ã«ã“ã¡ã‚‰ï¼‰
        {
            // === é€šå¸¸ã®Socketå‡¦ç† ===
            receivedBytes = await _socket.ReceiveAsync(
                new ArraySegment<byte>(buffer),
                // â˜…ArraySegment: é…åˆ—å…¨ä½“ã‚’æŒ‡å®š

                SocketFlags.None,
                // â˜…SocketFlags: ã‚½ã‚±ãƒƒãƒˆæ“ä½œã®ãƒ•ãƒ©ã‚°
                // â˜…None: ç‰¹åˆ¥ãªå‡¦ç†ãªã—

                cts.Token);
                // â˜…ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ¤œçŸ¥ç”¨ï¼‰
        }

        // ----- 4. å—ä¿¡ãƒ‡ãƒ¼ã‚¿æŠ½å‡º -----
        byte[] responseData = new byte[receivedBytes];
        // â˜…å®Ÿéš›ã«å—ä¿¡ã—ãŸãƒã‚¤ãƒˆæ•°åˆ†ã®é…åˆ—ã‚’ä½œæˆ

        Array.Copy(buffer, 0, responseData, 0, receivedBytes);
        // â˜…buffer â†’ responseData ã«ã‚³ãƒ”ãƒ¼
        // â˜…ç¬¬1å¼•æ•°: ã‚³ãƒ”ãƒ¼å…ƒ
        // â˜…ç¬¬2å¼•æ•°: ã‚³ãƒ”ãƒ¼å…ƒé–‹å§‹ä½ç½®ï¼ˆ0ã‹ã‚‰ï¼‰
        // â˜…ç¬¬3å¼•æ•°: ã‚³ãƒ”ãƒ¼å…ˆ
        // â˜…ç¬¬4å¼•æ•°: ã‚³ãƒ”ãƒ¼å…ˆé–‹å§‹ä½ç½®ï¼ˆ0ã‹ã‚‰ï¼‰
        // â˜…ç¬¬5å¼•æ•°: ã‚³ãƒ”ãƒ¼ã™ã‚‹ãƒã‚¤ãƒˆæ•°

        // ----- 5. å—ä¿¡çµ±è¨ˆè¨˜éŒ² -----
        _stats.ReceivedFrames++;
        _stats.ReceivedBytes += receivedBytes;
        _stats.LastReceivedAt = DateTime.UtcNow;

        // ----- 6. è¿”å´ -----
        return new RawResponseData
        {
            ResponseData = responseData,
            // â˜…å—ä¿¡ã—ãŸç”Ÿãƒ‡ãƒ¼ã‚¿ï¼ˆãƒã‚¤ãƒˆé…åˆ—ï¼‰

            DataLength = receivedBytes,
            // â˜…å—ä¿¡ãƒã‚¤ãƒˆæ•°

            ReceivedAt = DateTime.UtcNow,
            // â˜…å—ä¿¡æ™‚åˆ»

            ReceiveTime = DateTime.UtcNow - startTime,
            // â˜…å—ä¿¡ã«ã‹ã‹ã£ãŸæ™‚é–“ï¼ˆTimeSpanå‹ï¼‰

            ResponseHex = Convert.ToHexString(responseData),
            // â˜…16é€²æ•°æ–‡å­—åˆ—ã«å¤‰æ›ï¼ˆãƒ­ã‚°å‡ºåŠ›ç”¨ï¼‰

            FrameType = FrameType.Frame3E  // ä»®å€¤ï¼ˆå¾Œã§åˆ¤å®šï¼‰
        };
    }
    catch (OperationCanceledException)  // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã®å ´åˆ
    // â˜…OperationCanceledException: ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã®ä¾‹å¤–
    {
        throw new TimeoutException($"å—ä¿¡ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: {receiveTimeoutMs}ms");
    }
}
```

---

## 6. Step6: ãƒ‡ãƒ¼ã‚¿è§£æ

### Step6-1: ProcessReceivedRawData - åŸºæœ¬å‡¦ç†

```csharp
// ãƒ•ã‚¡ã‚¤ãƒ«: andon/Core/Managers/PlcCommunicationManager.cs
// ProcessReceivedRawData: å—ä¿¡ãƒ‡ãƒ¼ã‚¿ã‚’åŸºæœ¬å‡¦ç†ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
public async Task<BasicProcessedResponseData> ProcessReceivedRawData(
    byte[] rawData,                                // å—ä¿¡ã—ãŸç”Ÿãƒ‡ãƒ¼ã‚¿
    ProcessedDeviceRequestInfo processedRequestInfo,  // è¦æ±‚æƒ…å ±
    CancellationToken cancellationToken = default)    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒˆãƒ¼ã‚¯ãƒ³
{
    // ----- å…¥åŠ›æ¤œè¨¼ -----
    if (rawData == null || rawData.Length == 0)
    {
        throw new ArgumentException(ErrorMessages.InvalidRawDataFormat);
    }

    // ----- å‡¦ç†é–‹å§‹æ™‚åˆ»ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨ˆæ¸¬ -----
    var startTime = DateTime.Now;
    var stopwatch = System.Diagnostics.Stopwatch.StartNew();
    // â˜…Stopwatch: é«˜ç²¾åº¦ãªæ™‚é–“è¨ˆæ¸¬ã‚¯ãƒ©ã‚¹
    // â˜…StartNew(): è¨ˆæ¸¬é–‹å§‹

    // ----- çµæœã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ -----
    var result = new BasicProcessedResponseData
    {
        IsSuccess = true,
        ProcessedDevices = new List<ProcessedDevice>(),
        // â˜…ProcessedDevice: å‡¦ç†æ¸ˆã¿ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ã‚’ä¿æŒã™ã‚‹ã‚¯ãƒ©ã‚¹

        Errors = new List<string>(),
        Warnings = new List<string>(),
        ProcessedAt = startTime,
        ProcessingTimeMs = 0,  // å¾Œã§è¨­å®š
        ProcessedDeviceCount = 0,
        TotalDataSizeBytes = rawData.Length
    };

    try
    {
        // ----- ãƒ•ãƒ¬ãƒ¼ãƒ ã‚¿ã‚¤ãƒ—è‡ªå‹•åˆ¤å®š -----
        FrameType detectedFrameType;
        // â˜…FrameType: åˆ—æŒ™å‹ï¼ˆFrame3E_Binary, Frame4E_Binaryç­‰ï¼‰

        try
        {
            detectedFrameType = DetectFrameTypeFromSubheader(rawData);
            // â˜…ã‚µãƒ–ãƒ˜ãƒƒãƒ€ï¼ˆå…ˆé ­2ãƒã‚¤ãƒˆï¼‰ã‹ã‚‰ãƒ•ãƒ¬ãƒ¼ãƒ å‹ã‚’åˆ¤å®š
            // â˜…0xD0 0x00 â†’ Frame3E_Binary
            // â˜…0xD4 0x00 â†’ Frame4E_Binary
        }
        catch (FormatException ex)
        {
            Console.WriteLine($"[ERROR] ãƒ•ãƒ¬ãƒ¼ãƒ ã‚¿ã‚¤ãƒ—è‡ªå‹•åˆ¤å®šå¤±æ•—: {ex.Message}");
            throw;  // ä¾‹å¤–ã‚’å†ã‚¹ãƒ­ãƒ¼
        }

        // ----- SLMPãƒ•ãƒ¬ãƒ¼ãƒ æ§‹é€ æ¤œè¨¼ -----
        if (!ValidateSlmpFrameStructure(rawData, detectedFrameType))
        // â˜…ãƒ•ãƒ¬ãƒ¼ãƒ ã®æœ€å°é•·ã€æ§‹é€ ãŒæ­£ã—ã„ã‹ãƒã‚§ãƒƒã‚¯
        {
            throw new FormatException(ErrorMessages.InvalidRawDataFormat);
        }

        // ----- ãƒ•ãƒ¬ãƒ¼ãƒ æ§‹é€ è§£æ -----
        (ushort EndCode, byte[] DeviceData) frameData;
        // â˜…ã‚¿ãƒ—ãƒ«: è¤‡æ•°ã®å€¤ã‚’1ã¤ã®å¤‰æ•°ã§å—ã‘å–ã‚‹
        // â˜…EndCode: çµ‚äº†ã‚³ãƒ¼ãƒ‰ï¼ˆ0x0000 = æ­£å¸¸ï¼‰
        // â˜…DeviceData: ãƒ‡ãƒã‚¤ã‚¹ãƒ‡ãƒ¼ã‚¿éƒ¨åˆ†ï¼ˆãƒã‚¤ãƒˆé…åˆ—ï¼‰

        switch (detectedFrameType)
        // â˜…switch: å€¤ã«ã‚ˆã£ã¦å‡¦ç†ã‚’åˆ†å²
        {
            case FrameType.Frame3E_Binary:
                frameData = Parse3EFrameStructure(rawData);
                // â˜…3Eãƒ•ãƒ¬ãƒ¼ãƒ ï¼ˆBinaryï¼‰ã‚’è§£æ
                break;  // switchæ–‡ã‚’æŠœã‘ã‚‹

            case FrameType.Frame4E_Binary:
                frameData = Parse4EFrameStructure(rawData);
                // â˜…4Eãƒ•ãƒ¬ãƒ¼ãƒ ï¼ˆBinaryï¼‰ã‚’è§£æ
                break;

            case FrameType.Frame3E_ASCII:
                frameData = Parse3EFrameStructureAscii(rawData);
                // â˜…3Eãƒ•ãƒ¬ãƒ¼ãƒ ï¼ˆASCIIï¼‰ã‚’è§£æ
                break;

            case FrameType.Frame4E_ASCII:
                frameData = Parse4EFrameStructureAscii(rawData);
                // â˜…4Eãƒ•ãƒ¬ãƒ¼ãƒ ï¼ˆASCIIï¼‰ã‚’è§£æ
                break;

            default:
                // â˜…ä¸Šè¨˜ä»¥å¤–ã®ã‚±ãƒ¼ã‚¹ï¼ˆæƒ³å®šå¤–ï¼‰
                throw new NotSupportedException($"Frame type {detectedFrameType} is not supported");
                // â˜…NotSupportedException: ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„æ©Ÿèƒ½ã®ä¾‹å¤–
        }

        // ----- çµ‚äº†ã‚³ãƒ¼ãƒ‰ç¢ºèª -----
        if (frameData.EndCode != 0x0000)
        // â˜…0x0000ä»¥å¤–ã¯PLCã‚¨ãƒ©ãƒ¼
        {
            throw new InvalidOperationException(
                string.Format(ErrorMessages.InvalidEndCode, frameData.EndCode.ToString("X4")));
            // â˜…string.Format: æ–‡å­—åˆ—ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            // â˜…ToString("X4"): 16é€²æ•°4æ¡ã§æ–‡å­—åˆ—åŒ–
        }

        // ----- ãƒ‡ãƒã‚¤ã‚¹å€¤æŠ½å‡º -----
        var extractedDevices = ExtractDeviceValues(frameData.DeviceData, processedRequestInfo, startTime);
        // â˜…DeviceDataã‹ã‚‰ãƒ‡ãƒã‚¤ã‚¹å€¤ã‚’æŠ½å‡º
        // â˜…æˆ»ã‚Šå€¤: List<ProcessedDevice>

        // ----- å‡¦ç†æ¸ˆã¿ãƒ‡ãƒã‚¤ã‚¹ãƒªã‚¹ãƒˆã«è¿½åŠ  -----
        foreach (var device in extractedDevices)
        {
            result.ProcessedDevices.Add(device);
            Console.WriteLine($"[DEBUG] ãƒ‡ãƒã‚¤ã‚¹å€¤æŠ½å‡º: {device.DeviceName}={device.Value}({device.DataType})");
            // â˜…ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°å‡ºåŠ›
        }

        result.ProcessedDeviceCount = result.ProcessedDevices.Count;

        // ----- ãƒ“ãƒƒãƒˆå±•é–‹é©ç”¨ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰-----
        if (_bitExpansionSettings.Enabled)
        // â˜…ãƒ“ãƒƒãƒˆå±•é–‹æ©Ÿèƒ½ãŒæœ‰åŠ¹ãªå ´åˆ
        {
            result.ProcessedDevices = ApplyBitExpansion(
                result.ProcessedDevices,
                _bitExpansionSettings);
            // â˜…ãƒ¯ãƒ¼ãƒ‰ãƒ‡ãƒã‚¤ã‚¹ã‚’16ãƒ“ãƒƒãƒˆã«å±•é–‹
        }

        // ----- å‡¦ç†æ™‚é–“è¨ˆç®— -----
        stopwatch.Stop();
        // â˜…è¨ˆæ¸¬åœæ­¢

        result.ProcessingTimeMs = Math.Max(stopwatch.ElapsedMilliseconds, 1);
        // â˜…Math.Max: 2ã¤ã®å€¤ã®ã†ã¡å¤§ãã„æ–¹ã‚’è¿”ã™
        // â˜…æœ€å°1msã«è¨­å®šï¼ˆ0mså›é¿ï¼‰

        return result;
    }
    catch (ArgumentException ex)
    {
        return HandleProcessingError(result, stopwatch, ex, "å‰å‡¦ç†æƒ…å ±ã‚¨ãƒ©ãƒ¼");
        // â˜…ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼ˆä¾‹å¤–ã‚’å†ã‚¹ãƒ­ãƒ¼ã—ãªã„ï¼‰
    }
    // ï¼ˆä»–ã®catchå¥ã‚‚åŒæ§˜ï¼‰
}
```

### ExtractDeviceValues - ãƒ‡ãƒã‚¤ã‚¹å€¤æŠ½å‡º

```csharp
// ExtractDeviceValues: ãƒ‡ãƒã‚¤ã‚¹ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ãƒ‡ãƒã‚¤ã‚¹å€¤ã‚’æŠ½å‡º
private List<ProcessedDevice> ExtractDeviceValues(
    byte[] deviceData,                           // ãƒ‡ãƒã‚¤ã‚¹ãƒ‡ãƒ¼ã‚¿éƒ¨åˆ†
    ProcessedDeviceRequestInfo requestInfo,      // è¦æ±‚æƒ…å ±
    DateTime processedAt)                        // å‡¦ç†æ™‚åˆ»
{
    var result = new List<ProcessedDevice>();
    // â˜…çµæœãƒªã‚¹ãƒˆ

    int offset = 0;
    // â˜…offset: ç¾åœ¨ã®èª­ã¿å–ã‚Šä½ç½®ï¼ˆãƒã‚¤ãƒˆå˜ä½ï¼‰

    // è¦æ±‚ã—ãŸãƒ‡ãƒã‚¤ã‚¹ã”ã¨ã«ãƒ«ãƒ¼ãƒ—
    foreach (var device in requestedDevices)
    {
        // ----- ã‚µã‚¤ã‚ºè¨ˆç®— -----
        int size = device.Unit == "word" ? 2 :
                   device.Unit == "dword" ? 4 : 1;
        // â˜…ä¸‰é …æ¼”ç®—å­: æ¡ä»¶ ? çœŸã®å€¤ : å½ã®å€¤
        // â˜…word: 2ãƒã‚¤ãƒˆ, dword: 4ãƒã‚¤ãƒˆ, bit: 1ãƒã‚¤ãƒˆ

        // ----- å€¤ã®ãƒã‚¤ãƒˆåˆ—ã‚’å–ã‚Šå‡ºã™ -----
        byte[] valueBytes = deviceData[offset..(offset + size)];
        // â˜…ç¯„å›²æ¼”ç®—å­: [é–‹å§‹..çµ‚äº†]
        // â˜…ä¾‹: offset=0, size=2 â†’ deviceData[0..2] ï¼ˆ0,1ç•ªç›®ï¼‰

        // ----- ãƒ‡ãƒ¼ã‚¿å‹å¤‰æ› -----
        object value = ConvertDataType(valueBytes, device.DataType);
        // â˜…ConvertDataType: ãƒã‚¤ãƒˆåˆ—ã‚’å®Ÿéš›ã®å€¤ã«å¤‰æ›
        // â˜…æˆ»ã‚Šå€¤: objectå‹ï¼ˆä»»æ„ã®å‹ã‚’æ ¼ç´ã§ãã‚‹ï¼‰

        // ----- ProcessedDeviceã‚’ä½œæˆ -----
        var processedDevice = new ProcessedDevice
        {
            DeviceName = device.ItemName,
            // â˜…ä¾‹: "D100"

            DeviceCode = device.Code,
            // â˜…ä¾‹: DeviceCode.D

            Address = device.DeviceNumber,
            // â˜…ä¾‹: 100

            Value = value,
            // â˜…ä¾‹: 12345ï¼ˆushortå‹ï¼‰

            DataType = device.DataType,
            // â˜…ä¾‹: "word"

            ProcessedAt = processedAt
            // â˜…å‡¦ç†æ™‚åˆ»
        };

        result.Add(processedDevice);

        // ----- æ¬¡ã®ãƒ‡ãƒã‚¤ã‚¹ã®ä½ç½®ã«ç§»å‹• -----
        offset += size;
        // â˜…offsetã‚’å¢—ã‚„ã—ã¦æ¬¡ã®ãƒ‡ãƒã‚¤ã‚¹ã«é€²ã‚€
    }

    return result;
}
```

### ConvertDataType - ãƒ‡ãƒ¼ã‚¿å‹å¤‰æ›

```csharp
// ConvertDataType: ãƒã‚¤ãƒˆåˆ—ã‚’æŒ‡å®šã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿å‹ã«å¤‰æ›
private object ConvertDataType(byte[] bytes, string dataType)
{
    switch (dataType)
    {
        case "word":
            // === ç¬¦å·ãªã—16ãƒ“ãƒƒãƒˆæ•´æ•° ===
            return BitConverter.ToUInt16(bytes, 0);
            // â˜…BitConverter: ãƒã‚¤ãƒˆé…åˆ—ã¨åŸºæœ¬å‹ã‚’ç›¸äº’å¤‰æ›ã™ã‚‹ã‚¯ãƒ©ã‚¹
            // â˜…ToUInt16: ãƒã‚¤ãƒˆé…åˆ—ã‚’16ãƒ“ãƒƒãƒˆç¬¦å·ãªã—æ•´æ•°ã«å¤‰æ›
            // â˜…ç¬¬1å¼•æ•°: ãƒã‚¤ãƒˆé…åˆ—
            // â˜…ç¬¬2å¼•æ•°: é–‹å§‹ä½ç½®ï¼ˆ0ã‹ã‚‰ï¼‰
            // â˜…ä¾‹: [0x39, 0x30] â†’ 0x3039 (LE) â†’ 12345

        case "dword":
            // === ç¬¦å·ãªã—32ãƒ“ãƒƒãƒˆæ•´æ•° ===
            return BitConverter.ToUInt32(bytes, 0);
            // â˜…ToUInt32: 32ãƒ“ãƒƒãƒˆç¬¦å·ãªã—æ•´æ•°ã«å¤‰æ›
            // â˜…ä¾‹: [0x00, 0x00, 0x30, 0x39] â†’ 0x39300000 (LE)

        case "bit":
            // === ãƒ“ãƒƒãƒˆå€¤ ===
            return (bytes[0] & 0x10) != 0;
            // â˜…bytes[0]: æœ€åˆã®ãƒã‚¤ãƒˆ
            // â˜…& 0x10: ãƒ“ãƒƒãƒˆ4ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆSLMPä»•æ§˜ï¼‰
            // â˜…!= 0: 0ã§ãªã‘ã‚Œã°true
            // â˜…æˆ»ã‚Šå€¤: boolå‹

        case "signed":
            // === ç¬¦å·ä»˜ã16ãƒ“ãƒƒãƒˆæ•´æ•° ===
            return BitConverter.ToInt16(bytes, 0);
            // â˜…ToInt16: ç¬¦å·ä»˜ã16ãƒ“ãƒƒãƒˆæ•´æ•°ã«å¤‰æ›
            // â˜…è² ã®å€¤ã‚‚è¡¨ç¾å¯èƒ½

        default:
            // === æœªå¯¾å¿œã®å‹ ===
            throw new NotSupportedException($"Unsupported data type: {dataType}");
    }
}
```

---

## 7. Step7: JSONå‡ºåŠ›

### DataOutputManager.cs - OutputToJsonå®Ÿè£…

```csharp
// ãƒ•ã‚¡ã‚¤ãƒ«: andon/Core/Managers/DataOutputManager.cs
// OutputToJson: ProcessedResponseDataã‚’JSONå½¢å¼ã§å‡ºåŠ›
public void OutputToJson(
    ProcessedResponseData data,                    // å‡¦ç†æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿
    string outputDirectory,                        // å‡ºåŠ›å…ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
    string ipAddress,                              // IPã‚¢ãƒ‰ãƒ¬ã‚¹
    int port,                                      // ãƒãƒ¼ãƒˆç•ªå·
    Dictionary<string, DeviceEntryInfo> deviceConfig)  // ãƒ‡ãƒã‚¤ã‚¹è¨­å®š
    // â˜…Dictionary: ã‚­ãƒ¼ã¨å€¤ã®ãƒšã‚¢ã‚’æ ¼ç´ã™ã‚‹ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
    // â˜…<string, DeviceEntryInfo>: ã‚­ãƒ¼ãŒæ–‡å­—åˆ—ã€å€¤ãŒDeviceEntryInfoå‹
{
    try
    {
        // ----- ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ -----
        ValidateInputData(data, outputDirectory, ipAddress, port, deviceConfig);

        // ----- ãƒ•ã‚¡ã‚¤ãƒ«åç”Ÿæˆ -----
        var timestamp = data.ProcessedAt;
        var dateString = timestamp.ToString("yyyyMMdd_HHmmssfff");
        // â˜…ToString("..."):æ—¥æ™‚ã‚’æ–‡å­—åˆ—ã«å¤‰æ›
        // â˜…"yyyyMMdd_HHmmssfff": ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæŒ‡å®š
        //   yyyy: 4æ¡ã®å¹´, MM: 2æ¡ã®æœˆ, dd: 2æ¡ã®æ—¥
        //   HH: 24æ™‚é–“åˆ¶ã®æ™‚, mm: åˆ†, ss: ç§’, fff: ãƒŸãƒªç§’
        // â˜…ä¾‹: "20251201_103045123"

        var ipString = ipAddress.Replace(".", "-");
        // â˜…Replace: æ–‡å­—åˆ—ç½®æ›
        // â˜…"192.168.1.100" â†’ "192-168-1-100"

        var fileName = $"{dateString}_{ipString}_{port}.json";
        // â˜…æ–‡å­—åˆ—è£œé–“ã§ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ä½œæˆ
        // â˜…ä¾‹: "20251201_103045123_192-168-1-100_5000.json"

        var filePath = Path.Combine(outputDirectory, fileName);
        // â˜…Path.Combine: ãƒ‘ã‚¹ã‚’çµåˆï¼ˆOSä¾å­˜ã®åŒºåˆ‡ã‚Šæ–‡å­—ã‚’è‡ªå‹•å‡¦ç†ï¼‰
        // â˜…ä¾‹: "C:\output" + "file.json" â†’ "C:\output\file.json"

        // ----- ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå­˜åœ¨ç¢ºèªãƒ»è‡ªå‹•ä½œæˆ -----
        if (!Directory.Exists(outputDirectory))
        // â˜…Directory.Exists: ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å­˜åœ¨ç¢ºèª
        {
            Directory.CreateDirectory(outputDirectory);
            // â˜…CreateDirectory: ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆï¼ˆè¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚‚è‡ªå‹•ä½œæˆï¼‰
        }

        // ----- itemsé…åˆ—æ§‹ç¯‰ -----
        var itemsList = new List<object>();
        // â˜…List<object>: ä»»æ„ã®å‹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ ¼ç´ã§ãã‚‹ãƒªã‚¹ãƒˆ

        foreach (var kvp in data.ProcessedData)
        // â˜…kvp: KeyValuePairï¼ˆã‚­ãƒ¼ã¨å€¤ã®ãƒšã‚¢ï¼‰
        {
            var deviceData = kvp.Value;
            // â˜…Value: Dictionaryã®å€¤éƒ¨åˆ†ã‚’å–å¾—

            if (deviceData.Code.IsBitDevice())
            // â˜…IsBitDevice(): ãƒ“ãƒƒãƒˆãƒ‡ãƒã‚¤ã‚¹ã‹ã©ã†ã‹åˆ¤å®šã™ã‚‹æ‹¡å¼µãƒ¡ã‚½ãƒƒãƒ‰
            {
                // === ãƒ“ãƒƒãƒˆãƒ‡ãƒã‚¤ã‚¹ã¯16ãƒ“ãƒƒãƒˆå±•é–‹ ===
                AddBitDeviceItems(itemsList, deviceData, deviceConfig);
            }
            else
            {
                // === ãƒ¯ãƒ¼ãƒ‰/ãƒ€ãƒ–ãƒ«ãƒ¯ãƒ¼ãƒ‰ãƒ‡ãƒã‚¤ã‚¹ã¯ãã®ã¾ã¾ ===
                AddWordDeviceItem(itemsList, kvp.Key, deviceData, deviceConfig);
            }
        }

        // ----- JSONæ§‹é€ æ§‹ç¯‰ -----
        var jsonData = new
        // â˜…new: åŒ¿åå‹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
        // â˜…åŒ¿åå‹: åå‰ã®ãªã„å‹ï¼ˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®ã¿å®šç¾©ï¼‰
        {
            source = new
            {
                plcModel = "Unknown",  // PLCæ©Ÿç¨®åï¼ˆPhase7ã§å®Ÿè£…äºˆå®šï¼‰
                ipAddress = ipAddress,
                port = port
            },
            timestamp = new
            {
                local = timestamp.ToString("yyyy-MM-ddTHH:mm:ss.fffzzz")
                // â˜…ISO 8601å½¢å¼
                // â˜…zzz: ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ï¼ˆ+09:00ãªã©ï¼‰
            },
            items = itemsList.ToArray()
            // â˜…ToArray(): Listã‚’Arrayã«å¤‰æ›
        };

        // ----- JSONå‡ºåŠ›ï¼ˆã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆä»˜ãï¼‰-----
        var options = new JsonSerializerOptions
        // â˜…JsonSerializerOptions: JSONå¤‰æ›ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³
        {
            WriteIndented = true,
            // â˜…WriteIndented: èª­ã¿ã‚„ã™ã„ã‚ˆã†ã«ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚’è¿½åŠ 

            Encoder = System.Text.Encodings.Web.JavaScriptEncoder.UnsafeRelaxedJsonEscaping
            // â˜…Encoder: æ–‡å­—ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰æ–¹æ³•
            // â˜…UnsafeRelaxedJsonEscaping: æ—¥æœ¬èªãªã©ã‚’ãã®ã¾ã¾å‡ºåŠ›
        };

        var jsonString = JsonSerializer.Serialize(jsonData, options);
        // â˜…JsonSerializer.Serialize: ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’JSONæ–‡å­—åˆ—ã«å¤‰æ›
        // â˜…System.Text.Jsonåå‰ç©ºé–“ã®ã‚¯ãƒ©ã‚¹

        File.WriteAllText(filePath, jsonString);
        // â˜…File.WriteAllText: ãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›¸ãè¾¼ã¿
        // â˜…æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¸Šæ›¸ã

        // ----- ãƒ­ã‚°å‡ºåŠ›å®Œäº† -----
        var fileInfo = new FileInfo(filePath);
        // â˜…FileInfo: ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’å–å¾—ã™ã‚‹ã‚¯ãƒ©ã‚¹

        Console.WriteLine($"[INFO] JSONå‡ºåŠ›å®Œäº†: ãƒ•ã‚¡ã‚¤ãƒ«={fileName}, ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º={fileInfo.Length}ãƒã‚¤ãƒˆ");
        // â˜…fileInfo.Length: ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºï¼ˆãƒã‚¤ãƒˆï¼‰
    }
    catch (ArgumentNullException ex)
    // â˜…ArgumentNullException: å¼•æ•°ãŒnullã®å ´åˆã®ä¾‹å¤–
    {
        Console.WriteLine($"[ERROR] ãƒ‡ãƒ¼ã‚¿ãŒnullã§ã™: {ex.Message}");
        throw;  // ä¾‹å¤–ã‚’å†ã‚¹ãƒ­ãƒ¼
    }
    // ï¼ˆä»–ã®catchå¥ã‚‚åŒæ§˜ï¼‰
}
```

### AddBitDeviceItems - ãƒ“ãƒƒãƒˆãƒ‡ãƒã‚¤ã‚¹å±•é–‹

```csharp
// AddBitDeviceItems: ãƒ“ãƒƒãƒˆãƒ‡ãƒã‚¤ã‚¹ã‚’16ãƒ“ãƒƒãƒˆã«å±•é–‹ã—ã¦itemsã«è¿½åŠ 
private void AddBitDeviceItems(
    List<object> itemsList,                // è¿½åŠ å…ˆãƒªã‚¹ãƒˆ
    DeviceData deviceData,                 // ãƒ‡ãƒã‚¤ã‚¹ãƒ‡ãƒ¼ã‚¿
    Dictionary<string, DeviceEntryInfo> deviceConfig)  // ãƒ‡ãƒã‚¤ã‚¹è¨­å®š
{
    // ----- ãƒ¯ãƒ¼ãƒ‰å€¤ã‚’å–å¾— -----
    ushort wordValue = Convert.ToUInt16(deviceData.Value);
    // â˜…Convert.ToUInt16: objectã‚’ushortã«å¤‰æ›
    // â˜…ä¾‹: 0x00FF â†’ 255

    // ----- 16ãƒ“ãƒƒãƒˆãƒ«ãƒ¼ãƒ— -----
    for (int bitIndex = 0; bitIndex < BitsPerWord; bitIndex++)
    // â˜…BitsPerWord: å®šæ•°16ï¼ˆ1ãƒ¯ãƒ¼ãƒ‰ = 16ãƒ“ãƒƒãƒˆï¼‰
    // â˜…bitIndex: 0ã‹ã‚‰15ã¾ã§ãƒ«ãƒ¼ãƒ—
    {
        // === ãƒ“ãƒƒãƒˆå€¤ã‚’å–å¾— ===
        bool bitValue = (wordValue & (1 << bitIndex)) != 0;
        // â˜…(1 << bitIndex): å·¦ã‚·ãƒ•ãƒˆæ¼”ç®—
        //   bitIndex=0: 1 << 0 = 0b00000001 (1)
        //   bitIndex=1: 1 << 1 = 0b00000010 (2)
        //   bitIndex=2: 1 << 2 = 0b00000100 (4)
        // â˜…wordValue & ...: ãƒ“ãƒƒãƒˆANDæ¼”ç®—
        //   ä¾‹: 0b11111111 & 0b00000001 = 0b00000001 (1)
        //   ä¾‹: 0b11111111 & 0b00010000 = 0b00010000 (16)
        // â˜…!= 0: çµæœãŒ0ã§ãªã‘ã‚Œã°true

        // === ã‚¢ãƒ‰ãƒ¬ã‚¹æ–‡å­—åˆ—ã‚’ä½œæˆ ===
        string address = $"{deviceData.DeviceName}.{bitIndex}";
        // â˜…ä¾‹: "M10.0", "M10.1", ..., "M10.15"

        // === itemsã«è¿½åŠ  ===
        itemsList.Add(new
        // â˜…åŒ¿åå‹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦ãƒªã‚¹ãƒˆã«è¿½åŠ 
        {
            address = address,
            value = bitValue,
            digits = GetDigits(deviceConfig, deviceData)
            // â˜…æ¡æ•°ã‚’å–å¾—ï¼ˆè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ï¼‰
        });
    }
}
```

---

## 8. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### ç¶™ç¶šå®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰ã§ã®ã‚¨ãƒ©ãƒ¼å‡¦ç†

```csharp
// ãƒ•ã‚¡ã‚¤ãƒ«: andon/Core/Controllers/ExecutionOrchestrator.cs
// ExecuteMultiPlcCycleAsync_Internal: è¤‡æ•°PLCã®ã‚µã‚¤ã‚¯ãƒ«å®Ÿè¡Œ
private async Task ExecuteMultiPlcCycleAsync_Internal(
    List<PlcConfiguration> plcConfigs,
    List<Interfaces.IPlcCommunicationManager> plcManagers,
    CancellationToken cancellationToken)
{
    // ----- å…¥åŠ›æ¤œè¨¼ -----
    if (plcManagers == null || plcManagers.Count == 0)
    {
        return;  // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°å‡ºåŠ›å¾Œã€å‡¦ç†ã‚’çµ‚äº†
    }

    // ----- å„PLCã«å¯¾ã—ã¦ãƒ«ãƒ¼ãƒ— -----
    for (int i = 0; i < plcManagers.Count; i++)
    {
        var manager = plcManagers[i];
        var config = plcConfigs[i];

        try
        {
            // ----- ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒã‚§ãƒƒã‚¯ -----
            cancellationToken.ThrowIfCancellationRequested();
            // â˜…ThrowIfCancellationRequested: ã‚­ãƒ£ãƒ³ã‚»ãƒ«è¦æ±‚ãŒã‚ã‚Œã°ä¾‹å¤–ã‚¹ãƒ­ãƒ¼
            // â˜…OperationCanceledException ã‚’ã‚¹ãƒ­ãƒ¼

            // ----- Step2: ãƒ•ãƒ¬ãƒ¼ãƒ æ§‹ç¯‰ -----
            var frame = _configToFrameManager!.BuildReadRandomFrameFromConfig(config);
            // â˜…!: nulléè¨±å®¹æ¼”ç®—å­ï¼ˆnullã§ãªã„ã“ã¨ã‚’ä¿è¨¼ï¼‰

            // ----- Step3-6: å®Œå…¨ã‚µã‚¤ã‚¯ãƒ«å®Ÿè¡Œ -----
            var result = await manager.ExecuteFullCycleAsync(
                connectionConfig,
                timeoutConfig,
                frame,
                deviceRequestInfo,
                cancellationToken);

            // ----- Step7: ãƒ‡ãƒ¼ã‚¿å‡ºåŠ› -----
            if (result.IsSuccess && result.ProcessedData != null)
            {
                _dataOutputManager?.OutputToJson(
                    result.ProcessedData,
                    outputDirectory,
                    config.IpAddress,
                    config.Port,
                    deviceConfig);
                // â˜…?: nullæ¡ä»¶æ¼”ç®—å­ï¼ˆnullã®å ´åˆã¯å®Ÿè¡Œã—ãªã„ï¼‰
            }
        }
        catch (OperationCanceledException)
        // â˜…ã‚­ãƒ£ãƒ³ã‚»ãƒ«è¦æ±‚ã®å ´åˆ
        {
            throw;  // â˜…ä¾‹å¤–ã‚’å†ã‚¹ãƒ­ãƒ¼ï¼ˆä¸Šä½ã«ä¼æ’­ï¼‰
            // â˜…ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¯æ­£å¸¸ãªãƒ•ãƒ­ãƒ¼ãªã®ã§ä¸Šä½ã§å‡¦ç†
        }
        catch (Exception ex)
        // â˜…ãã®ä»–ã™ã¹ã¦ã®ä¾‹å¤–
        {
            // ===== ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°å‡ºåŠ› =====
            // ï¼ˆLoggingManagerè¿½åŠ æ™‚ã«å®Ÿè£…ï¼‰

            // ===== â˜…é‡è¦: ä¾‹å¤–ã‚’å†ã‚¹ãƒ­ãƒ¼ã—ãªã„ =====
            // â˜…ã“ã“ã§æ­¢ã¾ã‚‰ãšã€æ¬¡ã®PLCã®å‡¦ç†ã‚’ç¶™ç¶š
            // â˜…1ã¤ã®PLCã®å¤±æ•—ãŒä»–ã®PLCã«å½±éŸ¿ã—ãªã„

            _ = ex;  // â˜…è­¦å‘Šå›é¿ï¼ˆä½¿ç”¨ã—ã¦ã„ãªã„å¤‰æ•°ï¼‰
            // â˜…_: ç ´æ£„ï¼ˆdiscardï¼‰ã€å€¤ã‚’æ¨ã¦ã‚‹
        }
    }
}
```

### ãƒ‡ãƒ¼ã‚¿ç ´ææ™‚ã®ã‚¨ãƒ©ãƒ¼å‡¦ç†

```csharp
// ProcessReceivedRawDataå†…ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
catch (FormatException ex)
// â˜…FormatException: ãƒ‡ãƒ¼ã‚¿å½¢å¼ã‚¨ãƒ©ãƒ¼
{
    return HandleProcessingError(result, stopwatch, ex, "ãƒ‡ãƒ¼ã‚¿å½¢å¼ã‚¨ãƒ©ãƒ¼");
    // â˜…â˜…é‡è¦: throw ã—ãªã„ï¼ˆä¾‹å¤–ã‚’å†ã‚¹ãƒ­ãƒ¼ã—ãªã„ï¼‰
    // â˜…ã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’å«ã‚€çµæœã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã™
}

// HandleProcessingError: ã‚¨ãƒ©ãƒ¼å‡¦ç†ãƒ¡ã‚½ãƒƒãƒ‰
private BasicProcessedResponseData HandleProcessingError(
    BasicProcessedResponseData result,
    Stopwatch stopwatch,
    Exception ex,
    string errorCategory)
{
    // ----- å¤±æ•—çŠ¶æ…‹ã«è¨­å®š -----
    result.IsSuccess = false;
    // â˜…å‡¦ç†å¤±æ•—ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹

    // ----- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ  -----
    result.Errors.Add($"{errorCategory}: {ex.Message}");
    // â˜…Errors: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒªã‚¹ãƒˆ
    // â˜…Add: ãƒªã‚¹ãƒˆã«è¿½åŠ 

    // ----- å‡¦ç†æ™‚é–“ã‚’è¨˜éŒ² -----
    result.ProcessingTimeMs = stopwatch.ElapsedMilliseconds;
    // â˜…ElapsedMilliseconds: çµŒéãƒŸãƒªç§’

    // ----- ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°å‡ºåŠ› -----
    Console.WriteLine($"[ERROR] {errorCategory}: {ex.Message}");

    // ----- çµæœã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã™ -----
    return result;
    // â˜…â˜…é‡è¦: throwã—ãªã„ã€çµæœã‚’è¿”ã™
    // â˜…å‘¼ã³å‡ºã—å…ƒã§IsSuccessã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã‚¨ãƒ©ãƒ¼åˆ¤å®š
}
```

---

## C#ã®é‡è¦ãªæ¦‚å¿µï¼ˆåˆå­¦è€…å‘ã‘ï¼‰

### 1. éåŒæœŸå‡¦ç†ï¼ˆasync/awaitï¼‰

```csharp
// async: ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯éåŒæœŸå‡¦ç†ã‚’å«ã‚€ã“ã¨ã‚’å®£è¨€
// Task<T>: éåŒæœŸã§Tå‹ã®å€¤ã‚’è¿”ã™ã“ã¨ã‚’è¡¨ã™
public async Task<string> GetDataAsync()
{
    // await: ã“ã®å‡¦ç†ã®å®Œäº†ã‚’å¾…ã¤ï¼ˆã§ã‚‚ä»–ã®å‡¦ç†ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ï¼‰
    var result = await SomeAsyncOperation();
    // â˜…awaitãŒã‚ã‚‹ã¨ã€å‡¦ç†ãŒå®Œäº†ã™ã‚‹ã¾ã§å¾…æ©Ÿ
    // â˜…ã§ã‚‚ã€CPUã¯ä»–ã®å‡¦ç†ã‚’å®Ÿè¡Œã§ãã‚‹ï¼ˆãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ï¼‰

    return result;
}

// åŒæœŸç‰ˆã¨ã®æ¯”è¼ƒ
public string GetDataSync()  // â˜…asyncãªã—
{
    var result = SomeOperation();  // â˜…awaitãªã—ã€å‡¦ç†å®Œäº†ã¾ã§å¾…æ©Ÿ
    return result;
    // â˜…ã“ã®é–“ã€CPUã¯ä»–ã®ã“ã¨ãŒã§ããªã„ï¼ˆãƒ–ãƒ­ãƒƒã‚¯ï¼‰
}
```

### 2. nullè¨±å®¹å‹ã¨æ¼”ç®—å­

```csharp
// nullè¨±å®¹å‹
string? name = null;  // â˜…?: nullã‚’è¨±å®¹ã™ã‚‹å‚ç…§å‹
// â˜…C# 8.0ä»¥é™ã€å‚ç…§å‹ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§nulléè¨±å®¹

// nullæ¡ä»¶æ¼”ç®—å­
int? length = name?.Length;
// â˜…?: nameãŒnullã®å ´åˆã¯è©•ä¾¡ã—ãªã„ï¼ˆlengthã¯nullï¼‰
// â˜…nameãŒnullã§ãªã„å ´åˆã®ã¿.Lengthã‚’è©•ä¾¡

// nullåˆä½“æ¼”ç®—å­
string displayName = name ?? "Unknown";
// â˜…??: å·¦å´ãŒnullã®å ´åˆã¯å³å´ã‚’è¿”ã™
// â˜…nameãŒnullãªã‚‰"Unknown"ã€nullã§ãªã‘ã‚Œã°nameã®å€¤

// nulléè¨±å®¹æ¼”ç®—å­
string definitelyNotNull = name!;
// â˜…!: nameã¯çµ¶å¯¾ã«nullã§ãªã„ã“ã¨ã‚’ä¿è¨¼
// â˜…ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®è­¦å‘Šã‚’æŠ‘åˆ¶ï¼ˆå®Ÿè¡Œæ™‚ã«nullãªã‚‰ã‚¨ãƒ©ãƒ¼ï¼‰
```

### 3. LINQï¼ˆLanguage Integrated Queryï¼‰

```csharp
// ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹
List<int> numbers = new List<int> { 1, 2, 3, 4, 5 };

// ToList(): IEnumerableã‚’Listã«å¤‰æ›
var list = numbers.Where(n => n > 2).ToList();
// â˜…Where: æ¡ä»¶ã«åˆã†è¦ç´ ã ã‘ã‚’æŠ½å‡º
// â˜…n => n > 2: ãƒ©ãƒ ãƒ€å¼ï¼ˆç„¡åé–¢æ•°ï¼‰ã€nãŒ2ã‚ˆã‚Šå¤§ãã„

// Select: å„è¦ç´ ã‚’å¤‰æ›
var doubled = numbers.Select(n => n * 2);
// â˜…å„è¦ç´ ã‚’2å€ã«å¤‰æ›

// FirstOrDefault: æœ€åˆã®è¦ç´ ã‚’å–å¾—ï¼ˆãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼‰
var first = numbers.FirstOrDefault(n => n > 10);
// â˜…10ã‚ˆã‚Šå¤§ãã„æœ€åˆã®è¦ç´ ï¼ˆãªã‘ã‚Œã°0ï¼‰

// Count: è¦ç´ æ•°ã‚’å–å¾—
int count = numbers.Count;
```

### 4. ã‚¸ã‚§ãƒãƒªãƒƒã‚¯å‹

```csharp
// List<T>: Tå‹ã®è¦ç´ ã‚’æŒã¤ãƒªã‚¹ãƒˆ
List<int> numbers = new List<int>();
// â˜…<int>: intã ã‘ã‚’æ ¼ç´ã§ãã‚‹ãƒªã‚¹ãƒˆ

List<string> names = new List<string>();
// â˜…<string>: stringã ã‘ã‚’æ ¼ç´ã§ãã‚‹ãƒªã‚¹ãƒˆ

// ã‚¸ã‚§ãƒãƒªãƒƒã‚¯ãƒ¡ã‚½ãƒƒãƒ‰
public T GetValue<T>(string key)
// â˜…<T>: å‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆå‘¼ã³å‡ºã—æ™‚ã«å‹ã‚’æŒ‡å®šï¼‰
{
    // Tã¯å®Ÿéš›ã®å‹ã«ç½®ãæ›ãˆã‚‰ã‚Œã‚‹
}

// ä½¿ç”¨ä¾‹
int value = GetValue<int>("age");
// â˜…<int>: Tã‚’intã¨ã—ã¦ä½¿ç”¨
```

### 5. ãƒ‡ãƒªã‚²ãƒ¼ãƒˆã¨ãƒ©ãƒ ãƒ€å¼

```csharp
// ãƒ‡ãƒªã‚²ãƒ¼ãƒˆ: ãƒ¡ã‚½ãƒƒãƒ‰ã¸ã®å‚ç…§ã‚’ä¿æŒã™ã‚‹å‹
Func<int, int, int> add = (a, b) => a + b;
// â˜…Func<T1, T2, TResult>: T1,T2ã‚’å—ã‘å–ã‚ŠTResultã‚’è¿”ã™ãƒ‡ãƒªã‚²ãƒ¼ãƒˆ
// â˜…(a, b) => a + b: ãƒ©ãƒ ãƒ€å¼ï¼ˆåŒ¿åé–¢æ•°ï¼‰

int result = add(1, 2);  // â˜…3

// Action: æˆ»ã‚Šå€¤ãªã—ã®ãƒ‡ãƒªã‚²ãƒ¼ãƒˆ
Action<string> print = message => Console.WriteLine(message);
// â˜…Action<T>: Tã‚’å—ã‘å–ã‚Šæˆ»ã‚Šå€¤ãªã—

print("Hello");  // â˜…"Hello"ã‚’å‡ºåŠ›
```

### 6. ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

```csharp
public class Person
{
    // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆå¤‰æ•°ï¼‰
    private string _name;  // â˜…private: ã‚¯ãƒ©ã‚¹å†…éƒ¨ã‹ã‚‰ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½

    // ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ï¼ˆgetterã¨setterã‚’æŒã¤ï¼‰
    public string Name
    // â˜…public: å¤–éƒ¨ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
    {
        get { return _name; }       // â˜…getter: å€¤ã‚’å–å¾—
        set { _name = value; }      // â˜…setter: å€¤ã‚’è¨­å®š
        // â˜…value: è¨­å®šã•ã‚Œã‚‹å€¤ã‚’è¡¨ã™ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
    }

    // è‡ªå‹•å®Ÿè£…ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£
    public int Age { get; set; }
    // â˜…get/setã‚’è‡ªå‹•ç”Ÿæˆï¼ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä¸è¦ï¼‰
}
```

---

## ã¾ã¨ã‚: å®Ÿè£…ã®æµã‚Œå…¨ä½“åƒ

### 1. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•ã¨DIè§£æ±ºãƒ•ãƒ­ãƒ¼

```
ã€Program.Main() é–‹å§‹ã€‘
   â†“
1. Host.CreateDefaultBuilder(args)
   â”œâ”€> appsettings.jsonã®èª­ã¿è¾¼ã¿
   â”œâ”€> ç’°å¢ƒå¤‰æ•°ã®èª­ã¿è¾¼ã¿
   â””â”€> DIã‚³ãƒ³ãƒ†ãƒŠã®åˆæœŸåŒ–
   â†“
2. .ConfigureServices((hostContext, services) => ...)
   â”œâ”€> DependencyInjectionConfigurator.Configure(services, configuration)
   â”‚   â”œâ”€> appsettings.jsonã‹ã‚‰è¨­å®šã‚’ãƒã‚¤ãƒ³ãƒ‰
   â”‚   â”‚   â”œâ”€> IOptions<DataProcessingConfig>
   â”‚   â”‚   â”œâ”€> IOptions<SystemResourcesConfig>
   â”‚   â”‚   â””â”€> IOptions<LoggingConfig>
   â”‚   â”œâ”€> Singletonç™»éŒ²
   â”‚   â”‚   â”œâ”€> IApplicationController â†’ ApplicationController
   â”‚   â”‚   â”œâ”€> ILoggingManager â†’ LoggingManager
   â”‚   â”‚   â”œâ”€> IErrorHandler â†’ ErrorHandler
   â”‚   â”‚   â”œâ”€> MultiPlcConfigManager
   â”‚   â”‚   â”œâ”€> ConfigurationLoaderExcelï¼ˆãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
   â”‚   â”‚   â””â”€> ãã®ä»–Phase3ã‚¯ãƒ©ã‚¹
   â”‚   â””â”€> Transientç™»éŒ²
   â”‚       â”œâ”€> IExecutionOrchestrator â†’ ExecutionOrchestratorï¼ˆãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
   â”‚       â”œâ”€> IConfigToFrameManager â†’ ConfigToFrameManager
   â”‚       â”œâ”€> IDataOutputManager â†’ DataOutputManager
   â”‚       â”œâ”€> ITimerService â†’ TimerService
   â”‚       â””â”€> ãã®ä»–Phase3ã‚¯ãƒ©ã‚¹
   â””â”€> services.AddHostedService<AndonHostedService>()
   â†“
3. var host = builder.Build()
   ğŸ”§ DIã‚³ãƒ³ãƒ†ãƒŠãŒSingletonã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆ
   â”œâ”€> ILoggingManager â†’ LoggingManagerã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆ
   â”œâ”€> MultiPlcConfigManager â†’ MultiPlcConfigManagerã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆ
   â”œâ”€> ConfigurationLoaderExcel â†’ ConfigurationLoaderExcelã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆ
   â”‚   â””â”€> ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§MultiPlcConfigManagerã‚’æ³¨å…¥
   â”œâ”€> IApplicationController â†’ ApplicationControllerã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆ
   â”‚   â””â”€> ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§ä»¥ä¸‹ã‚’æ³¨å…¥:
   â”‚       â”œâ”€> MultiPlcConfigManagerï¼ˆæ—¢å­˜ã®Singletonã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼‰
   â”‚       â”œâ”€> IExecutionOrchestratorï¼ˆæ–°è¦Transientã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆï¼‰
   â”‚       â”œâ”€> ILoggingManagerï¼ˆæ—¢å­˜ã®Singletonã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼‰
   â”‚       â”œâ”€> IConfigurationWatcherï¼ˆæ—¢å­˜ã®Singletonã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼‰
   â”‚       â””â”€> ConfigurationLoaderExcelï¼ˆæ—¢å­˜ã®Singletonã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼‰
   â””â”€> AndonHostedService â†’ AndonHostedServiceã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆ
       â””â”€> ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§ä»¥ä¸‹ã‚’æ³¨å…¥:
           â”œâ”€> IApplicationControllerï¼ˆæ—¢å­˜ã®Singletonã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼‰
           â””â”€> ILoggingManagerï¼ˆæ—¢å­˜ã®Singletonã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼‰
   â†“
4. await host.RunAsync()
   ğŸ”§ AndonHostedService.StartAsync()è‡ªå‹•å‘¼ã³å‡ºã—
   â†“
   AndonHostedService.ExecuteAsync()è‡ªå‹•å‘¼ã³å‡ºã—
   â†“
   ApplicationController.StartAsync()å‘¼ã³å‡ºã—
```

### 2. Step1: åˆæœŸåŒ–ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆ1å›ã®ã¿ï¼‰

```
ã€ApplicationController.ExecuteStep1InitializationAsync() é–‹å§‹ã€‘
   â†“
1. ConfigurationLoaderExcel.LoadAllPlcConnectionConfigs()
   ğŸ”§ å®Ÿè¡Œãƒ•ã‚©ãƒ«ãƒ€å†…ã®.xlsxãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢
   â”œâ”€> *.xlsxãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã™ã¹ã¦æ¤œç´¢
   â”œâ”€> å„ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰è¨­å®šã‚’èª­ã¿è¾¼ã¿
   â”‚   â”œâ”€> "settings"ã‚·ãƒ¼ãƒˆ â†’ IPã‚¢ãƒ‰ãƒ¬ã‚¹ã€ãƒãƒ¼ãƒˆã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãªã©
   â”‚   â””â”€> "ãƒ‡ãƒ¼ã‚¿åé›†ãƒ‡ãƒã‚¤ã‚¹"ã‚·ãƒ¼ãƒˆ â†’ ãƒ‡ãƒã‚¤ã‚¹ä¸€è¦§
   â””â”€> MultiPlcConfigManager.AddConfiguration()ã§è¨­å®šã‚’ç™»éŒ²
   â†“
2. MultiPlcConfigManager.GetAllConfigurations()
   â””â”€> ç™»éŒ²æ¸ˆã¿è¨­å®šã‚’å–å¾—
   â†“
3. è¨­å®šã”ã¨ã«PlcCommunicationManagerã‚’ç”Ÿæˆ
   foreachãƒ«ãƒ¼ãƒ—ï¼ˆå„PLCè¨­å®šï¼‰:
     â”œâ”€> ConnectionConfigä½œæˆï¼ˆIPã‚¢ãƒ‰ãƒ¬ã‚¹ã€ãƒãƒ¼ãƒˆã€TCP/UDPã€Binary/ASCIIï¼‰
     â”œâ”€> TimeoutConfigä½œæˆï¼ˆæ¥ç¶šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã€é€ä¿¡ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã€å—ä¿¡ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰
     â”œâ”€> new PlcCommunicationManager(connectionConfig, timeoutConfig)
     â””â”€> _plcManagers.Add(manager)
   â†“
4. è¨­å®šæƒ…å ±ã‚’ä¿æŒ
   â”œâ”€> _plcConfigs = configs.ToList()
   â””â”€> _plcManagers = ç”Ÿæˆã—ãŸãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ãƒªã‚¹ãƒˆ
   â†“
ã€Step1å®Œäº†ã€‘
```

### 3. ç¶™ç¶šå®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰é–‹å§‹ï¼ˆå‘¨æœŸå®Ÿè¡Œï¼‰

```
ã€ApplicationController.StartContinuousDataCycleAsync() é–‹å§‹ã€‘
   â†“
1. ExecutionOrchestrator.RunContinuousDataCycleAsync()å‘¼ã³å‡ºã—
   â”œâ”€> å¼•æ•°: _plcConfigs, _plcManagers, cancellationToken
   â†“
2. TimerService.StartPeriodicExecution()å‘¼ã³å‡ºã—
   â”œâ”€> å¼•æ•°:
   â”‚   â”œâ”€> action: ExecuteMultiPlcCycleAsync_Internal
   â”‚   â”œâ”€> interval: MonitoringIntervalMsï¼ˆappsettings.jsonã‹ã‚‰èª­ã¿è¾¼ã¿ã€ä¾‹: 5000msï¼‰
   â”‚   â””â”€> cancellationToken
   â†“
3. å‘¨æœŸå®Ÿè¡Œãƒ«ãƒ¼ãƒ—é–‹å§‹
   PeriodicTimer.WaitForNextTickAsync() â†’ intervalçµŒéå¾Œã«å®Ÿè¡Œ
   â†“
   ExecuteMultiPlcCycleAsync_Internal() å‘¼ã³å‡ºã—
   â”‚
   â”œâ”€> foreachï¼ˆå„PLCï¼‰:
   â”‚   â”œâ”€> Step2: ãƒ•ãƒ¬ãƒ¼ãƒ æ§‹ç¯‰
   â”‚   â”œâ”€> Step3-6: PLCé€šä¿¡ï¼ˆå®Œå…¨ã‚µã‚¤ã‚¯ãƒ«ï¼‰
   â”‚   â””â”€> Step7: ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›
   â”‚
   â†“ï¼ˆæ¬¡ã®å‘¨æœŸã¾ã§å¾…æ©Ÿï¼‰
   PeriodicTimer.WaitForNextTickAsync() â†’ intervalçµŒéå¾Œã«å®Ÿè¡Œ
   â†“
   ExecuteMultiPlcCycleAsync_Internal() å†å®Ÿè¡Œ
   â”‚
   â”œâ”€> foreachï¼ˆå„PLCï¼‰: ...
   â”‚
   â†“ï¼ˆä»¥é™ã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã‚‹ã¾ã§ç„¡é™ãƒ«ãƒ¼ãƒ—ï¼‰
```

### 4. Step2-7: ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚µã‚¤ã‚¯ãƒ«ï¼ˆç¹°ã‚Šè¿”ã—ï¼‰

```
ã€ExecuteMultiPlcCycleAsync_Internal() - å„PLCå‡¦ç†ã€‘
   â†“
foreachï¼ˆi = 0 to plcManagers.Count - 1ï¼‰:
   â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ ã€Step2: ãƒ•ãƒ¬ãƒ¼ãƒ æ§‹ç¯‰ã€‘                      â”‚
   â”‚ ConfigToFrameManager.BuildReadRandomFrameFromConfig()â”‚
   â”‚   â”œâ”€> PlcConfigurationã‹ã‚‰ãƒ‡ãƒã‚¤ã‚¹ãƒªã‚¹ãƒˆå–å¾—  â”‚
   â”‚   â”œâ”€> SlmpFrameBuilder.BuildReadRandomRequest()â”‚
   â”‚   â”‚   â”œâ”€> ã‚µãƒ–ãƒ˜ãƒƒãƒ€æ§‹ç¯‰ï¼ˆ3E or 4Eã€ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå·ï¼‰â”‚
   â”‚   â”‚   â”œâ”€> ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®šæ§‹ç¯‰                 â”‚
   â”‚   â”‚   â”œâ”€> ã‚³ãƒãƒ³ãƒ‰éƒ¨æ§‹ç¯‰ï¼ˆReadRandom 0x0403ï¼‰ â”‚
   â”‚   â”‚   â”œâ”€> ãƒ‡ãƒã‚¤ã‚¹æŒ‡å®šéƒ¨æ§‹ç¯‰                  â”‚
   â”‚   â”‚   â””â”€> ãƒ‡ãƒ¼ã‚¿é•·æ›´æ–°                       â”‚
   â”‚   â””â”€> byte[] frameè¿”å´                    â”‚
   â”‚                                            â”‚
   â”‚ ğŸ†• Phase12æ’ä¹…å¯¾ç­–: ReadRandomRequestInfoç”Ÿæˆâ”‚
   â”‚   â”œâ”€> DeviceSpecifications: config.Devices?.ToList() â”‚
   â”‚   â”œâ”€> FrameType: 3E or 4Eï¼ˆconfig.FrameVersionã‹ã‚‰ï¼‰ â”‚
   â”‚   â”œâ”€> RequestedAt: DateTime.UtcNow        â”‚
   â”‚   â””â”€> ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°: DeviceSpecifications.Count â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ ã€Step3: PLCæ¥ç¶šã€‘                          â”‚
   â”‚ PlcCommunicationManager.ConnectAsync()      â”‚
   â”‚   â”œâ”€> Socketä½œæˆï¼ˆTCP or UDPï¼‰              â”‚
   â”‚   â”œâ”€> ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆSendTimeoutã€ReceiveTimeoutï¼‰â”‚
   â”‚   â”œâ”€> IPEndPointä½œæˆï¼ˆIPã‚¢ãƒ‰ãƒ¬ã‚¹:ãƒãƒ¼ãƒˆï¼‰      â”‚
   â”‚   â”œâ”€> Socket.ConnectAsync()                â”‚
   â”‚   â””â”€> ConnectionResponseè¿”å´               â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ ã€Step4-1: ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã€‘                      â”‚
   â”‚ PlcCommunicationManager.SendFrameAsync()    â”‚
   â”‚   â”œâ”€> Binaryå½¢å¼: 16é€²æ–‡å­—åˆ— â†’ ãƒã‚¤ãƒˆé…åˆ—å¤‰æ›â”‚
   â”‚   â”œâ”€> ASCIIå½¢å¼: æ–‡å­—åˆ— â†’ ASCIIãƒã‚¤ãƒˆé…åˆ—å¤‰æ›â”‚
   â”‚   â”œâ”€> Socket.SendAsync()                   â”‚
   â”‚   â””â”€> çµ±è¨ˆæƒ…å ±æ›´æ–°ï¼ˆé€ä¿¡ãƒ•ãƒ¬ãƒ¼ãƒ æ•°ã€ãƒã‚¤ãƒˆæ•°ï¼‰â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ ã€Step4-2: ãƒ‡ãƒ¼ã‚¿å—ä¿¡ã€‘                      â”‚
   â”‚ PlcCommunicationManager.ReceiveResponseAsync()â”‚
   â”‚   â”œâ”€> å—ä¿¡ãƒãƒƒãƒ•ã‚¡æº–å‚™ï¼ˆ8192ãƒã‚¤ãƒˆï¼‰         â”‚
   â”‚   â”œâ”€> Socket.ReceiveAsync()ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆåˆ¶å¾¡ä»˜ãï¼‰â”‚
   â”‚   â”œâ”€> å—ä¿¡ãƒ‡ãƒ¼ã‚¿æŠ½å‡º                       â”‚
   â”‚   â”œâ”€> çµ±è¨ˆæƒ…å ±æ›´æ–°ï¼ˆå—ä¿¡ãƒ•ãƒ¬ãƒ¼ãƒ æ•°ã€ãƒã‚¤ãƒˆæ•°ï¼‰â”‚
   â”‚   â””â”€> RawResponseDataè¿”å´                 â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ ã€Step6: ãƒ‡ãƒ¼ã‚¿è§£æã€‘                        â”‚
   â”‚ ğŸ†• Phase12: ExecuteFullCycleAsyncï¼ˆReadRandomRequestInfoç‰ˆï¼‰â”‚
   â”‚                                            â”‚
   â”‚ Step6-1: åŸºæœ¬å‡¦ç†                          â”‚
   â”‚ PlcCommunicationManager.ProcessReceivedRawData()â”‚
   â”‚   â”œâ”€> ğŸ†• ReadRandomRequestInfo â†’ ProcessedDeviceRequestInfoå¤‰æ›ï¼ˆä¸€æ™‚çš„ï¼‰â”‚
   â”‚   â”‚   ï¼ˆTODO: Phase12.4-Step2ã§ç›´æ¥å‡¦ç†ã«å¤‰æ›´äºˆå®šï¼‰â”‚
   â”‚   â”œâ”€> ãƒ•ãƒ¬ãƒ¼ãƒ ã‚¿ã‚¤ãƒ—è‡ªå‹•åˆ¤å®šï¼ˆã‚µãƒ–ãƒ˜ãƒƒãƒ€ã‹ã‚‰ï¼‰ â”‚
   â”‚   â”‚   â”œâ”€> 0xD0 0x00 â†’ Frame3E_Binary      â”‚
   â”‚   â”‚   â”œâ”€> 0xD4 0x00 â†’ Frame4E_Binary      â”‚
   â”‚   â”‚   â”œâ”€> "D0" â†’ Frame3E_ASCII             â”‚
   â”‚   â”‚   â””â”€> "D4" â†’ Frame4E_ASCII             â”‚
   â”‚   â”œâ”€> ãƒ•ãƒ¬ãƒ¼ãƒ æ§‹é€ è§£æ                      â”‚
   â”‚   â”‚   â”œâ”€> çµ‚äº†ã‚³ãƒ¼ãƒ‰æŠ½å‡º                   â”‚
   â”‚   â”‚   â””â”€> ãƒ‡ãƒã‚¤ã‚¹ãƒ‡ãƒ¼ã‚¿éƒ¨æŠ½å‡º              â”‚
   â”‚   â”œâ”€> ãƒ‡ãƒã‚¤ã‚¹å€¤æŠ½å‡º                       â”‚
   â”‚   â”‚   â””â”€> foreachï¼ˆãƒ‡ãƒã‚¤ã‚¹ï¼‰:              â”‚
   â”‚   â”‚       â”œâ”€> ãƒã‚¤ãƒˆåˆ—å–å¾—ï¼ˆword=2, dword=4ï¼‰â”‚
   â”‚   â”‚       â”œâ”€> ãƒ‡ãƒ¼ã‚¿å‹å¤‰æ›ï¼ˆBitConverterä½¿ç”¨ï¼‰â”‚
   â”‚   â”‚       â””â”€> ProcessedDeviceä½œæˆ          â”‚
   â”‚   â”œâ”€> ãƒ“ãƒƒãƒˆå±•é–‹é©ç”¨ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰           â”‚
   â”‚   â””â”€> BasicProcessedResponseDataè¿”å´       â”‚
   â”‚                                            â”‚
   â”‚ Step6-2: ãƒ‡ãƒ¼ã‚¿å¤‰æ›ï¼ˆPhase3.5ã§DWordçµåˆå»ƒæ­¢ï¼‰â”‚
   â”‚   â”œâ”€> BasicProcessedData â†’ ProcessedDataå¤‰æ›â”‚
   â”‚   â””â”€> CombinedDWordDevices = ç©ºãƒªã‚¹ãƒˆ     â”‚
   â”‚                                            â”‚
   â”‚ Step6-3: æ§‹é€ åŒ–ï¼ˆæœ€çµ‚å‡¦ç†ï¼‰                 â”‚
   â”‚ ParseRawToStructuredData()                 â”‚
   â”‚   â”œâ”€> ProcessedData â†’ StructuredDataå¤‰æ›  â”‚
   â”‚   â””â”€> è¨­å®šæƒ…å ±ï¼ˆParseConfigurationï¼‰é©ç”¨   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ ã€Step5: åˆ‡æ–­ã€‘                             â”‚
   â”‚ PlcCommunicationManager.DisconnectAsync()   â”‚
   â”‚   â”œâ”€> Socket.Shutdown()                    â”‚
   â”‚   â”œâ”€> Socket.Close()                       â”‚
   â”‚   â””â”€> ConnectionStatsè¿”å´                  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ ã€Step7: JSONå‡ºåŠ›ã€‘                         â”‚
   â”‚ DataOutputManager.OutputToJson()            â”‚
   â”‚   â”œâ”€> ãƒ•ã‚¡ã‚¤ãƒ«åç”Ÿæˆï¼ˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—_IP_ãƒãƒ¼ãƒˆ.jsonï¼‰â”‚
   â”‚   â”œâ”€> itemsé…åˆ—æ§‹ç¯‰                         â”‚
   â”‚   â”‚   â”œâ”€> ãƒ“ãƒƒãƒˆãƒ‡ãƒã‚¤ã‚¹ â†’ 16ãƒ“ãƒƒãƒˆå±•é–‹     â”‚
   â”‚   â”‚   â””â”€> ãƒ¯ãƒ¼ãƒ‰ãƒ‡ãƒã‚¤ã‚¹ â†’ ãã®ã¾ã¾å‡ºåŠ›     â”‚
   â”‚   â”œâ”€> JSONæ§‹é€ æ§‹ç¯‰                         â”‚
   â”‚   â”‚   â”œâ”€> sourceï¼ˆPLCãƒ¢ãƒ‡ãƒ«ã€IPã‚¢ãƒ‰ãƒ¬ã‚¹ã€ãƒãƒ¼ãƒˆï¼‰â”‚
   â”‚   â”‚   â”œâ”€> timestampï¼ˆISO 8601å½¢å¼ï¼‰        â”‚
   â”‚   â”‚   â””â”€> itemsï¼ˆãƒ‡ãƒã‚¤ã‚¹ãƒ‡ãƒ¼ã‚¿é…åˆ—ï¼‰       â”‚
   â”‚   â”œâ”€> JsonSerializer.Serialize()ï¼ˆã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆä»˜ãï¼‰â”‚
   â”‚   â””â”€> File.WriteAllText()                  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
   æ¬¡ã®PLCã¸ï¼ˆforeachãƒ«ãƒ¼ãƒ—ç¶™ç¶šï¼‰
   ã¾ãŸã¯
   å…¨PLCå‡¦ç†å®Œäº† â†’ æ¬¡ã®å‘¨æœŸã¾ã§å¾…æ©Ÿ
```

### 5. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æµã‚Œ

```
ã€ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã®å‹•ä½œã€‘

1. å˜ä¸€PLCå‡¦ç†å†…ã§ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ
   â”œâ”€> catch (Exception ex)
   â”œâ”€> ãƒ­ã‚°å‡ºåŠ›ï¼ˆã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ï¼‰
   â”œâ”€> ä¾‹å¤–ã‚’å†ã‚¹ãƒ­ãƒ¼ã—ãªã„ï¼ˆé‡è¦ï¼ï¼‰
   â””â”€> æ¬¡ã®PLCã®å‡¦ç†ã‚’ç¶™ç¶š

2. ç¶™ç¶šå®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰ã§ã®å‹•ä½œ
   â”œâ”€> 1ã¤ã®PLCã®å¤±æ•—ãŒä»–ã®PLCã«å½±éŸ¿ã—ãªã„
   â”œâ”€> æ¬¡ã®å‘¨æœŸã§è‡ªå‹•çš„ã«å†è©¦è¡Œ
   â””â”€> å›å¾©å¯èƒ½ãªã‚¨ãƒ©ãƒ¼ï¼ˆä¸€æ™‚çš„ãªãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯éšœå®³ãªã©ï¼‰ã¯è‡ªå‹•å›å¾©

3. è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚
   â”œâ”€> ApplicationController.StopAsync()å‘¼ã³å‡ºã—
   â”œâ”€> ãƒªã‚½ãƒ¼ã‚¹è§£æ”¾å‡¦ç†å®Ÿè¡Œ
   â””â”€> ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†

ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®åŸå‰‡ã€‘
âœ… å›å¾©å¯èƒ½ãªã‚¨ãƒ©ãƒ¼ã¯ç¶™ç¶šå®Ÿè¡Œ
âŒ è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼ã®ã¿ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åœæ­¢
ğŸ”§ ã‚¨ãƒ©ãƒ¼æƒ…å ±ã¯å…¨ã¦ãƒ­ã‚°ã«è¨˜éŒ²
```

---

## å…¨ä½“ãƒ•ãƒ­ãƒ¼å›³ï¼ˆASCIIï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•                          â”‚
â”‚  Program.Main() â†’ Host.Build() â†’ host.RunAsync()                  â”‚
â”‚       â†“                                                            â”‚
â”‚  DIã‚³ãƒ³ãƒ†ãƒŠåˆæœŸåŒ–                                                   â”‚
â”‚  â”œâ”€ appsettings.jsonèª­ã¿è¾¼ã¿                                       â”‚
â”‚  â”œâ”€ Singleton/Transientç™»éŒ²                                       â”‚
â”‚  â””â”€ ä¾å­˜æ€§è§£æ±º                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   AndonHostedServiceèµ·å‹•                           â”‚
â”‚  StartAsync() â†’ ExecuteAsync() â†’ ApplicationController.StartAsync()â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Step1: åˆæœŸåŒ–ï¼ˆ1å›ã®ã¿ï¼‰                       â”‚
â”‚  â”œâ”€ ConfigurationLoaderExcel.LoadAllPlcConnectionConfigs()        â”‚
â”‚  â”‚   â””â”€ Excelãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰è¨­å®šèª­ã¿è¾¼ã¿                              â”‚
â”‚  â”œâ”€ PlcCommunicationManagerç”Ÿæˆï¼ˆå„PLCç”¨ï¼‰                         â”‚
â”‚  â””â”€ _plcManagers, _plcConfigsä¿å­˜                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç¶™ç¶šå®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰é–‹å§‹                              â”‚
â”‚  TimerService.StartPeriodicExecution()                             â”‚
â”‚  â””â”€ MonitoringIntervalMsé–“éš”ã§Step2-7ã‚’å‘¨æœŸå®Ÿè¡Œ                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
              â”‚  å‘¨æœŸå®Ÿè¡Œãƒ«ãƒ¼ãƒ— â”‚
              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                     â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Step2-7: ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚µã‚¤ã‚¯ãƒ«         â”‚
    â”‚   foreachï¼ˆå„PLCï¼‰:                   â”‚
    â”‚   â”œâ”€ Step2: ãƒ•ãƒ¬ãƒ¼ãƒ æ§‹ç¯‰               â”‚
    â”‚   â”œâ”€ Step3: PLCæ¥ç¶š                   â”‚
    â”‚   â”œâ”€ Step4: ãƒ‡ãƒ¼ã‚¿é€å—ä¿¡               â”‚
    â”‚   â”œâ”€ Step6: ãƒ‡ãƒ¼ã‚¿è§£æ                 â”‚
    â”‚   â”œâ”€ Step5: åˆ‡æ–­                      â”‚
    â”‚   â””â”€ Step7: JSONå‡ºåŠ›                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“ï¼ˆã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã‚‚ç¶™ç¶šï¼‰
                PeriodicTimerå¾…æ©Ÿ
                     â”‚
                     â†“ï¼ˆintervalçµŒéå¾Œï¼‰
                Step2-7å†å®Ÿè¡Œ
                     â”‚
                     â†“ï¼ˆç„¡é™ãƒ«ãƒ¼ãƒ—ï¼‰
                     â‹®

             ï¼ˆCtrl+Cã§åœæ­¢ã‚·ã‚°ãƒŠãƒ«ï¼‰
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   é©åˆ‡ãªçµ‚äº†å‡¦ç†                                    â”‚
â”‚  ApplicationController.StopAsync()                                 â”‚
â”‚  â”œâ”€ ConfigurationWatcheråœæ­¢                                       â”‚
â”‚  â”œâ”€ ãƒªã‚½ãƒ¼ã‚¹è§£æ”¾                                                    â”‚
â”‚  â””â”€ æ¥ç¶šåˆ‡æ–­                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
              ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†
```

---

**æœ€çµ‚æ›´æ–°:** 2025-12-02
**å¯¾è±¡èª­è€…:** C#åˆå­¦è€…
**æ¨å¥¨å­¦ç¿’é †åº:**
1. C#ã®åŸºæœ¬æ–‡æ³•ï¼ˆå¤‰æ•°ã€å‹ã€åˆ¶å¾¡æ§‹æ–‡ï¼‰
2. ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæŒ‡å‘ï¼ˆã‚¯ãƒ©ã‚¹ã€ç¶™æ‰¿ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼‰
3. ä¾å­˜æ€§æ³¨å…¥ï¼ˆDIï¼‰ã¨DIã‚³ãƒ³ãƒ†ãƒŠã®æ¦‚å¿µ
4. éåŒæœŸå‡¦ç†ï¼ˆasync/awaitï¼‰
5. .NET Coreã®ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ãƒ¢ãƒ‡ãƒ«ï¼ˆIHostã€BackgroundServiceï¼‰
6. LINQ
7. æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ç†è§£

**é‡è¦ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰:**
- **DIã‚³ãƒ³ãƒ†ãƒŠ**: ä¾å­˜æ€§ã‚’è‡ªå‹•çš„ã«è§£æ±ºã—æ³¨å…¥ã™ã‚‹ä»•çµ„ã¿
- **Singleton**: ã‚¢ãƒ—ãƒªå…¨ä½“ã§1ã¤ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å…±æœ‰
- **Transient**: è¦æ±‚ã”ã¨ã«æ–°ã—ã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆ
- **BackgroundService**: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ç¶™ç¶šå®Ÿè¡Œã•ã‚Œã‚‹ã‚µãƒ¼ãƒ“ã‚¹
- **PeriodicTimer**: å‘¨æœŸçš„ã«å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ã‚¿ã‚¤ãƒãƒ¼
- **appsettings.json**: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
- **IOptions<T>**: è¨­å®šã‚’C#ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦æ³¨å…¥ã™ã‚‹ä»•çµ„ã¿

---

## Phase12 å®Ÿè£…å¤‰æ›´ç‚¹ï¼ˆé‡è¦ï¼‰

### å¤‰æ›´æ¦‚è¦

Phase12æ’ä¹…å¯¾ç­–ã«ã‚ˆã‚Šã€`ProcessedDeviceRequestInfo`ã‹ã‚‰`ReadRandomRequestInfo`ã¸ç§»è¡Œã—ã¾ã—ãŸã€‚ã“ã‚Œã¯ReadRandom(0x0403)ã‚³ãƒãƒ³ãƒ‰å°‚ç”¨ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆæƒ…å ±ã‚¯ãƒ©ã‚¹ã¨ã—ã¦ã€ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®è²¬å‹™ã‚’æ˜ç¢ºåŒ–ã™ã‚‹ãŸã‚ã®å¤‰æ›´ã§ã™ã€‚

### ä¸»ãªå¤‰æ›´å†…å®¹

#### 1. æ–°è¦ã‚¯ãƒ©ã‚¹: ReadRandomRequestInfo

**ãƒ•ã‚¡ã‚¤ãƒ«**: `andon/Core/Models/ReadRandomRequestInfo.cs`

```csharp
public class ReadRandomRequestInfo
{
    // èª­ã¿å‡ºã—å¯¾è±¡ãƒ‡ãƒã‚¤ã‚¹ä»•æ§˜ãƒªã‚¹ãƒˆï¼ˆè¤‡æ•°ãƒ‡ãƒã‚¤ã‚¹å‹æ··åœ¨å¯¾å¿œï¼‰
    public List<DeviceSpecification> DeviceSpecifications { get; set; }

    // ãƒ•ãƒ¬ãƒ¼ãƒ å‹ï¼ˆ3E/4Eï¼‰
    public FrameType FrameType { get; set; }

    // è¦æ±‚æ—¥æ™‚ï¼ˆUTCï¼‰
    public DateTime RequestedAt { get; set; }
}
```

**ç‰¹å¾´**:
- ReadRandom(0x0403)å°‚ç”¨ã®è¨­è¨ˆ
- è¤‡æ•°ãƒ‡ãƒã‚¤ã‚¹å‹æ··åœ¨å¯¾å¿œ
- ä¸é€£ç¶šã‚¢ãƒ‰ãƒ¬ã‚¹æŒ‡å®šã«å¯¾å¿œ

#### 2. ExecutionOrchestrator ã®å¤‰æ›´

**ãƒ•ã‚¡ã‚¤ãƒ«**: `andon/Core/Controllers/ExecutionOrchestrator.cs`

**å¤‰æ›´ç®‡æ‰€**: `ExecuteMultiPlcCycleAsync_Internal()`ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆline 199-213ï¼‰

```csharp
// Phase12æ’ä¹…å¯¾ç­–: ReadRandomRequestInfoç”Ÿæˆ
var readRandomRequestInfo = new ReadRandomRequestInfo
{
    DeviceSpecifications = config.Devices?.ToList() ?? new List<DeviceSpecification>(),
    FrameType = config.FrameVersion == "4E" ? FrameType.Frame4E : FrameType.Frame3E,
    RequestedAt = DateTime.UtcNow
};

// ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¿½åŠ ï¼ˆPhase12å®Ÿæ©Ÿç¢ºèªç”¨ï¼‰
Console.WriteLine($"[DEBUG] ReadRandomRequestInfo created:");
Console.WriteLine($"[DEBUG]   DeviceSpecifications.Count: {readRandomRequestInfo.DeviceSpecifications.Count}");
if (readRandomRequestInfo.DeviceSpecifications.Count > 0)
{
    Console.WriteLine($"[DEBUG]   First device: {readRandomRequestInfo.DeviceSpecifications[0].DeviceType}{readRandomRequestInfo.DeviceSpecifications[0].DeviceNumber}");
}
```

**é‡è¦ãªãƒã‚¤ãƒ³ãƒˆ**:
- nullã‚¬ãƒ¼ãƒ‰: `config.Devices?.ToList() ?? new List<DeviceSpecification>()`
- ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã§DeviceSpecifications.Countã‚’ç¢ºèªï¼ˆPhase9å®Ÿæ©Ÿã‚¨ãƒ©ãƒ¼å†ç™ºé˜²æ­¢ï¼‰

#### 3. PlcCommunicationManager ã®å¤‰æ›´

**ãƒ•ã‚¡ã‚¤ãƒ«**: `andon/Core/Managers/PlcCommunicationManager.cs`

**ExecuteFullCycleAsync()ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ­ãƒ¼ãƒ‰**:

1. **æ–°ã—ã„ç‰ˆï¼ˆæ¨å¥¨ï¼‰**: `ReadRandomRequestInfo`ã‚’å—ã‘å–ã‚‹ï¼ˆline 2623-2922ï¼‰
   ```csharp
   public async Task<FullCycleExecutionResult> ExecuteFullCycleAsync(
       ConnectionConfig connectionConfig,
       TimeoutConfig timeoutConfig,
       byte[] sendFrame,
       ReadRandomRequestInfo readRandomRequestInfo,  // â˜…æ–°ã—ã„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
       CancellationToken cancellationToken = default)
   ```

2. **å¤ã„ç‰ˆï¼ˆå¾Œæ–¹äº’æ›ï¼‰**: `ProcessedDeviceRequestInfo`ã‚’å—ã‘å–ã‚‹ï¼ˆline 2934-3212ï¼‰
   ```csharp
   public async Task<FullCycleExecutionResult> ExecuteFullCycleAsync(
       ConnectionConfig connectionConfig,
       TimeoutConfig timeoutConfig,
       byte[] sendFrame,
       ProcessedDeviceRequestInfo processedRequestInfo,  // â˜…å¤ã„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
       CancellationToken cancellationToken = default)
   ```

**ä¸€æ™‚çš„ãªå¤‰æ›ãƒ­ã‚¸ãƒƒã‚¯**:

æ–°ã—ã„ç‰ˆã®ExecuteFullCycleAsyncã§ã¯ã€ç¾åœ¨ã¯ä¸€æ™‚çš„ã«ProcessedDeviceRequestInfoã«å¤‰æ›ã—ã¦ã„ã¾ã™:

```csharp
// Phase12æ’ä¹…å¯¾ç­–: ReadRandomRequestInfoã‹ã‚‰ä¸€æ™‚çš„ã«ProcessedDeviceRequestInfoã‚’ç”Ÿæˆ
// TODO: Phase12.4-Step2ã§ExtractDeviceValuesã‚ªãƒ¼ãƒãƒ¼ãƒ­ãƒ¼ãƒ‰è¿½åŠ å¾Œã€ç›´æ¥å‡¦ç†ã«å¤‰æ›´
var tempProcessedRequestInfo = new ProcessedDeviceRequestInfo
{
    DeviceSpecifications = readRandomRequestInfo.DeviceSpecifications,
    FrameType = readRandomRequestInfo.FrameType,
    RequestedAt = readRandomRequestInfo.RequestedAt
};

fullCycleResult.BasicProcessedData = await ProcessReceivedRawData(
    fullCycleResult.ReceiveResult.ResponseData,
    tempProcessedRequestInfo,  // â˜…ä¸€æ™‚å¤‰æ›ã—ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½¿ç”¨
    cancellationToken);
```

**ä»Šå¾Œã®æ”¹å–„äºˆå®š**:
- Phase12.4-Step2: `ExtractDeviceValues()`ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ­ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã€ReadRandomRequestInfoã‚’ç›´æ¥å‡¦ç†ã™ã‚‹å®Ÿè£…ã«å¤‰æ›´äºˆå®š

### ProcessedDeviceRequestInfo ã®æ‰±ã„

**ç¾åœ¨ã®ä½ç½®ã¥ã‘**:
- âœ… ãƒ†ã‚¹ãƒˆç”¨é€”å°‚ç”¨ã¨ã—ã¦ä¿æŒï¼ˆTC029/TC037ã¨ã®äº’æ›æ€§ç¶­æŒï¼‰
- âŒ æœ¬ç•ªå®Ÿè£…ã§ã®ä½¿ç”¨ã¯éæ¨å¥¨
- ğŸ“¦ å°†æ¥çš„ã«ã¯ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã®ã¿ã§ä½¿ç”¨

### ç§»è¡Œã®åˆ©ç‚¹

1. **è²¬å‹™ã®æ˜ç¢ºåŒ–**: ReadRandom(0x0403)ã¨Read(0x0401)ã®è²¬å‹™ã‚’åˆ†é›¢
2. **è¤‡æ•°ãƒ‡ãƒã‚¤ã‚¹å‹æ··åœ¨å¯¾å¿œ**: ReadRandomå›ºæœ‰ã®ç‰¹æ€§ã«æœ€é©åŒ–
3. **ä¸é€£ç¶šã‚¢ãƒ‰ãƒ¬ã‚¹æŒ‡å®š**: ReadRandomã®ä»•æ§˜ã«é©åˆã—ãŸè¨­è¨ˆ
4. **ãƒ‡ãƒãƒƒã‚°å®¹æ˜“æ€§**: DeviceSpecificationsçŠ¶æ…‹ã‚’ç¢ºèªã™ã‚‹ãƒ­ã‚°è¿½åŠ 

### å®Ÿè£…æ™‚ã®æ³¨æ„ç‚¹

1. **nullã‚¬ãƒ¼ãƒ‰å¿…é ˆ**: `config.Devices?.ToList() ?? new List<DeviceSpecification>()`
2. **ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°æ´»ç”¨**: DeviceSpecifications.Countã‚’å¿…ãšç¢ºèª
3. **ãƒ•ãƒ¬ãƒ¼ãƒ å‹åˆ¤å®š**: config.FrameVersionã‹ã‚‰é©åˆ‡ã«åˆ¤å®š
4. **UTCæ™‚åˆ»ä½¿ç”¨**: RequestedAtã¯DateTime.UtcNowã‚’ä½¿ç”¨
