# 実装機能利用状況 調査結果

**調査日時**: 2025-12-02
**最終更新**: 2025-12-02（Phase3実装クラス詳細調査結果を統合、LoggingManager専用ログメソッド・Utilities層・Phase3未確認クラスの詳細調査完了）

## 📊 アプリケーション実行フロー

### 起動から終了までの流れ

```
Program.Main()
  ↓
CreateHostBuilder() - DI設定
  ↓
DependencyInjectionConfigurator.Configure()
  ↓
AndonHostedService.StartAsync()
  ↓
AndonHostedService.ExecuteAsync()
  ↓
ApplicationController.StartAsync()
  ├─ ExecuteStep1InitializationAsync()
  │   ├─ ConfigurationLoaderExcel.LoadAllPlcConnectionConfigs() (オプション)
  │   ├─ MultiPlcConfigManager.GetAllConfigurations()
  │   └─ PlcCommunicationManager (各PLC用にインスタンス作成)
  ├─ ConfigurationWatcher.StartWatchingExcel() (オプション)
  └─ StartContinuousDataCycleAsync()
      ↓
    ExecutionOrchestrator.RunContinuousDataCycleAsync()
      ├─ TimerService.StartPeriodicExecution() (周期実行開始)
      └─ ExecuteMultiPlcCycleAsync_Internal() (各サイクル)
          ├─ [Step2] ConfigToFrameManager.BuildReadRandomFrameFromConfig()
          ├─ [Step3-6] PlcCommunicationManager.ExecuteFullCycleAsync()
          │   ├─ ConnectAsync()
          │   ├─ SendFrameAsync()
          │   ├─ ReceiveResponseAsync()
          │   ├─ ProcessReceivedRawData()
          │   └─ DisconnectAsync()
          └─ [Step7] DataOutputManager.OutputToJson()

[終了時]
AndonHostedService.StopAsync()
  ↓
ApplicationController.StopAsync()
  └─ ConfigurationWatcher.StopWatching() (オプション)
```

---

## ✅ 実際に使用されているクラス・メソッド

### **Controllers層**

#### ApplicationController (andon/Core/Controllers/ApplicationController.cs)
- ✅ **StartAsync()** - 155行目
  - 呼び出し元: AndonHostedService.ExecuteAsync()
  - 役割: アプリケーション起動処理

- ✅ **StopAsync()** - 173行目
  - 呼び出し元: AndonHostedService.StopAsync()
  - 役割: アプリケーション終了処理

- ✅ **ExecuteStep1InitializationAsync()** - 62行目
  - 呼び出し元: ApplicationController.StartAsync()
  - 役割: Step1初期化（設定読み込み、PlcCommunicationManager生成）

- ✅ **StartContinuousDataCycleAsync()** - 133行目
  - 呼び出し元: ApplicationController.StartAsync()
  - 役割: 継続データサイクル開始

- ⚠️ **GetPlcManagers()** - 56行目
  - 呼び出し元: テストコードのみ
  - 役割: テスト用PlcManagerリスト取得
  - 備考: 実運用では未使用の可能性

- ⚠️ **HandleConfigurationChanged()** - 191行目 (private)
  - 呼び出し元: ConfigurationWatcherイベント
  - 役割: 設定ファイル変更時の動的再読み込み
  - 備考: 設定変更時のみ動作、TODO実装待ち

#### ExecutionOrchestrator (andon/Core/Controllers/ExecutionOrchestrator.cs)

**使用中のメソッド:**

- ✅ **RunContinuousDataCycleAsync()** - 83行目
  - 呼び出し元: ApplicationController.StartContinuousDataCycleAsync():148
  - 役割: 継続データサイクル実行（タイマー駆動）

- ✅ **GetMonitoringInterval()** - 73行目
  - 呼び出し元: ExecutionOrchestrator.RunContinuousDataCycleAsync():98
  - 役割: 監視間隔取得（MonitoringIntervalMs設定値）

- ✅ **ExecuteMultiPlcCycleAsync_Internal()** - 131行目 (private)
  - 呼び出し元: ExecutionOrchestrator.RunContinuousDataCycleAsync():103（周期実行）
  - 役割: 複数PLC並列実行の中核処理
  - 処理内容:
    - Step2: BuildReadRandomFrameFromConfig()
    - Step3-6: ExecuteFullCycleAsync()
    - Step7: OutputToJson()

- ✅ **ExecuteSingleCycleAsync()** - 116行目
  - 呼び出し元: テストコードのみ
  - 役割: ExecuteMultiPlcCycleAsync_Internal()のテスト用公開ラッパー
  - 備考: 本番コードでは未使用

**未使用メソッド:**

- ❌ **ExecuteMultiPlcCycleAsync()** - 264行目
  - 呼び出し元: なし
  - 役割: MultiPlcConfig使用の並列実行パターン
  - 備考: 別の実装パターン、現在のフローでは使用されていない

- ❌ **ExecuteSinglePlcAsync()** - 308行目 (private)
  - 呼び出し元: なし（ExecuteMultiPlcCycleAsyncからのみ呼び出し想定）
  - 役割: 単一PLC処理
  - 備考: ExecuteMultiPlcCycleAsyncが未使用のため、連鎖的に未使用

#### ConfigurationWatcher (andon/Core/Controllers/ConfigurationWatcher.cs)
- ✅ **StartWatchingExcel()**
  - 呼び出し元: ApplicationController.StartAsync():162
  - 役割: Excel設定ファイル監視開始

- ✅ **StopWatching()**
  - 呼び出し元: ApplicationController.StopAsync():180
  - 役割: 設定ファイル監視停止

---

### **Managers層**

#### ConfigToFrameManager (andon/Core/Managers/ConfigToFrameManager.cs)

**使用中のメソッド:**

- ✅ **BuildReadRandomFrameFromConfig(PlcConfiguration)** - 34行目/151行目（オーバーロード）
  - 呼び出し元: ExecutionOrchestrator.ExecuteMultiPlcCycleAsync_Internal():179
  - 役割: PlcConfigurationからReadRandomフレーム構築（Binary形式）
  - 備考: Binary/ASCII自動判定あり

**条件付き使用メソッド:**

- ⚠️ **BuildReadRandomFrameFromConfigAscii()** - 82行目/125行目（オーバーロード）
  - 呼び出し元: PlcConfiguration.IsBinary=false時に使用される可能性
  - 役割: ASCII形式ReadRandomフレーム構築
  - 備考: 設定に依存、実際の使用状況は設定ファイル次第

**内部メソッド:**

- ✅ **ConvertTimeoutMsToSlmpUnit()** - 23行目 (private)
  - 役割: タイムアウト値のSLMP単位変換

#### PlcCommunicationManager (andon/Core/Managers/PlcCommunicationManager.cs)

**メインフロー使用メソッド:**

- ✅ **ExecuteFullCycleAsync()** - 2622行目
  - 呼び出し元: ExecutionOrchestrator.ExecuteMultiPlcCycleAsync_Internal():207
  - 役割: Step3-6完全サイクル実行（接続→送信→受信→処理→切断）

- ✅ **ConnectAsync()** - 81行目
  - 呼び出し元: ExecuteFullCycleAsync()内
  - 役割: Step3 PLC接続

- ✅ **SendFrameAsync()** - 360行目
  - 呼び出し元: ExecuteFullCycleAsync()内
  - 役割: Step4 フレーム送信

- ✅ **ReceiveResponseAsync()** - 705行目
  - 呼び出し元: ExecuteFullCycleAsync()内
  - 役割: Step5 応答受信

- ✅ **ProcessReceivedRawData()** - 893行目
  - 呼び出し元: ExecuteFullCycleAsync()内
  - 役割: Step6 データ処理（前処理）

- ✅ **DisconnectAsync()** - 812行目
  - 呼び出し元: ExecuteFullCycleAsync()内
  - 役割: PLC切断

- ✅ **ParseRawToStructuredData()** - 2096行目
  - 呼び出し元: ProcessReceivedRawData()内
  - 役割: Rawデータを構造化データに変換

**内部処理メソッド（使用中）:**

- ✅ **DetectResponseFrameType()** - 1240行目
- ✅ **ValidateSlmpFrameStructure()** - 1404行目
- ✅ **Parse3EFrameStructure() / Parse4EFrameStructure()** - 1492/1537行目
- ✅ **Parse3EFrameAscii() / Parse4EFrameAscii()** - 1596/1636行目
- ✅ **ExtractDeviceValues()** - 1920行目
- ✅ **ApplyBitExpansion()** - 1063行目
- ✅ **ProcessSingleStructure()** - 2255行目
- ✅ その他多数のprivateメソッド

**未使用または条件付きメソッド:**

- ⚠️ **ExecuteStep3to5CycleAsync()** - 2452行目
  - 呼び出し元: なし（現在のフローでは未使用）
  - 役割: Step3-5サイクル実行（別の実行パターン用？）
  - 備考: Phase2の別実装パターンの可能性

- ⚠️ **SendMultipleFramesAsync()** - 466行目
  - 呼び出し元: なし
  - 役割: 複数フレーム連続送信
  - 備考: 将来の拡張機能の可能性

- ⚠️ **GetConnectionStats()** - 2911行目
  - 呼び出し元: なし
  - 役割: 接続統計情報取得
  - 備考: 監視・統計機能用（未実装）

- ⚠️ **GetLastOperationResult()** - 2921行目
  - 呼び出し元: なし
  - 役割: 最終操作結果取得
  - 備考: デバッグ・監視用（未実装）

#### DataOutputManager (andon/Core/Managers/DataOutputManager.cs)

**使用中のメソッド:**

- ✅ **OutputToJson()** - 32行目
  - 呼び出し元: ExecutionOrchestrator.ExecuteMultiPlcCycleAsync_Internal():232
  - 役割: Step7 JSONファイル出力

**内部メソッド（使用中）:**

- ✅ **ValidateInputData()** - 155行目
  - 呼び出し元: OutputToJson()内
  - 役割: 入力データ検証

- ✅ **AddBitDeviceItems()** - 214行目
  - 呼び出し元: OutputToJson()内
  - 役割: ビットデバイスのJSONアイテム追加

- ✅ **AddWordDeviceItem()** - 260行目
  - 呼び出し元: OutputToJson()内
  - 役割: ワードデバイスのJSONアイテム追加

- ✅ **GetDeviceConfigInfo()** - 290行目
  - 呼び出し元: AddBitDeviceItems(), AddWordDeviceItem()内
  - 役割: デバイス設定情報取得

- ✅ **ExtractBit()** - 307行目
  - 呼び出し元: AddBitDeviceItems()内
  - 役割: ビット抽出処理

- ✅ **ConvertValue()** - 315行目
  - 呼び出し元: AddWordDeviceItem()内
  - 役割: 値の型変換

#### LoggingManager (andon/Core/Managers/LoggingManager.cs)

**頻繁に使用されるメソッド:**

- ✅ **LogInfo()** - 215行目
  - 呼び出し元: 多数（ApplicationController, ExecutionOrchestrator等）
  - 役割: Infoレベルログ出力

- ✅ **LogError()** - 239行目
  - 呼び出し元: 多数（エラーハンドリング箇所）
  - 役割: Errorレベルログ出力

- ✅ **LogDebug()** - 260行目
  - 呼び出し元: ExecutionOrchestrator等（詳細ログ）
  - 役割: Debugレベルログ出力

- ✅ **LogWarning()** - 227行目
  - 呼び出し元: ApplicationController等
  - 役割: Warningレベルログ出力

**テストコードのみで使用される専用ログメソッド:**

- ❌ **LogDataAcquisition()** - 292行目
  - 呼び出し元: LoggingManagerTests_Phase7.cs（テストのみ）
  - 役割: データ取得専用ログ
  - 備考: 本番コードでは未使用

- ❌ **LogFrameSent()** - 316行目
  - 呼び出し元: LoggingManagerTests_Phase7.cs（テストのみ）
  - 役割: フレーム送信専用ログ
  - 備考: 本番コードでは未使用

- ❌ **LogResponseReceived()** - 332行目
  - 呼び出し元: LoggingManagerTests_Phase7.cs（テストのみ）
  - 役割: 応答受信専用ログ
  - 備考: 本番コードでは未使用

- ❌ **LogPlcProcessStart()** - 388行目
  - 呼び出し元: LoggingManagerTests.cs（テストのみ）
  - 役割: PLC処理開始専用ログ
  - 備考: 本番コードでは未使用

- ❌ **LogPlcProcessComplete()** - 398行目
  - 呼び出し元: LoggingManagerTests.cs（テストのみ）
  - 役割: PLC処理完了専用ログ
  - 備考: 本番コードでは未使用

- ❌ **LogPlcCommunicationError()** - 408行目
  - 呼び出し元: LoggingManagerTests.cs（テストのみ）
  - 役割: PLC通信エラー専用ログ
  - 備考: 本番コードでは未使用

**内部メソッド:**

- ✅ **WriteToFileAsync()** - 96行目 (private)
- ✅ **ShouldLog()** - 91行目 (private)
- ✅ **CheckAndRotateFileAsync()** - 121行目 (private)
- ✅ **RotateLogFileAsync()** - 148行目 (private)

#### ErrorHandler (andon/Core/Managers/ErrorHandler.cs)

**使用状況不明（要追加調査）:**

- ⚠️ **DetermineErrorCategory()** - 12行目
  - 呼び出し元: 不明（DI登録されているが呼び出し箇所未発見）
  - 役割: エラーカテゴリ判定

- ⚠️ **ShouldRetry()** - 32行目
  - 呼び出し元: 不明
  - 役割: リトライ可否判定

- ⚠️ **GetMaxRetryCount()** - 52行目
  - 呼び出し元: 不明
  - 役割: 最大リトライ回数取得

- ⚠️ **GetRetryDelayMs()** - 68行目
  - 呼び出し元: 不明
  - 役割: リトライ遅延時間取得

**備考**: DependencyInjectionConfiguratorでSingleton登録されているが、実際の使用箇所が確認できず。Phase3実装待ちの可能性。

#### ResourceManager (andon/Core/Managers/ResourceManager.cs)

**使用状況不明（要追加調査）:**

- ⚠️ **GetCurrentMemoryUsageMb()** - 32行目
  - 呼び出し元: 不明（DI登録されているが呼び出し箇所未発見）
  - 役割: 現在のメモリ使用量取得

- ⚠️ **GetMemoryLevel()** - 48行目
  - 呼び出し元: 不明
  - 役割: メモリレベル判定

- ⚠️ **ForceGarbageCollection()** - 74行目
  - 呼び出し元: 不明
  - 役割: 強制GC実行

**備考**: DependencyInjectionConfiguratorでSingleton登録されているが、実際の使用箇所が確認できず。Phase3実装待ちの可能性。

#### MultiPlcConfigManager (andon/Core/Managers/MultiConfigManager.cs)

**使用中のメソッド:**

- ✅ **GetAllConfigurations()** - 84行目
  - 呼び出し元: ApplicationController.ExecuteStep1InitializationAsync():85
  - 役割: 全設定取得

- ⚠️ **AddConfiguration()** - 24行目
  - 呼び出し元: ConfigurationLoaderExcel（推測）
  - 役割: 設定追加

- ⚠️ **AddConfigurations()** - 43行目
  - 呼び出し元: ConfigurationLoaderExcel（推測）
  - 役割: 複数設定一括追加

**未使用の可能性があるメソッド:**

- ❌ **GetConfiguration(string)** - 59行目
  - 呼び出し元: なし
  - 役割: 名前で設定取得

- ❌ **HasConfiguration()** - 75行目
  - 呼び出し元: なし
  - 役割: 設定存在確認

- ❌ **GetAllConfigurationNames()** - 92行目
  - 呼び出し元: なし
  - 役割: 全設定名取得

- ❌ **GetConfigurationCount()** - 100行目
  - 呼び出し元: なし
  - 役割: 設定数取得

- ❌ **Clear()** - 108行目
  - 呼び出し元: なし
  - 役割: 全設定クリア

- ❌ **RemoveConfiguration()** - 118行目
  - 呼び出し元: なし
  - 役割: 特定設定削除

- ❌ **GetStatistics()** - 135行目
  - 呼び出し元: なし
  - 役割: 統計情報取得

#### MultiPlcCoordinator (andon/Core/Managers/MultiPlcCoordinator.cs)

**完全未使用:**

- ❌ **ExecuteParallelAsync()** - 24行目
  - 呼び出し元: なし（ExecutionOrchestrator.ExecuteMultiPlcCycleAsync():274で参照されるが、そのメソッド自体が未使用）
  - 役割: 並列実行制御

- ❌ **ExecuteSequentialAsync()** - 65行目
  - 呼び出し元: なし（同上）
  - 役割: 順次実行制御

**備考**: MultiPlcCoordinatorクラス全体が現在のフローでは使用されていない。別の並列実行パターン用の実装。

---

### **Services層**

#### AndonHostedService (andon/Services/AndonHostedService.cs)
- ✅ **StartAsync()** - 22行目
  - 呼び出し元: .NET Generic Host（自動）
  - 役割: サービス開始

- ✅ **ExecuteAsync()** - 28行目
  - 呼び出し元: .NET Generic Host（自動）
  - 役割: バックグラウンド実行

- ✅ **StopAsync()** - 45行目
  - 呼び出し元: .NET Generic Host（自動）
  - 役割: サービス停止

#### DependencyInjectionConfigurator (andon/Services/DependencyInjectionConfigurator.cs)
- ✅ **Configure()** - 20行目
  - 呼び出し元: Program.CreateHostBuilder():31
  - 役割: DIコンテナ設定

#### TimerService (andon/Services/TimerService.cs)
- ✅ **StartPeriodicExecution()**
  - 呼び出し元: ExecutionOrchestrator.RunContinuousDataCycleAsync():102
  - 役割: 周期実行タイマー開始

#### Phase3実装クラス（調査完了：すべて完全に未使用）

以下のクラスはDI登録されているが、実際の本番コードでの呼び出し箇所なし:

- ❌ **GracefulShutdownHandler** (andon/Services/GracefulShutdownHandler.cs)
  - DI登録: Singleton (DependencyInjectionConfigurator:44)
  - 呼び出し元: なし
  - 役割: 適切な終了処理・リソース解放
  - 備考: Phase3実装済み、本番コード未使用（テストコードのみ）

- ❌ **AsyncExceptionHandler** (andon/Services/AsyncExceptionHandler.cs)
  - DI登録: Singleton (DependencyInjectionConfigurator:41)
  - 呼び出し元: なし
  - 役割: 階層的例外ハンドリング
  - 備考: Phase3実装済み、本番コード未使用（テストコードのみ）

- ❌ **CancellationCoordinator** (andon/Services/CancellationCoordinator.cs)
  - DI登録: Singleton (DependencyInjectionConfigurator:42)
  - 呼び出し元: なし
  - 役割: キャンセレーション制御
  - 備考: Phase3実装済み、本番コード未使用（テストコードのみ）

- ❌ **ResourceSemaphoreManager** (andon/Services/ResourceSemaphoreManager.cs)
  - DI登録: Singleton (DependencyInjectionConfigurator:43)
  - 呼び出し元: なし
  - 役割: 共有リソース排他制御
  - 備考: Phase3実装済み、本番コード未使用（テストコードのみ）

- ❌ **ProgressReporter** (andon/Services/ProgressReporter.cs)
  - DI登録: Transient (DependencyInjectionConfigurator:73)
  - 呼び出し元: なし
  - 役割: 進捗報告
  - 備考: Phase3実装済み、本番コード未使用（テストコードのみ）

- ❌ **ParallelExecutionController** (andon/Services/ParallelExecutionController.cs)
  - DI登録: Transient (DependencyInjectionConfigurator:74)
  - 呼び出し元: なし
  - 役割: 並行実行制御
  - 備考: Phase3実装済み、本番コード未使用（テストコードのみ）

**未確認クラス（調査完了）:**

- ❌ **OptionsConfigurator** (andon/Services/OptionsConfigurator.cs)
  - DI登録: なし
  - 呼び出し元: なし
  - 役割: Optionsパターン設定
  - 備考: クラス定義のみで完全に未使用

- ❌ **ServiceLifetimeManager** (andon/Services/ServiceLifetimeManager.cs)
  - DI登録: なし
  - 呼び出し元: なし
  - 役割: サービスライフタイム管理
  - 備考: クラス定義のみで完全に未使用

- ❌ **MultiConfigDIIntegration** (andon/Services/MultiConfigDIIntegration.cs)
  - インターフェース: IMultiConfigDIIntegration
  - DI登録: なし
  - 呼び出し元: なし
  - 役割: 複数設定DI統合
  - 備考: クラス定義のみで完全に未使用

---

### **Utilities層**

#### 使用中のクラス

- ✅ **SlmpFrameBuilder** (andon/Utilities/SlmpFrameBuilder.cs)
  - 呼び出し元: ConfigToFrameManager (62, 110, 136, 162行目), ExecutionOrchestrator (344行目)
  - 役割: SLMPフレーム構築
  - 使用メソッド: BuildReadRandomRequest(), BuildReadRandomRequestAscii()

- ✅ **BitExpansionUtility** (andon/Utilities/BitExpansionUtility.cs)
  - 呼び出し元: PlcCommunicationManager (1118行目)
  - 役割: ワードをビット展開
  - 使用メソッド: ExpandWordToBits()

- ✅ **TerminalOutputHelper** (andon/Utilities/TerminalOutputHelper.cs)
  - 呼び出し元: PlcCommunicationManager (400, 760, 779行目), VerifyFix.cs (43行目)
  - 役割: デバッグ用ターミナル出力
  - 使用メソッド: LogSendFrame(), LogReceiveFrame(), AnalyzeReceivedData(), Parse4EFrame()

#### 未使用のクラス

- ❌ **SlmpDataParser** (andon/Utilities/SlmpDataParser.cs)
  - 呼び出し元: なし
  - 役割: SLMPデータパース（将来実装予定？）
  - 備考: クラス定義のみで使用箇所なし

- ❌ **DataConverter** (andon/Utilities/DataConverter.cs)
  - 呼び出し元: なし
  - 役割: データ変換ユーティリティ
  - 備考: クラス定義のみで使用箇所なし

- ❌ **DeviceAddressParser** (andon/Utilities/DeviceAddressParser.cs)
  - 呼び出し元: なし
  - 役割: デバイスアドレス解析
  - 備考: クラス定義のみで使用箇所なし

- ❌ **HexStringFormatter** (andon/Utilities/HexStringFormatter.cs)
  - 呼び出し元: なし
  - 役割: 16進数文字列フォーマット
  - 備考: クラス定義のみで使用箇所なし

---

### **Infrastructure層**

#### ConfigurationLoaderExcel
- ✅ **LoadAllPlcConnectionConfigs()**
  - 呼び出し元: ApplicationController.ExecuteStep1InitializationAsync():75
  - 役割: Excel設定ファイル読み込み

---

## ❌ 明確に未使用のメソッド・クラス

### 1. ExecutionOrchestrator関連
| メソッド | 行番号 | 理由 |
|---------|--------|------|
| ExecuteMultiPlcCycleAsync() | 264 | 別の並列実行パターン用、現在のフローでは未使用 |
| ExecuteSinglePlcAsync() (private) | 308 | 上記メソッド専用のため連鎖的に未使用 |

### 2. MultiPlcCoordinator（クラス全体未使用）
| メソッド | 行番号 | 理由 |
|---------|--------|------|
| ExecuteParallelAsync() | 24 | 並列実行制御、現在のフローでは未使用 |
| ExecuteSequentialAsync() | 65 | 順次実行制御、現在のフローでは未使用 |

### 3. PlcCommunicationManager
| メソッド | 行番号 | 理由 |
|---------|--------|------|
| ExecuteStep3to5CycleAsync() | 2452 | Phase2別実装パターン？ 現在のフローでは未使用 |
| SendMultipleFramesAsync() | 466 | 複数フレーム送信、将来の拡張機能？ |
| GetConnectionStats() | 2911 | 統計取得、監視機能未実装 |
| GetLastOperationResult() | 2921 | 結果取得、監視機能未実装 |

### 4. MultiPlcConfigManager
| メソッド | 行番号 | 理由 |
|---------|--------|------|
| GetConfiguration(string) | 59 | 名前指定取得、現在未使用 |
| HasConfiguration() | 75 | 存在確認、現在未使用 |
| GetAllConfigurationNames() | 92 | 名前一覧取得、現在未使用 |
| GetConfigurationCount() | 100 | 件数取得、現在未使用 |
| Clear() | 108 | クリア処理、現在未使用 |
| RemoveConfiguration() | 118 | 削除処理、現在未使用 |
| GetStatistics() | 135 | 統計取得、現在未使用 |

---

## 🔍 Phase3実装クラス 詳細調査結果

「使用状況不明（要確認）」とされていた以下のクラスについて、詳細に調査しました：

### 調査対象クラス
1. ErrorHandler
2. ResourceManager
3. AsyncExceptionHandler
4. GracefulShutdownHandler
5. CancellationCoordinator
6. ResourceSemaphoreManager
7. ProgressReporter
8. ParallelExecutionController

---

### 1. ErrorHandler（andon/Core/Managers/ErrorHandler.cs）

#### クラス概要
- **実装インターフェース**: IErrorHandler
- **DI登録**: Singleton (DependencyInjectionConfigurator:36)
- **役割**: エラーカテゴリ判定とリトライ制御

#### 実装メソッド
| メソッド | 役割 |
|---------|------|
| DetermineErrorCategory(Exception) | 例外からエラーカテゴリを判定 |
| ShouldRetry(ErrorCategory) | リトライ可否判定 |
| GetMaxRetryCount(ErrorCategory) | 最大リトライ回数取得 |
| GetRetryDelayMs(ErrorCategory) | リトライ遅延時間取得 |

#### 使用状況
⚠️ **実装完了だが統合未完了**
- ErrorHandler自体は実装されており、AsyncExceptionHandlerに注入されている
- しかし、AsyncExceptionHandlerが実際のアプリケーションフローで使用されていない
- **Phase3の例外ハンドリング機能が未統合**

**使用フロー:**
```
ErrorHandler (IErrorHandler実装)
  ↓ (DI注入)
AsyncExceptionHandler (依存注入で受け取る)
  ↓ (ただし、AsyncExceptionHandler自体が未使用)
（使用されていない）
```

---

### 2. AsyncExceptionHandler（andon/Services/AsyncExceptionHandler.cs）

#### クラス概要
- **実装インターフェース**: IAsyncExceptionHandler
- **DI登録**: Singleton (DependencyInjectionConfigurator:41)
- **役割**: 階層的例外ハンドリング
- **依存**: ILoggingManager, IErrorHandler

#### 実装メソッド
| メソッド | 役割 |
|---------|------|
| HandleCriticalOperationAsync<T>() | クリティカル操作の例外ハンドリング |
| HandleGeneralOperationsAsync() | 一般操作群の例外ハンドリング |

#### 使用状況
❌ **完全に未使用**
- IAsyncExceptionHandlerインターフェースの参照箇所: 定義と実装のみ
- クラスの直接参照: DI登録とテストコードのみ
- 実際のアプリケーションコードでの使用: **なし**

---

### 3. GracefulShutdownHandler（andon/Services/GracefulShutdownHandler.cs）

#### クラス概要
- **実装インターフェース**: なし（具象クラスとして登録）
- **DI登録**: Singleton (DependencyInjectionConfigurator:44)
- **役割**: 適切な終了処理・リソース解放
- **依存**: ILoggingManager

#### 実装メソッド
| メソッド | 役割 |
|---------|------|
| ExecuteGracefulShutdown(IApplicationController, TimeSpan) | 適切な終了処理実行 |

#### 使用状況
❌ **完全に未使用**

**現在の終了処理:**
```
AndonHostedService.StopAsync() (45行目)
  ↓
ApplicationController.StopAsync() (173行目)
  ↓
ConfigurationWatcher.StopWatching() (180行目)
```
GracefulShutdownHandlerは**使用されていない**。

---

### 4. CancellationCoordinator（andon/Services/CancellationCoordinator.cs）

#### クラス概要
- **実装インターフェース**: ICancellationCoordinator
- **DI登録**: Singleton (DependencyInjectionConfigurator:42)
- **役割**: キャンセレーション制御
- **依存**: ILoggingManager

#### 使用状況
❌ **完全に未使用**
- ICancellationCoordinatorインターフェースの使用箇所なし
- 実際のキャンセル処理は各メソッドで`CancellationToken`を直接使用

---

### 5. ResourceSemaphoreManager（andon/Services/ResourceSemaphoreManager.cs）

#### クラス概要
- **実装インターフェース**: IResourceSemaphoreManager
- **DI登録**: Singleton (DependencyInjectionConfigurator:43)
- **役割**: 共有リソース排他制御

#### 使用状況
❌ **完全に未使用**
- IResourceSemaphoreManagerインターフェースの使用箇所なし
- 排他制御が必要な箇所で使用されていない

---

### 6. ResourceManager（andon/Core/Managers/ResourceManager.cs）

#### クラス概要
- **実装インターフェース**: なし（具象クラスとして登録）
- **DI登録**: Singleton (DependencyInjectionConfigurator:38)
- **役割**: メモリ・リソース管理
- **依存**: IOptions<SystemResourcesConfig>

#### 実装メソッド
| メソッド | 役割 |
|---------|------|
| GetCurrentMemoryUsageMb() | 現在のメモリ使用量取得 |
| GetMemoryLevel() | メモリレベル判定 |
| ForceGarbageCollection() | 強制GC実行 |

#### 使用状況
❌ **完全に未使用**
- DI登録のみで、実際のコードからの参照なし
- メモリ監視機能が実装されていない

---

### 7. ProgressReporter（andon/Services/ProgressReporter.cs）

#### クラス概要
- **実装インターフェース**: IProgressReporter<T>
- **DI登録**: Transient (DependencyInjectionConfigurator:73)
- **役割**: 進捗報告

#### 使用状況
❌ **完全に未使用**
- IProgressReporter<ProgressInfo>の使用箇所なし
- 進捗報告機能が実装されていない

---

### 8. ParallelExecutionController（andon/Services/ParallelExecutionController.cs）

#### クラス概要
- **実装インターフェース**: IParallelExecutionController
- **DI登録**: Transient (DependencyInjectionConfigurator:74)
- **役割**: 並行実行制御

#### 使用状況
❌ **完全に未使用**
- IParallelExecutionControllerの使用箇所なし
- 現在の並列実行は別の仕組み（ExecutionOrchestrator.ExecuteMultiPlcCycleAsync_Internalのforeachループ）で実装

---

### Phase3実装クラス 使用状況マトリクス

| クラス | DI登録 | インターフェース | テストコード | 本番コード使用 | 統合状態 |
|--------|--------|-----------------|-------------|--------------|---------|
| ErrorHandler | ✅ | ✅ IErrorHandler | ✅ | ⚠️ 間接的（AsyncExceptionHandler経由、ただし未使用） | 🔴 未統合 |
| AsyncExceptionHandler | ✅ | ✅ IAsyncExceptionHandler | ✅ | ❌ | 🔴 未統合 |
| GracefulShutdownHandler | ✅ | ❌ | ✅ | ❌ | 🔴 未統合 |
| CancellationCoordinator | ✅ | ✅ ICancellationCoordinator | ✅ | ❌ | 🔴 未統合 |
| ResourceSemaphoreManager | ✅ | ✅ IResourceSemaphoreManager | ✅ | ❌ | 🔴 未統合 |
| ResourceManager | ✅ | ❌ | ❌ | ❌ | 🔴 未統合 |
| ProgressReporter | ✅ | ✅ IProgressReporter<T> | ✅ | ❌ | 🔴 未統合 |
| ParallelExecutionController | ✅ | ✅ IParallelExecutionController | ✅ | ❌ | 🔴 未統合 |

**統合状態の凡例:**
- 🟢 **完全統合**: 実際のアプリケーションフローで使用中
- 🟡 **部分統合**: 一部のフローで使用されているが、完全統合されていない
- 🔴 **未統合**: DI登録とテストのみで、本番コードで使用されていない

---

### Phase3実装の背景

#### 設計上の理由
これらのクラスは**Phase3実装計画**として設計されたものであり、以下のドキュメントに記載されている:
- `documents/design/本体クラス実装/実装計画/Phase3_高度な機能.md`
- Phase3の目標: 階層的例外ハンドリング、並行実行制御、進捗報告、リソース管理等

#### 実装順序
1. **Phase1**: 最小動作環境構築（Step1-7基本フロー）- ✅ 完了
2. **Phase2**: 実運用対応（複数PLC、設定管理）- ✅ 完了
3. **Phase3**: 高度な機能（例外ハンドリング、並行実行等）- ⚠️ **実装済みだが統合待ち**

#### Phase3統合の遅延理由
Phase3クラスが実装されているが、以下の理由で統合が進んでいない可能性:
1. Phase1/Phase2の実装とテストに注力
2. Phase3統合の優先度が低い
3. Phase3統合計画が未策定
4. 既存コードのリファクタリング待ち

---

### Phase3機能の目的

Phase3実装クラスは、以下のような高度な機能を提供するために設計されました:

1. **階層的例外ハンドリング** (AsyncExceptionHandler + ErrorHandler)
   - エラーカテゴリ別のリトライロジック
   - 操作レベルでの例外捕捉と記録

2. **適切なシャットダウン** (GracefulShutdownHandler)
   - タイムアウト付き終了処理
   - リソースの適切な解放

3. **統一的なキャンセル制御** (CancellationCoordinator)
   - 複数の処理のキャンセル管理
   - 階層的なキャンセルトークン管理

4. **リソース管理** (ResourceManager + ResourceSemaphoreManager)
   - メモリ使用量の監視
   - 共有リソースの排他制御

5. **進捗報告** (ProgressReporter)
   - 長時間処理の進捗表示
   - パラレル処理の進捗集約

6. **並行実行制御** (ParallelExecutionController)
   - 複数PLC処理の並行実行
   - スレッドプールの管理

---

### 💡 Phase3実装クラスの結論

**8つすべてのクラスが「実装完了だが未統合」状態**

1. **実装状況**: ✅ すべてのクラスが実装済み
2. **テスト状況**: ✅ 単体テストが実装済み（ResourceManager除く）
3. **DI登録**: ✅ すべてDependencyInjectionConfiguratorに登録済み
4. **統合状況**: ❌ **実際のアプリケーションフローに統合されていない**

---

### 詳細調査完了項目（2025-12-02追加調査）

#### LoggingManager専用ログメソッド
**調査結果**: ❌ すべてテストコードのみで使用、本番コードでは未使用
- LogDataAcquisition() - LoggingManagerTests_Phase7.cs
- LogFrameSent() - LoggingManagerTests_Phase7.cs
- LogResponseReceived() - LoggingManagerTests_Phase7.cs
- LogPlcProcessStart() - LoggingManagerTests.cs
- LogPlcProcessComplete() - LoggingManagerTests.cs
- LogPlcCommunicationError() - LoggingManagerTests.cs

**結論**: これらのメソッドは実装およびテストは完了しているが、実際のアプリケーションフローには統合されていない。Phase3統合待ちまたは将来の拡張機能用と考えられる。

#### Utilities層
**調査結果**:
- ✅ **使用中（3クラス）**: SlmpFrameBuilder, BitExpansionUtility, TerminalOutputHelper
- ❌ **未使用（4クラス）**: SlmpDataParser, DataConverter, DeviceAddressParser, HexStringFormatter

**結論**: 7クラス中3クラスが実際に使用されており、4クラスは実装済みだが未使用。未使用クラスは将来の拡張機能用またはリファクタリング時の代替実装として保持されている可能性がある。

#### Phase3未確認クラス
**調査結果**: ❌ すべて完全に未使用（DI登録もなし）
- OptionsConfigurator
- ServiceLifetimeManager
- MultiConfigDIIntegration

**結論**: これらのクラスは実装されているが、DI登録も呼び出し箇所もない。Phase3実装計画の一部として作成されたが、統合されていない状態。

---

## 📝 まとめ

### 現在の実行フロー概要

**メインフロー**:
```
Program → AndonHostedService → ApplicationController
→ ExecutionOrchestrator → (周期実行)
→ ConfigToFrameManager + PlcCommunicationManager + DataOutputManager
```

### 実装状況

#### ✅ 完全実装・使用中
- **コアフロー**: Step1初期化 → Step2フレーム構築 → Step3-6 PLC通信 → Step7データ出力
- **基本的なログ機能**: LogInfo, LogError, LogDebug, LogWarning
- **設定管理**: Excel読み込み、MultiPlcConfigManager基本機能
- **タイマー駆動**: MonitoringIntervalMs間隔での周期実行

#### ⚠️ 実装済みだが未使用

**Phase3機能（8クラスすべて未統合）:**
- **ErrorHandler**: エラーカテゴリ判定とリトライ制御（AsyncExceptionHandlerに注入されるが未使用）
- **AsyncExceptionHandler**: 階層的例外ハンドリング（完全未使用）
- **GracefulShutdownHandler**: 適切な終了処理（完全未使用）
- **CancellationCoordinator**: キャンセレーション制御（完全未使用）
- **ResourceSemaphoreManager**: 共有リソース排他制御（完全未使用）
- **ResourceManager**: メモリ・リソース管理（完全未使用）
- **ProgressReporter**: 進捗報告（完全未使用）
- **ParallelExecutionController**: 並行実行制御（完全未使用）

**その他の未使用機能:**
- **統計・監視機能**: GetConnectionStats, GetLastOperationResult等
- **詳細ログ機能**: 専用ログメソッド群（LogDataAcquisition等）
- **別実装パターン**: ExecuteMultiPlcCycleAsync, MultiPlcCoordinator

#### ❌ 完全未使用
- **MultiPlcCoordinator**: クラス全体（並列実行用だが現在未使用）
- **ExecutionOrchestrator.ExecuteMultiPlcCycleAsync()**: 別の並列実行パターン
- **MultiPlcConfigManager**: 拡張メソッド群（統計、個別取得、削除等）
- **PlcCommunicationManager**: SendMultipleFramesAsync等の拡張機能

#### 💡 Phase3機能なしでも動作するが改善の余地あり
Phase3機能は実装されているが統合されていないため、以下の点で改善の余地があります：
- **エラー処理**: 現在はtry-catchのみ → Phase3統合でカテゴリ別リトライ可能
- **終了処理**: 現在は単純なStop → Phase3統合でタイムアウト付きGraceful Shutdown可能
- **並行処理**: 現在はforeachループ → Phase3統合で真の並行実行制御可能
- **リソース管理**: 現在はなし → Phase3統合でメモリ監視と排他制御可能

### 推奨アクション

#### 優先度: 高 - Phase3統合の意思決定

**Phase3実装クラスについて、以下のいずれかを決定する必要があります：**

**オプションA: Phase3機能を統合する**
- [ ] AsyncExceptionHandlerをApplicationController、ExecutionOrchestratorに統合
- [ ] GracefulShutdownHandlerをApplicationController.StopAsyncに統合
- [ ] ErrorHandlerのリトライロジックを各エラーハンドリング箇所に統合
- [ ] エラーハンドリング、終了処理、リソース管理を強化

**オプションB: Phase3実装を削除する**
- [ ] 8つのPhase3クラスファイルを削除
- [ ] DI登録を削除（DependencyInjectionConfigurator）
- [ ] テストコードを削除
- [ ] 関連ドキュメントを更新

**オプションC: 現状維持（将来実装用に保持）**
- [ ] 「将来実装予定」として明確に文書化
- [ ] Phase3統合のロードマップを作成
- [ ] 統合計画を文書化

#### 優先度: 高 - Phase3統合を進める場合の推奨順序

Phase3機能を統合する場合、以下の順序で段階的に実施することを推奨:

1. **ErrorHandler + AsyncExceptionHandler** (エラーハンドリング強化)
   - ApplicationController、ExecutionOrchestratorのtry-catch箇所を統合
   - エラーカテゴリ別のリトライロジック追加

2. **GracefulShutdownHandler** (終了処理の改善)
   - ApplicationController.StopAsync()から呼び出し
   - タイムアウト付き適切な終了処理

3. **CancellationCoordinator** (キャンセル処理の統一)
   - 周期実行フローに統合
   - 階層的なキャンセルトークン管理

4. **ResourceManager** (メモリ監視機能)
   - ExecutionOrchestratorに監視ループ追加
   - メモリ使用量の定期チェック

5. **ResourceSemaphoreManager** (排他制御)
   - 共有リソースアクセス箇所に統合

6. **ProgressReporter** (進捗報告機能)
   - ExecutionOrchestratorに進捗報告追加

7. **ParallelExecutionController** (並行実行制御)
   - ExecuteMultiPlcCycleAsync_Internalをリファクタリング

#### 優先度: 中 - 未使用コードの整理

- [ ] ExecuteMultiPlcCycleAsync() と ExecuteSinglePlcAsync() の削除または明確化
- [ ] MultiPlcCoordinator の削除または将来の実装計画明確化
- [ ] MultiPlcConfigManager の未使用メソッド削除（または将来実装予定の文書化）
- [ ] PlcCommunicationManagerの未使用メソッド（ExecuteStep3to5CycleAsync等）の整理

#### 優先度: 中 - ドキュメント整備

- [ ] Phase3統合の現状を設計ドキュメントに反映
- [ ] 統合計画をロードマップとして文書化
- [ ] 各クラスの使用例と統合方法をドキュメント化
- [ ] 「実装済みだが未使用」のコードについて、将来実装予定かどうか明確化
- [ ] アーキテクチャ設計書の更新（現在の実行フローと設計の齟齬確認）

#### 優先度: 低 - ログ機能とUtilitiesの整理

**LoggingManager専用ログメソッド（調査完了）:**
- [x] LogDataAcquisition() 等の専用ログメソッドが適切に使われているか確認 ✅ 完了
  - **結果**: 6つすべてテストコードのみで使用、本番コード未使用
  - **推奨**: Phase3統合時に使用するか、不要であれば削除を検討

**Utilities層（調査完了）:**
- [x] 各Utilityクラスが実際に使用されているか詳細調査 ✅ 完了
  - **使用中（3クラス）**: SlmpFrameBuilder, BitExpansionUtility, TerminalOutputHelper
  - **未使用（4クラス）**: SlmpDataParser, DataConverter, DeviceAddressParser, HexStringFormatter
  - **推奨**: 未使用4クラスについて以下のいずれかを決定
    - [ ] 将来実装予定として保持（文書化必要）
    - [ ] リファクタリング時の代替実装として保持
    - [ ] 削除

**Phase3未確認クラス（調査完了）:**
- [x] OptionsConfigurator, ServiceLifetimeManager, MultiConfigDIIntegration の調査 ✅ 完了
  - **結果**: すべて完全に未使用（DI登録もなし）
  - **推奨**: 以下のいずれかを決定
    - [ ] Phase3統合計画の一部として保持（ロードマップ作成）
    - [ ] 削除（Phase3実装方針の見直し）

---

## 📂 参考情報

### 調査対象ファイル一覧

**Controllers層:**
- andon/Core/Controllers/ApplicationController.cs
- andon/Core/Controllers/ExecutionOrchestrator.cs
- andon/Core/Controllers/ConfigurationWatcher.cs

**Managers層:**
- andon/Core/Managers/ConfigToFrameManager.cs
- andon/Core/Managers/PlcCommunicationManager.cs
- andon/Core/Managers/DataOutputManager.cs
- andon/Core/Managers/LoggingManager.cs
- andon/Core/Managers/ErrorHandler.cs
- andon/Core/Managers/ResourceManager.cs
- andon/Core/Managers/MultiConfigManager.cs
- andon/Core/Managers/MultiPlcCoordinator.cs

**Services層:**
- andon/Services/AndonHostedService.cs
- andon/Services/DependencyInjectionConfigurator.cs
- andon/Services/TimerService.cs
- その他Phase3実装クラス

**Utilities層:**
- andon/Utilities/*.cs

**Infrastructure層:**
- andon/Infrastructure/Configuration/ConfigurationLoaderExcel.cs

### 調査方法
- 各クラスのシンボル一覧取得（mcp__serena__find_symbol）
- 参照箇所検索（mcp__serena__find_referencing_symbols）
- コード読み取り（Read）
- 実行フロー追跡（Program.cs → AndonHostedService → ApplicationController → ...）

---

**調査完了日**: 2025-12-02
