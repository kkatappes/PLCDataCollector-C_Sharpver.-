# エラーハンドリング

◆エラー分類定義
    ・設定エラー (ConfigurationError)
    ・通信エラー (CommunicationError)
    ・データエラー (DataProcessingError)
    ・リソースエラー (ResourceError)
    ・システムエラー (SystemError)

**全てのエラーで何の処理が失敗したかのメッセージを出力**

◆重要度の分類
    ・情報（Info）: 記録のみ
    ・警告（Warning）: 注意が必要
    ・エラー（Error）: 処理失敗
    ・致命的（Fatal）: システム停止

◆リトライ方針
- エラー分類
    ・設定エラー (ConfigurationError)
    →リトライしない
    ・通信エラー (CommunicationError)
    →ステップ毎にリトライする/しないを決定
    ・データエラー (DataProcessingError)
    →リトライしない
    ・リソースエラー (ResourceError)
    →リトライしない
    ・システムエラー (SystemError)
    →ステップ毎にリトライする/しないを決定

- 方針に従った各ステップのリトライ設定
    Step1 リトライしない
    Step2 リトライしない
    Step3 最大3回リトライ
    Step4 リトライしない(1秒ごとに送受信するので、次のタイミングを待つ)
    Step5 リトライしない
    Step6 リトライしない
    Step7 最大2回リトライ (ファイル書き込み失敗時)

- 各ステップでの失敗時の処理方針
    Step1
    ・設定ファイルが存在しない
    →終了
    ・JSONの書式が間違っている
    →終了
    ・必須項目が未設定
    →終了

    Step2
    ・不正なデバイス範囲指定
    →終了
    ・フレーム形式の設定ミス
    →終了

    Step3
    ・IPアドレスに到達できない
    →終了
    ・ポートが閉じている
    →終了
    ・ネットワーク障害
    →終了

    Step4
    ・送信したフレームが不正でPLCが応答しない
    →終了
    ・PLCからの応答が途中で切れる（パケット欠損）
    →継続
    ・PLCの処理能力を超えるリクエスト（負荷過多）
    →終了
    ・PLCが一時的にビジー状態
    →終了
    ・受信データのサイズが予想と異なる
    →継続
    ・受信タイムアウト（PLCからの応答がない）
    →継続
    ・ネットワーク遅延による部分受信
    →継続
    ・PLCの電源が落ちる/リセットされる
    →継続

    Step5
    ・PLC側が既に切断済みで応答がない
    →継続
    ・切断処理中にネットワーク障害
    →継続
    ・ソケットリソースの解放失敗
    →継続
    ・切断完了前にアプリケーション終了
    →継続
    ・複数接続がある場合の切断順序ミス
    →継続

    Step6
    ・受信した16進数データが不正フォーマット
    →継続
    ・データ長が期待値と異なる
    →継続
    ・PLCエラーコードが含まれている
    →継続
    ・DWordデータの結合処理でバイト順序ミス
    →継続
    ・文字コード変換エラー
    →継続
    ・データ内に予期しない制御文字
    →継続
    ・ヘッダー情報とデータ部の整合性不一致
    →継続
    ・メモリ不足によるデータ処理失敗
    →継続

    Step7
    ・出力先ディスクの容量不足
    →終了
    ・ファイル書き込み権限がない
    →終了
    ・ファイルが他のプロセスに使用中（ロック）
    →継続
    ・出力形式変換でのデータ欠損
    →継続
    ・ログローテーション処理の失敗
    →継続
    ・ファイル出力中にアプリケーション強制終了
    →終了
    ・ネットワークドライブへの出力で通信エラー
    →終了
    ・大量データ出力時のメモリ不足
    →終了

◆エラー処理システム制御
**ErrorHandler による統合エラー管理**

- エラー分類自動判定機能
    ・発生例外の自動分析によるカテゴリ判定
    ・ステップ番号（Step1-7）による処理段階識別
    ・重要度（Info/Warning/Error/Fatal）の自動設定
    ・判定結果に基づく適切な処理方針選択

- エラー記録・追跡機能
    ・全エラーの詳細記録（種別・重要度・発生箇所・時刻）
    ・ステップ別エラー統計の蓄積
    ・エラー履歴による傾向分析
    ・トラブルシューティング用詳細情報保存

- エラー処理方針自動適用機能
    ・エラー分類に応じた継続/終了判定
    ・ステップ別処理方針の自動選択
    ・システム保護優先の判断実行
    ・運用継続性を考慮した制御選択

- リトライ制御機能
    ・エラー分類・ステップ番号によるリトライ可否判定
    ・最大リトライ回数の自動管理
    ・リトライ間隔の適切な制御
    ・リトライ履歴の記録・分析

◆非同期処理エラー制御
**AsyncExceptionHandler による並行処理エラー管理**

- 重要処理専用エラー制御
    ・対象: PLC通信処理（Step3-5）
    ・個別例外処理による詳細エラー把握
    ・処理時間・コンテキスト情報の詳細記録
    ・失敗時の即座な代替処理検討

- 一般処理一括エラー制御
    ・対象: ログ出力、データ出力処理
    ・複数処理の一括実行・例外管理
    ・失敗処理があっても他処理は継続実行
    ・統合エラーログによる全体状況把握

- 並行実行時エラー分離制御
    ・複数PLC処理での個別エラー管理
    ・1つのPLCエラーが他PLCに影響しない制御
    ・PLC別エラー統計・状況追跡
    ・全体システム継続性の確保

◆統一メッセージ管理
**ErrorMessages による一元メッセージ制御**

- エラーメッセージ標準化
    ・全システム共通メッセージ定義
    ・日本語優先・英語併記による現場対応
    ・パラメータ埋め込み対応（ファイル名、数値等）
    ・国際化対応基盤の整備

- メッセージ分類体系
    ・設定ファイル関連: CONFIG_FILE_NOT_FOUND等
    ・複数設定ファイル関連: MULTI_CONFIG_LOAD_FAILED等
    ・通信関連: CONNECTION_FAILED、COMMUNICATION_ERROR等
    ・ファイルシステム関連: FILE_ACCESS_DENIED等
    ・メモリ・リソース関連: MEMORY_LIMIT_EXCEEDED等

- メッセージ品質統一
    ・運用現場での理解しやすさ重視
    ・具体的状況・数値情報の含有
    ・対処方法示唆の含有
    ・統一フォーマットによる可読性確保

◆複数設定ファイルエラー対応
**MultiConfigLoadException による部分失敗管理**

- 部分成功時の継続制御
    ・一部設定ファイル読み込み失敗時の継続可否判定
    ・成功ファイルでの処理継続
    ・失敗ファイル詳細の記録・報告
    ・運用者への明確な状況通知

- 失敗詳細管理
    ・成功ファイル一覧: LoadedFiles
    ・失敗ファイル・例外対応: FailedFiles
    ・読み込み試行ディレクトリ: AttemptedDirectory
    ・成功率・失敗率の定量把握

- エラー報告・診断支援
    ・詳細エラーレポート自動生成
    ・失敗ファイル名一覧の提供
    ・特定例外タイプの失敗有無確認
    ・トラブルシューティング情報の充実

◆例外処理階層化制御
**処理重要度別エラー管理方針**

- 混在型例外設計
    ・重要例外: MultiConfigLoadException等のカスタム例外
    ・標準例外: FileNotFoundException、IOException等を活用
    ・.NET例外処理パターンとの整合性確保
    ・開発効率と保守性のバランス重視

- 権限チェック制御
    ・単純ファイル作成テストによる権限確認
    ・複雑な権限API依存を避けた確実性重視
    ・実行時権限エラーの事前検知
    ・運用環境での安定動作保証

- 処理継続性重視制御
    ・システム保護を最優先とした判定
    ・データ保護は可能な範囲で実施
    ・他アプリケーションへの影響最小化
    ・予防的制御による安定運用確保

