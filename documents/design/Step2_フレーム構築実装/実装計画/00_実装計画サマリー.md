# Step2フレーム構築実装 - 実装計画サマリー

## 概要

このドキュメントは、Step2（フレーム構築実装）の5段階実装計画の概要をまとめたものです。

長大な統合仕様書（`Step2_新設計_統合フレーム構築仕様.md`）を、実装しやすい5つのフェーズに分割しました。

---

## 📂 実装計画ファイル構成

```
documents/design/Step2_フレーム構築実装/実装計画/
├── 00_実装計画サマリー.md           # このファイル（全体概要）
├── Phase1_準備と基礎クラス実装.md   # SequenceNumberManager実装
├── Phase2_SlmpFrameBuilder実装.md   # 全面リファクタリング
├── Phase3_ConfigToFrameManager修正.md # 統合確認
├── Phase4_総合テスト実装.md         # テスト実装
└── Phase5_最終確認とドキュメント整備.md # 最終確認
```

---

## 🎯 各フェーズの概要

### Phase1: 準備と基礎クラス実装

**目標**: シーケンス番号管理機能の実装

**主な作業**:
- `SequenceNumberManager.cs` 新規作成
- `SequenceNumberManagerTests.cs` 作成
- (ProcessedDeviceRequestInfo削除は保留)

**成果物**:
- スレッドセーフなシーケンス番号管理クラス
- 3E/4E対応の自動インクリメント機能
- 0xFF超過時の自動ロールオーバー

**工数見積もり**: 2.5～3.5時間

**完了条件**:
- [ ] SequenceNumberManager実装完了
- [ ] 全テストケースパス
- [ ] スレッドセーフ性確認

---

### Phase2: SlmpFrameBuilder実装

**目標**: SlmpFrameBuilderの全面リファクタリング

**主な作業**:
- メソッドを機能別に7つに分割
- シーケンス番号管理統合
- フレーム検証機能追加（8194バイト上限）
- ReadRandom対応デバイスチェック追加

**メソッド構成**:
1. `ValidateInputs()` - 入力検証強化
2. `BuildSubHeader()` - ヘッダ構築
3. `BuildNetworkConfig()` - ネットワーク設定
4. `BuildCommandSection()` - コマンド部構築
5. `BuildDeviceSpecificationSection()` - デバイス指定部
6. `UpdateDataLength()` - データ長更新
7. `ValidateFrame()` - フレーム検証

**工数見積もり**: 5.5～7.5時間

**完了条件**:
- [ ] 7メソッド実装完了
- [ ] シーケンス番号管理統合
- [ ] フレーム検証実装
- [ ] ReadRandomチェック実装

---

### Phase3: ConfigToFrameManager修正 + テスト後追い実装

**目標**: ConfigToFrameManagerとPhase2実装の統合確認 + Phase1-2のテスト補完

**主な作業**:
- **Phase1-2のテスト後追い実装（追加）**:
  - SequenceNumberManagerテスト補完（TC001～TC006）
  - SlmpFrameBuilderテスト補完（TC001～TC018）
  - プライベートメソッドの間接的検証テスト追加
  - TDD原則逸脱の記録作成
- DWord分割処理の完全削除確認
- Phase2で実装したSlmpFrameBuilderとの統合確認
- 既存テストの動作確認
- 新規テストケース追加（必要に応じて）

**確認項目**:
- **Phase1-2実装済み機能のテスト網羅性確認**
- DeviceEntry → DeviceSpecification変換の確認
- SlmpFrameBuilder呼び出しの確認
- シーケンス番号管理の統合確認

**工数見積もり**: 8～11時間（テスト後追い実装により4-6時間増加）

**完了条件**:
- [ ] **Phase1-2のテスト後追い実装完了（最優先）**
- [ ] DWord分割処理の不存在確認
- [ ] Phase2統合確認完了
- [ ] 既存テスト全パス
- [ ] 新規テスト（必要に応じて）全パス
- [ ] **TDD逸脱の記録と反省**

---

### Phase4: 総合テスト実装（統合テスト中心）

**目標**: Phase1～3の全機能の総合テスト（Phase3実装済みテストとの重複を避ける）

**主な作業**:
- **Phase3完了確認**（テスト実装済み確認）
- ConfigToFrameManagerTests追加（2ケース）
- 統合テストファイル新規作成（3ケース）
- カバレッジ分析と不足テストの補完

**テストカテゴリ**:
1. 入力検証系テスト（8ケース）- ✅ Phase3で実装済み
2. 3Eフレーム構築系テスト（5ケース）- ✅ Phase3で実装済み
3. 4Eフレーム構築系テスト（2ケース）- ✅ Phase3で実装済み
4. シーケンス番号管理テスト（2ケース）- ✅ Phase3で実装済み
5. フレーム検証テスト（1ケース）- ✅ Phase3で実装済み
6. **統合テスト（5ケース）** - Phase4新規実装

**工数見積もり**: 6.5～11時間（Phase3完了により3.5-3時間短縮）

**完了条件**:
- [ ] **Phase3でのテスト実装完了確認**
- [ ] 統合テスト実装完了
- [ ] 全テストケースパス
- [ ] カバレッジ目標達成（95%以上）

---

### Phase5: 最終確認とドキュメント整備

**目標**: 実装完了確認とドキュメント整備

**主な作業**:
- 全体動作確認（5シナリオ）
- 性能評価（実行時間・メモリ使用量）
- ドキュメント整備
  - 実装記録作成
  - クラス設計書更新
  - 使用ガイド作成
- 実装完了報告書作成

**工数見積もり**: 8～12時間

**完了条件**:
- [ ] 全体動作確認完了
- [ ] 性能要件達成
- [ ] ドキュメント完全整備
- [ ] Step3への引き継ぎ準備完了

---

## 📊 全体工数見積もり

### 当初見積もり（Phase2完了前）

| フェーズ | 工数見積もり | 累計 |
|---------|------------|------|
| Phase1 | 2.5～3.5時間 | 2.5～3.5時間 |
| Phase2 | 5.5～7.5時間 | 8～11時間 |
| Phase3 | 4～5時間 | 12～16時間 |
| Phase4 | 10～14時間 | 22～30時間 |
| Phase5 | 8～12時間 | 30～42時間 |
| **合計** | **30～42時間** | - |

### 修正後見積もり（Phase2完了後、テスト後追い実装含む）

| フェーズ | 工数見積もり | 変更 | 累計 |
|---------|------------|------|------|
| Phase1 | 2.5～3.5時間 | - | 2.5～3.5時間 |
| Phase2 | 5.5～7.5時間 | - | 8～11時間 |
| **Phase3** | **8～11時間** | **+4～6時間** | **16～22時間** |
| **Phase4** | **6.5～11時間** | **-3.5～3時間** | **22.5～33時間** |
| Phase5 | 8～12時間 | - | 30.5～45時間 |
| **合計** | **30.5～45時間** | **+0.5～3時間** | - |

**工数変更の理由**:
- Phase3: テスト後追い実装（4-6時間増加）
- Phase4: Phase3でテスト実装済みのため統合テスト中心（3.5-3時間短縮）
- 全体: 微増（+0.5～3時間）

**推奨実装期間**: 5～8営業日（1日6時間作業想定）

---

## 🔄 実装フロー

```
Phase1: SequenceNumberManager実装
    ↓
Phase2: SlmpFrameBuilder全面リファクタリング
    ↓
Phase3: ConfigToFrameManager統合確認
    ↓
Phase4: 総合テスト実装
    ↓
Phase5: 最終確認・ドキュメント整備
    ↓
Step3: PLC通信実装へ
```

---

## ✅ 各フェーズの依存関係

| フェーズ | 前提条件 | 次フェーズへの成果物 |
|---------|---------|-------------------|
| Phase1 | なし | SequenceNumberManager |
| Phase2 | Phase1完了 | リファクタリング済みSlmpFrameBuilder |
| Phase3 | Phase2完了 | 統合確認済みConfigToFrameManager |
| Phase4 | Phase3完了 | 全機能テスト完了 |
| Phase5 | Phase4完了 | 実装完了・ドキュメント完備 |

**重要**: 各フェーズは順番に実施する必要があります。Phase1～3は実装フェーズ、Phase4～5は検証フェーズです。

---

## 📋 全体チェックリスト

### 実装完了チェック

#### Phase1
- [ ] SequenceNumberManager.cs 実装
- [ ] SequenceNumberManagerTests.cs 実装
- [ ] 全テストパス

#### Phase2
- [ ] クラスレベル定数・フィールド追加
- [ ] 7メソッド実装
- [ ] BuildReadRandomRequest()統合
- [ ] コンパイルエラーなし

#### Phase3
- [ ] DWord分割処理の不存在確認
- [ ] Phase2統合確認
- [ ] 既存テスト全パス

#### Phase4
- [ ] SlmpFrameBuilderTests実装（18ケース）
- [ ] ConfigToFrameManagerTests追加（2ケース）
- [ ] 統合テスト実装（3ケース）
- [ ] カバレッジ95%以上

#### Phase5
- [ ] 全体動作確認（5シナリオ）
- [ ] 性能評価完了
- [ ] ドキュメント整備完了
- [ ] 実装完了報告書作成

---

## 🎓 設計の4本柱（再確認）

### 1. ConMoniの明確な構造を基本骨格とする
- 各セクションを個別メソッドで実装
- コメントで各バイトの意味を明記
- 実機稼働実績のある構造を踏襲

### 2. PySLMPClientの優れた機能を追加実装
- シーケンス番号自動管理
- フレーム長上限検証（8194バイト）
- ReadRandom対応デバイスチェック

### 3. andon既実装の型安全性を維持強化
- DeviceCode列挙型の活用
- 入力検証の徹底
- 詳細なエラーメッセージ

### 4. DWord分割機能を完全廃止してシンプル化
- ConfigToFrameManagerでの廃止達成
- ProcessedDeviceRequestInfo削減計画策定
- ReadRandomはワード単位のみ対応

---

## 📚 参考資料

### 設計書
- `documents/design/Step2_フレーム構築実装/Step2_新設計_統合フレーム構築仕様.md` - 全体設計書（元資料）
- `documents/design/フレーム構築関係/フレーム構築方法.md` - フレーム仕様書

### 実装計画（このフォルダ）
- `Phase1_準備と基礎クラス実装.md`
- `Phase2_SlmpFrameBuilder実装.md`
- `Phase3_ConfigToFrameManager修正.md`
- `Phase4_総合テスト実装.md`
- `Phase5_最終確認とドキュメント整備.md`

### 参考実装
- `documents/design/Step2_フレーム構築実装/andon_Step2現状実装フロー.md` - andon現状実装
- `documents/design/Step2_フレーム構築実装/ConMoni_Step2処理フロー.md` - ConMoni実装
- `documents/design/Step2_フレーム構築実装/PySLMPClient_Step2処理フロー.md` - PySLMPClient実装

---

## 🚀 実装開始前の準備

### 1. 環境準備
- [ ] 開発環境セットアップ確認
- [ ] テストフレームワーク動作確認
- [ ] ビルド・テスト実行環境確認

### 2. ドキュメント確認
- [ ] Step2_新設計_統合フレーム構築仕様.md 熟読
- [ ] 各Phase実装計画ファイル確認
- [ ] フレーム仕様書確認

### 3. 現状コード確認
- [ ] SlmpFrameBuilder.cs 現状確認
- [ ] ConfigToFrameManager.cs 現状確認
- [ ] 既存テスト動作確認

### 4. 実装記録準備
- [ ] `documents/implementation_records/` フォルダ確認
- [ ] 進捗記録テンプレート準備
- [ ] 実装判断記録テンプレート準備

---

## ⚠️ 重要な注意事項

### 1. TDD手法の遵守（Phase2完了時点での状況）

**現状**: Phase1-2で実装が先行してしまい、TDD原則から逸脱

**Phase3での対応**:
- ✅ Phase1-2のテスト後追い実装を最優先タスクとして実施
- ✅ TDD原則逸脱の記録と反省を実装記録に残す
- ✅ 今後のフェーズではテストファースト徹底を決意

**本来のTDD手法**:
- 単一ブロック毎のテスト実施（Phase1～3）
- テストパス確認後に複合機能テスト（Phase4）
- 単一ブロックテストパス前の複合テスト実施禁止

**Phase3以降での改善**:
- Phase3: テスト後追い実装により、Phase1-2の実装に対するテストを補完
- Phase4以降: 必ずテストファーストを徹底すること

### 2. ProcessedDeviceRequestInfo削除の保留
- Phase1では削除しない（影響範囲が広いため）
- Step3-6実装時に段階的に削減
- 削減計画はPhase5で策定

### 3. 実機接続環境ではない
- このPCはPLC接続環境ではない
- モック/スタブを利用したオフラインテスト実施
- 勝手にビルドしない

### 4. 実装記録の徹底
- 判断根拠を詳細記録
- 発生した問題と解決過程を記録
- テスト結果を保存

---

## 📞 困ったときの対処法

### Q1: 工数見積もり通りに進まない

A1: 各フェーズごとに進捗を記録し、問題点を明確化してください。Phase5で全体の実装時間を記録し、次回の参考にします。

### Q2: テストが失敗する

A2: 以下を確認してください：
- 実装が設計通りか
- テストケースが正しいか
- 既存実装との互換性

### Q3: 設計と実装が合わない

A3: 設計優先です。実装を設計に合わせてください。ただし、設計に問題がある場合は、判断理由を記録した上で設計を修正してください。

### Q4: 次のPhaseに進むべきか判断できない

A4: 各Phaseの「完了条件」を確認してください。全ての完了条件を満たしている場合のみ、次のPhaseに進んでください。

---

## 📝 実装開始時のアクション

1. **このサマリーファイルを熟読**
2. **Phase1実装計画ファイルを開く**
3. **実装記録ファイルを作成**
   - `documents/implementation_records/Step2_フレーム構築実装記録.md`
4. **Phase1実装開始**

---

**作成日**: 2025-11-27
**作成者**: 実装計画策定
**ステータス**: 準備完了
