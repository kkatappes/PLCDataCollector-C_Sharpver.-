# 受信データ解析フローチャート

作成日: 2025-01-17
対象プロジェクト: andon (C#)
最終更新: 2025-01-18

---

## 実装状況と運用方針

### ✅ 実装完了（本番運用可能）
- **Phase 1**: ASCII形式対応（3E/4E × Binary/ASCII 全4パターン）
- **Phase 2**: ビット展開機能
- **Phase 3-1**: デバイス点数多層検証

### ⚠️ 未実装（現在の運用では不要）

#### Phase 3-2: 詳細エラーマッピング（SlmpErrorCodes）
**不要理由**:
- 現在は終了コード != 0x0000 で例外スローする簡易実装で十分
- エラー詳細分類（Warning/Error/Critical）は運用上不要
- **運用方針**: 1秒ごとの定期ポーリングで、エラー発生時は次サイクルで再取得

#### Phase 3-3: TCP分割受信対応（TcpFrameBufferManager）
**不要理由**:
- 取得データ量が小さい（数十ワード程度）
- 1秒ごとの定期送受信で、分割受信が発生する可能性は極めて低い
- **運用方針**: 失敗したサイクルはスキップし、次サイクルで正常取得できればOK
- MTU制限やネットワーク負荷による分割は、実運用で問題が発生してから対応

#### Phase 3-4: 統計記録機能の拡張
**不要理由**:
- 基本的な統計（ConnectionStats）は実装済み
- フレームタイプ別・エラーコード別の詳細統計は運用上不要
- **運用方針**: 基本統計のみで十分、詳細分析が必要になったら追加

**結論**: **Phase 1, 2, 3-1の実装で本番運用可能**。Phase 3の残機能は、実運用で必要性が明確になった時点で追加実装する。

---

## Phase 1: ASCII形式対応実装後の処理フロー

```
┌──────────────────────────────────────────────────────────────┐
│ ProcessReceivedRawData() - Phase 1実装後                      │
│                                                               │
│ 1. 入力検証 + パフォーマンス計測開始                             │
│    ↓                                                          │
│ 2. フレームタイプ自動検出（拡張版）                             │
│    │  - 先頭バイト判定                                         │
│    │    • 0x44 ('D') → ASCII形式                             │
│    │      - 2バイト目 0x30 ('0') → 3E ASCII                  │
│    │      - 2バイト目 0x34 ('4') → 4E ASCII                  │
│    │    • 0xD0 0x00 → 3E Binary                              │
│    │    • 0xD4 0x00 → 4E Binary                              │
│    ↓                                                          │
│ 3. SLMP構造検証                                                │
│    ↓                                                          │
│ 4. フレーム解析（4パターン対応）                               │
│    ├─ 3E Binary → Parse3EFrameStructure()                    │
│    ├─ 4E Binary → Parse4EFrameStructure()                    │
│    ├─ 3E ASCII → Parse3EFrameStructureAscii() ← 新規          │
│    └─ 4E ASCII → Parse4EFrameStructureAscii() ← 新規          │
│    ↓                                                          │
│ 5. 終了コード確認                                              │
│    ↓                                                          │
│ 6. デバイス値抽出                                              │
│    ↓                                                          │
│ 7. ProcessedDeviceリスト構築                                  │
│    ↓                                                          │
│ 8. 処理時間計測 + ログ出力                                     │
└──────────────────────────────────────────────────────────────┘
```

---

## Phase 2: ビット展開機能実装後の処理フロー

```
┌──────────────────────────────────────────────────────────────┐
│ ProcessReceivedRawData() - Phase 2実装後                      │
│                                                               │
│ ... (Phase 1と同じ) ...                                        │
│    ↓                                                          │
│ 7. ProcessedDeviceリスト構築                                  │
│    ↓                                                          │
│ 8. ビット展開適用 ← 新規                                       │
│    │  設定確認（BitExpansionSettings）                         │
│    │    ↓                                                     │
│    │  各デバイスをループ処理                                    │
│    │    ├─ 変換係数適用（ConversionFactor）                    │
│    │    │   ConvertedValue = RawValue × Factor               │
│    │    │                                                     │
│    │    ├─ SelectionMask確認                                  │
│    │    │    ↓                                                │
│    │    ├─ true: ビット展開モード                             │
│    │    │   │  ExpandWordToBits(RawValue)                    │
│    │    │   │  → [bit0, bit1, ..., bit15] (LSB first)       │
│    │    │   │  IsBitExpanded = true                          │
│    │    │   └  ExpandedBits配列に格納                         │
│    │    │                                                     │
│    │    └─ false: ワード値モード                              │
│    │        IsBitExpanded = false                            │
│    │        ConvertedValueのみ使用                            │
│    ↓                                                          │
│ 9. 処理時間計測 + ログ出力                                     │
└──────────────────────────────────────────────────────────────┘
```

---

## Phase 3: 検証機能強化実装後の処理フロー

### Phase 3-3: TCP分割受信対応 ⚠️（未実装・現在の運用では不要）

> **注**: この機能は現在の運用方針（1秒ごとの定期ポーリング、小データ量、失敗時は次サイクルで再取得）では不要と判断。
> 実運用で分割受信エラーが頻発した場合のみ実装を検討。

```
┌──────────────────────────────────────────────────────────────┐
│ TCP/UDP自動判定受信 ← Phase 3追加（未実装）                    │
│   ↓                                                           │
│   ├─ TCP: TcpFrameBufferManager使用                           │
│   │   │  - 前回残データと結合                                  │
│   │   │  - フレーム完全性チェック                              │
│   │   │  - 完全なフレーム抽出                                  │
│   │   │  - 残データをバッファ保存                              │
│   │   └  統計記録（分割受信回数）                              │
│   │                                                           │
│   └─ UDP: 従来通り1回受信                                      │
│                                                               │
└──────────────────────────────────────────────────────────────┘
```

### Phase 3全体の処理フロー

```
┌──────────────────────────────────────────────────────────────┐
│ ProcessReceivedRawData() - Phase 3実装後                      │
│                                                               │
│ 1. 入力検証 + パフォーマンス計測開始                             │
│    ↓                                                          │
│ 2. フレームタイプ自動検出                                       │
│    │  統計記録（フレームタイプ使用回数） ← Phase 3追加          │
│    ↓                                                          │
│ 3. SLMP構造検証                                                │
│    ↓                                                          │
│ 4. フレーム解析                                                │
│    ↓                                                          │
│ 5. 終了コード確認 ⚠️（詳細エラーマッピングは未実装・不要）      │
│    │  現在の実装: EndCode != 0x0000 → 例外スロー              │
│    │  （Phase 3拡張機能は運用上不要のため実装しない）          │
│    │                                                          │
│    │  ［未実装の詳細エラーマッピング］                         │
│    │  SlmpErrorCodes.GetErrorInfo(endCode) ← 実装しない       │
│    │    - エラーコード名                                       │
│    │    - 詳細説明                                            │
│    │    - 重大度（None/Warning/Error/Critical）               │
│    │    - 重大度別処理（Critical/Error/Warning）              │
│    │    - 統計記録（エラーコード発生回数）                     │
│    ↓                                                          │
│ 6. デバイス点数多層検証 ← Phase 3追加 ✅（実装済み）            │
│    │  方法1: ヘッダのデータ長フィールドから計算                 │
│    │  方法2: 実データ長から計算                                │
│    │  方法3: 要求値との照合                                    │
│    │    ↓                                                     │
│    │  不一致時                                                 │
│    │    - 警告ログ出力                                         │
│    │    - 実データ長を優先                                     │
│    │  （統計記録機能は運用上不要のため実装しない）              │
│    ↓                                                          │
│ 7. デバイス値抽出                                              │
│    ↓                                                          │
│ 8. ビット展開適用（Phase 2機能）                               │
│    ↓                                                          │
│ 9. 処理時間計測 + ログ出力                                     │
│    │  （統計記録機能は運用上不要のため実装しない）              │
└──────────────────────────────────────────────────────────────┘
```

---

## 全Phase実装後の完全な処理フロー（理想形）

> **注**: 以下は将来的な拡張を含む理想形のフローです。現在の運用では **TCP分割受信機能は不要** と判断しています。

```
┌─────────────────────────────────────────────────────────────────┐
│ 通信開始                                                          │
│   ↓                                                              │
│ ProtocolType判定（UDP / TCP）                                    │
│   ↓                                                              │
│ ├─ UDP: ReceiveAsync() → 1回で完全なフレーム受信 ✅（実装済み）  │
│ │                                                                │
│ └─ TCP: ReceiveCompleteFrameAsync() ⚠️（未実装・不要）           │
│     ├─ TcpFrameBufferManager初期化                               │
│     ├─ ループ: 完全なフレームが受信できるまで                      │
│     │   ├─ ReadAsync() → 部分データ受信                          │
│     │   ├─ ProcessReceivedData()                                │
│     │   │   ├─ 前回残データと結合                                │
│     │   │   ├─ IsFrameComplete()                                │
│     │   │   │   ├─ フレームタイプ判定                           │
│     │   │   │   ├─ データ長フィールド抽出                       │
│     │   │   │   └─ フレーム長計算・完全性確認                   │
│     │   │   ├─ 完全: フレーム抽出 + 残データ保存                 │
│     │   │   └─ 不完全: バッファ保存 + 次回受信待機               │
│     │   └─ 統計記録（分割受信回数）                              │
│     └─ 完全なフレーム返却                                         │
│                                                                  │
│ 【現在の実装】TCP接続でもReceiveAsync()を直接使用                 │
│ - 1秒ごとの定期ポーリングで分割受信の可能性は極めて低い           │
│ - 失敗時は次サイクルで再取得する運用方針                          │
└─────────────────────────────────────────────────────────────────┘
        ↓
┌─────────────────────────────────────────────────────────────────┐
│ ProcessReceivedRawData() (全Phase実装後)                         │
│   ↓                                                              │
│ 1. 入力検証 + パフォーマンス計測開始                               │
│   ↓                                                              │
│ 2. フレームタイプ自動検出（4パターン対応） ✅（実装済み）           │
│    │  - 0x44 ('D') + 0x30 ('0') → 3E ASCII                      │
│    │  - 0x44 ('D') + 0x34 ('4') → 4E ASCII                      │
│    │  - 0xD0 0x00 → 3E Binary                                   │
│    │  - 0xD4 0x00 → 4E Binary                                   │
│    │  （統計記録機能は運用上不要のため実装しない）                │
│   ↓                                                              │
│ 3. SLMP構造検証                                                   │
│   ↓                                                              │
│ 4. フレーム解析（動的分岐） ✅（実装済み）                         │
│    ├─ 3E Binary → Parse3EFrameStructure()                       │
│    ├─ 4E Binary → Parse4EFrameStructure()                       │
│    ├─ 3E ASCII → Parse3EFrameStructureAscii()                   │
│    └─ 4E ASCII → Parse4EFrameStructureAscii()                   │
│   ↓                                                              │
│ 5. 終了コード確認 ⚠️（詳細エラーマッピングは未実装・不要）         │
│    │  現在の実装: EndCode != 0x0000 → 例外スロー                 │
│    │  ［未実装の詳細機能］                                        │
│    │    - SlmpErrorCodes.GetErrorInfo(endCode)                  │
│    │    - エラー重大度分類（Critical/Error/Warning）             │
│    │    - 統計記録（エラーコード発生回数）                        │
│   ↓                                                              │
│ 6. デバイス点数多層検証 ✅（実装済み）                             │
│    │  - ヘッダのデータ長フィールドから計算                         │
│    │  - 実データ長から計算                                        │
│    │  - 要求値との照合                                           │
│    │  不一致時: 警告ログ + 実データ優先                           │
│    │  （統計記録機能は運用上不要のため実装しない）                │
│   ↓                                                              │
│ 7. デバイス値抽出 ✅（実装済み）                                   │
│    │  - リトルエンディアン変換                                    │
│    │  - 2バイト単位で読み取り                                     │
│   ↓                                                              │
│ 8. ビット展開適用 ✅（Phase 2機能・実装済み）                      │
│    │  設定確認（BitExpansionSettings.Enabled）                   │
│    │    ↓                                                        │
│    │  各デバイスをループ処理                                       │
│    │    ├─ 変換係数適用（ConversionFactor）                       │
│    │    │   ConvertedValue = RawValue × Factor                  │
│    │    │                                                        │
│    │    └─ SelectionMask確認                                     │
│    │        ├─ true: ビット展開モード                            │
│    │        │   ExpandWordToBits() → [bit0~bit15] (LSB first)   │
│    │        │   IsBitExpanded = true                            │
│    │        │                                                    │
│    │        └─ false: ワード値モード                             │
│    │            IsBitExpanded = false                           │
│   ↓                                                              │
│ 9. ProcessedDeviceリスト構築 ✅（実装済み）                        │
│   ↓                                                              │
│ 10. 処理時間計測 + ログ出力 ✅（実装済み）                         │
│     │  （統計記録機能は運用上不要のため実装しない）                │
│   ↓                                                              │
│ 11. BasicProcessedResponseData返却 ✅（実装済み）                 │
└─────────────────────────────────────────────────────────────────┘
        ↓
┌─────────────────────────────────────────────────────────────────┐
│ ParseRawToStructuredData() (既存機能)                            │
│   ↓                                                              │
│ 1. 構造化設定検証                                                 │
│   ↓                                                              │
│ 2. 複数構造体定義の順次処理                                       │
│   ↓                                                              │
│ 3. StructuredDeviceリスト構築                                     │
│   ↓                                                              │
│ 4. 解析ステップ記録 + エラー/警告管理                             │
└─────────────────────────────────────────────────────────────────┘
        ↓
┌─────────────────────────────────────────────────────────────────┐
│ 統計レポート出力（定期的） ⚠️（詳細統計は未実装・不要）            │
│   ├─ フレームタイプ使用統計 ← 未実装                              │
│   ├─ エラーコード発生統計 ← 未実装                                │
│   ├─ 処理時間統計（平均・最小・最大） ← 未実装                    │
│   ├─ TCP分割受信統計 ← 未実装                                    │
│   └─ デバイス点数不一致統計 ← 未実装                              │
│                                                                  │
│ 【現在の実装】基本統計のみ（ConnectionStats）                      │
│   - 接続成功/失敗回数                                             │
│   - レスポンス時間履歴                                            │
│   - エラー総数                                                    │
│   → 現在の運用では十分と判断                                      │
└─────────────────────────────────────────────────────────────────┘
```

---

**文書作成者**: Claude Code
**作成日**: 2025-01-17
**最終更新日**: 2025-01-18
