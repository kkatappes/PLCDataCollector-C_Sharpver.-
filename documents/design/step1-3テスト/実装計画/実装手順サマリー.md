# Step1-3オフラインテスト 実装手順サマリー

## 全体構成

### 問題の背景
- **型の不一致**: ConfigurationLoaderExcel が PlcConfiguration を返すが、ConfigToFrameManager は TargetDeviceConfig を期待
- **解決策**: ConfigToFrameManager に PlcConfiguration 用のオーバーロードメソッドを追加

### 実装対象メソッド
```csharp
// Binary形式（Phase 1）
public byte[] BuildReadRandomFrameFromConfig(PlcConfiguration config)

// ASCII形式（Phase 2）
public string BuildReadRandomFrameFromConfigAscii(PlcConfiguration config)
```

---

## TDD実装順序（Red → Green → Refactor）

### Phase 1: Binary形式オーバーロード実装
```
Round 1: null検証テスト → 実装 → パス確認 ✅
Round 2: 空リスト検証テスト → 実装 → パス確認 ✅
Round 3: 正常系テスト → 実装 → パス確認 ✅
Round 4: Binary全テスト実行 → パス確認 ✅
```

### Phase 2: ASCII形式オーバーロード実装
```
Round 5: ASCII null検証テスト → 実装 → パス確認 ✅
Round 6: ASCII空リスト検証テスト → 実装 → パス確認 ✅
Round 7: ASCII正常系テスト → 実装 → パス確認 ✅
Round 8: ASCII全テスト実行 → パス確認 ✅
```

### Phase 3: 統合テスト実装
```
Round 9: Excel読み込み→送信統合テスト → パス確認 ✅（Phase 1の実装を利用）
Round 10: 全テスト実行 → パス確認 ✅
```

---

## 実装ファイル

### テストファイル
- **単体テスト**: `Tests/Unit/Core/Managers/ConfigToFrameManagerTests.cs`
- **統合テスト**: `Tests/Integration/Step1_3_IntegrationTests.cs`

### 実装ファイル
- **メソッド追加先**: `Core/Managers/ConfigToFrameManager.cs`

---

## TDD厳守ルール

### 基本原則
1. **1つのテストを書く → 実装 → パス確認**を繰り返す
2. **複数のテストを一度に実装しない**
3. **単体テストが全てパスしてから統合テストに進む**
4. **各Roundでテスト実行とパス確認を必ず行う**

### テスト実行コマンド
```bash
# 個別テスト実行（開発中）
dotnet test --filter "BuildReadRandomFrameFromConfig_PlcConfigurationがnull"

# カテゴリ別テスト実行
dotnet test --filter "BuildReadRandomFrameFromConfig"
dotnet test --filter "BuildReadRandomFrameFromConfigAscii"

# 全テスト実行（Phase完了確認）
dotnet test
```

---

## 実装チェックリスト

### Phase 1: Binary形式（Round 1-4）
- [ ] Round 1: null検証テスト実装・パス
- [ ] Round 2: 空リスト検証テスト実装・パス
- [ ] Round 3: 正常系テスト実装・パス
- [ ] Round 4: Binary全テスト実行・パス

### Phase 2: ASCII形式（Round 5-8）
- [ ] Round 5: ASCII null検証テスト実装・パス
- [ ] Round 6: ASCII空リスト検証テスト実装・パス
- [ ] Round 7: ASCII正常系テスト実装・パス
- [ ] Round 8: ASCII全テスト実行・パス

### Phase 3: 統合テスト（Round 9-10）
- [ ] Round 9: Excel読み込み→送信統合テスト実装・パス
- [ ] Round 10: 全テスト実行・パス

---

## オフラインテスト制約

### 必須事項
1. **実機PLCへの接続は行わない**
2. **MockSocket/MockUdpServerを必ず使用**
3. **実データ取得目的でのビルドは禁止**

### テストデータ
- **Excelファイル**: `5JRS_N2.xlsx` (C:\Users\1010821\Desktop\python\andon\5JRS_N2.xlsx)
- **SampleExcelConfigsクラス**: テストデータ模擬用

---

## 統合テストの検証フロー

### Step1: Excel設定読み込み
```csharp
var configLoader = new ConfigurationLoaderExcel();
var plcConfig = configLoader.LoadAllPlcConnectionConfigs()[0];
```
**検証項目**:
- IP address: "172.30.40.40"
- Port: 8192
- デバイス数: 225個
- 先頭デバイス: M33
- 16進デバイス: X機器（0xC0 = 192）

### Step2: フレーム構築
```csharp
var frameManager = new ConfigToFrameManager();
var frameBytes = frameManager.BuildReadRandomFrameFromConfig(plcConfig);
```
**検証項目**:
- フレームがnullでないこと
- 4Eフレームヘッダ: 0x54, 0x00
- ReadRandomコマンド: 0x0403（オフセット15-16）

### Step3: 送信シミュレート
```csharp
var plcManager = new PlcCommunicationManager(connectionConfig, timeoutConfig, socketFactory);
await plcManager.ConnectAsync();
await plcManager.SendFrameAsync(frameBytes);
```
**検証項目**:
- 接続成功: ConnectionStatus.Connected
- フレーム送信成功
- 送信統計: 送信回数、バイト数
- MockSocket送信データ一致

---

## 実装後の次のステップ

### Step1-3完了後
- **Step4-6実装**: PLC通信・データ受信・パース処理
- **Step7実装**: データ出力処理

### JSON廃止計画
- **Phase 1完了**: Excel読み込み機能完全実装（現在）
- **Phase 2開始**: 実機テスト開始時点
- **Phase 3実施**: JSON関連コード削除

---

## 参照ドキュメント

### 詳細設計書
- `documents/design/step1-3テスト/実装計画/Phase1_Binary形式オーバーロード実装.md`
- `documents/design/step1-3テスト/実装計画/Phase2_ASCII形式オーバーロード実装.md`
- `documents/design/step1-3テスト/実装計画/Phase3_統合テスト実装.md`

### プロジェクト構造
- `documents/design/プロジェクト構造設計.md`
- `documents/design/クラス設計.md`
- `CLAUDE.md`

---

## 重要な注意事項

### 実装開始前の確認
- ✅ 問題の背景を理解している
- ✅ TDDの手順を理解している
- ✅ オフラインテスト制約を理解している
- ✅ 実装対象ファイルを確認している

### 実装中の注意
- 1つずつテストを実装・実行・パス確認
- 実装は最小限（テストがパスする最小コード）
- Phase完了ごとに全テスト実行
- 実機接続は絶対に行わない

### 完了基準
- Phase 1-3の全テストがパスすること
- オフラインで全フローが動作すること
- MockSocketで送信データが正しいこと
