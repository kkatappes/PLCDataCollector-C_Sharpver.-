# 補助クラス・データモデル

## 概要

各種処理結果・設定情報を保持するデータモデルクラス

---

## 設定関連モデル

### ConnectionConfig（接続設定）

**プロパティ:**
- IpAddress（string型）：接続先IPアドレス
- Port（int型）：接続先ポート番号
- UseTcp（bool型）：TCP/UDP選択（true=TCP, false=UDP）
- ConnectionType（string型）：接続タイプ表現（"TCP"/"UDP"、ログ出力用）
- IsBinary（bool型）：フレーム形式（true=Binary, false=ASCII）
- FrameVersion（string型）：フレームバージョン（"3E"/"4E"）

**データ取得元:**
- ConfigToFrameManager.LoadConfigAsync()

---

### TimeoutConfig（タイムアウト設定）

**プロパティ:**
- ConnectTimeoutMs（int型）：接続タイムアウト（ミリ秒）
- SendTimeoutMs（int型）：送信タイムアウト（ミリ秒）
- ReceiveTimeoutMs（int型）：受信タイムアウト（ミリ秒）
- RetryTimeoutMs（int型）：リトライ間隔（ミリ秒）

**データ取得元:**
- ConfigToFrameManager.LoadConfigAsync()

---

### TargetDeviceConfig（デバイス設定）

**プロパティ:**
- Devices（List<DeviceSpecification>型）：デバイス指定リスト
- FrameType（string型）：フレームタイプ（"3E"/"4E"）
- Timeout（ushort型）：監視タイマ（250ms単位、デフォルト32=8秒）

**用途:**
- Random READ(0x0403)コマンドでのデバイス一括取得
- 飛び飛びのデバイス指定に対応
- ビット・ワード・ダブルワード混在対応

**データ取得元:**
- ConfigurationLoader.LoadPlcConnectionConfig()

**注意:**
- Phase6(2025-11-21)でリスト形式に変更
- 旧形式のMDeviceRange/DDeviceRangeは廃止

---

### DeviceEntry（設定読み込み用中間型）

**プロパティ:**
- DeviceType（string型）：デバイスタイプ（"D", "M", "W"等）
- DeviceNumber（int型）：デバイス番号（10進表記）
- IsHexAddress（bool型）：16進アドレス表記フラグ（デフォルト: false）
- Description（string型、null許容）：デバイス説明（省略可）

**用途:**
- appsettings.jsonのDevicesリスト要素からの読み込み専用
- ConfigurationLoader内でDeviceSpecificationに変換
- アプリケーション内部では使用しない（中間型）

**実装箇所:**
- `andon/Core/Models/ConfigModels/DeviceEntry.cs`

**データ取得元:**
- ConfigurationLoader.LoadPlcConnectionConfig()

**実装日:**
- Phase6 (2025-11-21)

---

### DeviceSpecification（デバイス指定情報）

**プロパティ:**
- Code（DeviceCode型）：デバイスコード（M, D, W, X, Y等）
- DeviceNumber（int型）：デバイス番号（アドレス）
- IsHexAddress（bool型）：16進アドレス表記フラグ（デフォルト: false）

**メソッド:**
- FromHexString(string hexString)（静的）：16進数文字列からDeviceSpecification生成
- ToDeviceNumberBytes()：デバイス番号をバイト配列に変換（3バイト、リトルエンディアン）
- ToDeviceSpecificationBytes()：Random READ用デバイス指定バイト列生成（5バイト: デバイスコード1B + デバイス番号3B + ワード数1B）
- ValidateForReadRandom()：Random READコマンドでの使用可否検証

**用途:**
- Random READ(0x0403)コマンドでのデバイス指定
- 不連続デバイスアドレスの指定に対応
- ビット・ワード・ダブルワードの区別なく統一的に扱う

**実装箇所:**
- `andon/Core/Models/DeviceSpecification.cs`

**データ取得元:**
- ConfigurationLoader.LoadPlcConnectionConfig()
- DeviceEntry.ToDeviceSpecification()

**実装日:**
- Phase1 (2025-11-20)

**設計背景:**
- Random READ方式採用に伴う核心的なデータ構造
- DeviceEntryからの変換により設定ファイルとの橋渡し
- フレーム構築時の直接的なバイト列変換をサポート

---

### SystemResourcesConfig（システムリソース設定）

**プロパティ:**
- MemoryLimitKB（int型）：メモリ使用上限（KB）
- MaxBufferSize（int型）：最大バッファサイズ（バイト）
- MemoryThresholdKB（int型）：メモリ警告閾値（KB）
- LowMemoryMode（bool型）：低メモリモード有効化

**データ取得元:**
- ConfigToFrameManager.LoadConfigAsync()

---

### DataProcessingConfig（データ処理設定）

**プロパティ:**
- TargetName（string型）：データ識別名
- ContinuousDataMode（bool型）：継続データモード有効化
- DataRetentionDays（int型）：データ保持日数

**データ取得元:**
- ConfigToFrameManager.LoadConfigAsync()

---

### LoggingConfig（ログ設定）

**プロパティ:**
- ConsoleOutput（bool型）：コンソール出力有効化
- DetailedLog（bool型）：詳細ログ有効化

**データ取得元:**
- ConfigToFrameManager.LoadConfigAsync()

---

### DataTransferConfig（データ転送設定）

**プロパティ:**
- EnableTransfer（bool型）：転送機能有効化
- DestinationIpAddress（string型）：転送先IPアドレス
- DestinationPort（int型）：転送先ポート番号

**データ取得元:**
- ConfigToFrameManager.LoadConfigAsync()

---

## 処理結果モデル

### ConnectionResponse（接続処理結果）

**プロパティ:**
- Status（ConnectionStatus型、enum）：接続状態（Connected/Disconnected/Error）
- Socket（Socket型、null許容）：通信用ソケット（成功時のみ）
- RemoteEndPoint（EndPoint型、null許容）：接続先情報（成功時のみ）
- ConnectedAt（DateTime型、null許容）：接続完了時刻（成功時のみ）
- ConnectionTime（TimeSpan型、null許容）：接続処理時間（成功時のみ）
- ErrorMessage（string型、null許容）：エラーメッセージ（失敗時のみ）

**データ取得元:**
- PlcCommunicationManager.ConnectAsync()

---

### ConnectionStats（通信統計情報）

**プロパティ:**

**基本統計:**
- ConnectionDuration（TimeSpan型）：接続時間
- TotalFramesSent（int型）：送信フレーム総数
- TotalFramesReceived（int型）：受信フレーム総数
- TotalBytesSent（long型）：送信バイト総数
- TotalBytesReceived（long型）：受信バイト総数
- DisconnectedAt（DateTime型）：切断時刻

**応答時間統計:**
- ResponseTimes（List<TimeSpan>型）：応答時間履歴
- AverageResponseTime（TimeSpan型）：平均応答時間
- MaxResponseTime（TimeSpan型）：最大応答時間
- MinResponseTime（TimeSpan型）：最小応答時間

**エラー・品質統計:**
- TotalErrors（int型）：エラー回数
- TotalRetries（int型）：リトライ回数
- SuccessRate（double型）：通信成功率（0.0-1.0）

**データ取得元:**
- PlcCommunicationManager.DisconnectAsync()

---

### ProcessedDeviceRequestInfo（デバイス要求情報）

**プロパティ:**
- DeviceType（string型）：デバイス型（"D", "M", "X", "Y"等）
- StartAddress（int型）：開始アドレス
- Count（int型）：要求デバイス数
- FrameType（FrameType型）：フレーム型

**用途:**
- TC029テスト実装で使用
- TC037構造化処理で使用
- Random READ一括取得方式対応

**実装箇所:**
- `andon/Core/Models/ProcessedDeviceRequestInfo.cs`

**データ取得元:**
- テストコード内で構築（主にTC029, TC037）

**注意:**
- Phase4仕様変更(2025-11-20)により旧設計のRandomReadDeviceListプロパティは廃止
- 現在の実装は簡素化された構造を採用

---

### ProcessedResponseData（処理済み応答データ）

**プロパティ:**

**基本結果:**
- RawData（string型）：元の生データ（16進数）
- ProcessedData（Dictionary<string, object>型）：デバイス名キー構造の処理済みデータ
- ProcessedAt（DateTime型）：処理時刻

**エラー情報:**
- HasError（bool型）：エラーフラグ
- ErrorMessages（List<string>型）：エラーメッセージリスト
- WarningMessages（List<string>型）：警告メッセージリスト

**統計情報:**
- ProcessedBitDeviceCount（int型）：処理ビットデバイス数
- ProcessedWordDeviceCount（int型）：処理ワードデバイス数
- ProcessedDwordDeviceCount（int型）：処理ダブルワードデバイス数

**データ取得元:**
- PlcCommunicationManager.ProcessReceivedRawData()

---

### DeviceData（デバイスデータ表現クラス）

**プロパティ:**
- DeviceName（string型）：デバイス名（"M000", "D000", "W0x11AA"等）
- Code（DeviceCode型）：デバイスコード
- Address（int型）：デバイス番号（アドレス）
- Value（uint型）：デバイス値（16bit: ワードデバイス、32bit: ダブルワードデバイス）
- IsDWord（bool型）：ダブルワードデバイスフラグ
- IsHexAddress（bool型）：16進アドレス表記フラグ

**用途:**
- Random READレスポンスのパース結果を格納
- Dictionary<string, DeviceData>構造でデバイス名キー管理
- ビット・ワード・ダブルワード混在対応

**実装箇所:**
- `andon/Core/Models/DeviceData.cs`

**データ取得元:**
- SlmpDataParser.ParseReadRandomResponse()

**実装日:**
- Phase5 (2025-11-21)

**設計背景:**
- Phase4仕様変更(2025-11-20)で導入
- Random READ全デバイス一括取得方式の核心的なデータ構造
- デバイス名キー（"M000", "D000", "D002"）による直感的なアクセス

---

### StructuredData（構造化データ）

**プロパティ:**

**基本構造化データ:**
- SlmpHeader（SlmpHeaderInfo型）：SLMPヘッダー情報
- EndCode（ushort型）：終了コード
- DeviceData（Dictionary<string, DeviceData>型）：デバイスデータ（デバイス名キー構造）
- ReceivedAt（DateTime型）：受信時刻
- HasError（bool型）：エラーフラグ

**解析詳細情報:**
- ParseSteps（List<string>型）：解析手順記録
- InterpretationInfo（Dictionary<string, string>型）：解釈情報
- ProcessingTime（TimeSpan型）：処理時間
- DeviceInterpretation（Dictionary<string, string>型）：デバイス解釈
- StatusDetermination（string型）：ステータス判定

**エラー詳細情報:**
- DetailedErrorCode（ushort型、null許容）：詳細エラーコード（エラー時のみ）
- ErrorDescription（string型、null許容）：エラー説明（エラー時のみ）
- AffectedDevices（List<string>型、null許容）：影響デバイス（エラー時のみ）

**内部構造（SlmpHeaderInfo）:**
- SubHeader（string型）：サブヘッダー
- NetworkNumber（byte型）：ネットワーク番号
- PcNumber（byte型）：PC番号
- IoNumber（ushort型）：I/O番号
- StationNumber（byte型）：局番
- DataLength（ushort型）：データ長
- SequenceNumber（ushort型、4Eのみ）：シーケンス番号

**データ取得元:**
- PlcCommunicationManager.ParseRawToStructuredData()

---

### WriteResult（出力結果）

**プロパティ:**
- OutputPath（string型）：実際の出力ファイルパス
- BytesWritten（long型）：書き込んだバイト数
- RecordsWritten（int型）：書き込んだレコード数
- WriteTime（TimeSpan型）：書き込み時間
- Success（bool型）：出力成功フラグ
- ErrorMessage（string型、null許容）：エラーメッセージ

**データ取得元:**
- CsvFileWriter.WriteToFileAsync()

---

### CleanupResult（削除結果）

**プロパティ:**
- DeletedFiles（string[]型）：削除されたファイルパス一覧
- DeletedCount（int型）：削除されたファイル数
- FreedSpaceKB（long型）：解放されたディスク容量
- Success（bool型）：処理成功フラグ
- ErrorMessage（string型、null許容）：エラーメッセージ

**データ取得元:**
- CsvFileWriter.CleanupOldFilesAsync()

---

### TransferResult（転送結果）

**プロパティ:**
- Success（bool型）：転送成功フラグ
- BytesTransferred（long型）：転送されたバイト数
- TransferTime（TimeSpan型）：転送時間
- Destination（string型）：転送先アドレス
- ErrorMessage（string型、null許容）：エラーメッセージ

**データ取得元:**
- DataTransferManager.TransferDataAsync()

---

## Enum定義

### ConnectionStatus（接続状態）

**値:**
- Disconnected = 0：未接続
- Connected = 1：接続中
- Error = 2：エラー状態

**使用箇所:**
- ConnectionResponse.Status

---

## 設計方針

### イミュータビリティ
- 可能な限りreadonly/init-onlyプロパティを使用
- データの予期しない変更を防止

### null許容性の明示
- C# 8.0以降のnullable参照型を活用
- null可能性の明示的な表現

### 型安全性
- 適切な型の選択（DateTime, TimeSpan等）
- 型変換エラーの最小化

### 拡張性
- 将来的なプロパティ追加に備えた設計
- 後方互換性の考慮

---

## 変更履歴

### 2025-11-21: Phase4-6仕様変更対応
- **TargetDeviceConfig**: リスト形式に変更（MDeviceRange/DDeviceRange廃止）
- **DeviceEntry**: 新規追加（設定読み込み用中間型）
- **DeviceSpecification**: Random READ用デバイス指定情報クラス（Phase1実装）
- **DeviceData**: 新規追加（Random READレスポンス用データ構造）
- **ProcessedDeviceRequestInfo**: プロパティ構造を簡素化（RandomReadDeviceList廃止）
- **StructuredData.DeviceData**: 型を`Dictionary<string, object>`から`Dictionary<string, DeviceData>`に変更

### 変更理由
- Phase4仕様変更(2025-11-20): Random READ全デバイス一括取得方式の採用
- 通信回数の最小化（2回→1回）
- デバイス名キー構造による直感的なアクセス
- ビット・ワード・ダブルワード混在対応

### 廃止された仕様
- READコマンド(0x0401)ベースの設計
- MDeviceRange/DDeviceRange形式のデバイス範囲指定
- RandomReadDeviceList/DeviceSpec構造
- BasicProcessedResponseData型
- MergeResponseData()メソッド
