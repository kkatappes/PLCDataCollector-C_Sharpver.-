# ヘルパーメソッド・ユーティリティ

## 概要

各クラスで共通利用されるヘルパーメソッド・ユーティリティクラス

---

## ConfigToFrameManager ヘルパーメソッド

### ValidateConfig（設定検証）

**機能：** 読み込んだ設定値の妥当性検証

**Input:** 各種設定オブジェクト（ConnectionConfig, TimeoutConfig等）

**Output:** ValidationResult（検証結果、エラーリスト）

**検証項目:**
- IPアドレス形式チェック
- ポート番号範囲チェック（1-65535）
- タイムアウト値の正当性チェック（> 0）
- デバイス範囲形式チェック（例："M000-M999"）
- 必須項目の存在チェック

**使用箇所:**
- LoadConfigAsync完了後の検証

---

### ResolveConfigPath（設定ファイルパス解決）

**機能：** 設定ファイルの実パス解決

**Input:** configFileName（string型）

**Output:** 実際のファイルパス（string型）

**解決順序:**
1. ./config/[fileName]
2. ./[fileName]
3. 環境変数ANDON_CONFIG_PATH

**使用箇所:**
- LoadConfigAsync内部処理

---

### ParseDeviceRange（デバイス範囲パース）

**機能：** デバイス範囲文字列のパース

**Input:** deviceRange（string型、例："M000-M999"）

**Output:** (deviceType, startNumber, endNumber)のタプル

**処理例:**
- "M000-M999" → ("M", 0, 999)
- "D100-D500" → ("D", 100, 500)

**エラーハンドリング:**
- 不正形式時は例外スロー（FormatException）

**使用箇所:**
- PrepareDeviceRequestInfo内部処理

---

## PlcCommunicationManager ヘルパーメソッド

### ValidateConnection（接続状態検証）

**機能：** 現在の接続状態の検証

**Input:** なし（内部状態を使用）

**Output:** bool（接続中：true、未接続：false）

**検証内容:**
- ソケット存在チェック
- ソケット接続状態チェック（Socket.Connected）
- 内部フラグチェック（_isConnected）

**使用箇所:**
- SendFrameAsync、ReceiveResponseAsync開始時

---

### CalculateResponseTime（応答時間計算）

**機能：** 送受信間の応答時間計算

**Input:**
- sendTime（DateTime型）：送信時刻
- receiveTime（DateTime型）：受信時刻

**Output:** TimeSpan（応答時間）

**使用箇所:**
- ReceiveResponseAsync完了時
- ConnectionStats更新時

---

### UpdateConnectionStats（統計情報更新）

**機能：** 通信統計情報の更新

**Input:**
- statType（enum型）：統計種別（Send/Receive/Error等）
- value（object型）：更新値

**Output:** void

**更新対象:**
- フレーム数カウンター
- バイト数カウンター
- 応答時間リスト
- エラーカウンター

**使用箇所:**
- SendFrameAsync、ReceiveResponseAsync完了時

---

### DetermineFrameType（フレームタイプ判定）

**機能：** 受信フレームのタイプ判定（3E/4E、ASCII/Binary）

**Input:** rawData（string型、16進数文字列）

**Output:** (frameVersion, isBinary)のタプル

**判定ロジック:**
- サブヘッダー解析（先頭2-4バイト）
  - Binary 3E: D0 00
  - Binary 4E: D4 00
  - ASCII 3E: "D0"
  - ASCII 4E: "D4"

**使用箇所:**
- ProcessReceivedRawData内部処理

---

## SlmpDataParser（静的ユーティリティクラス）

### 機能概要

SLMP関連データ変換の静的メソッド集

**実装場所:**
- Andon.Utilities.SlmpDataParser

**設計目的:**
- データ変換処理の集約
- 再利用性の向上
- テスト容易性の確保

---

### メソッド一覧

詳細は「Step6_受信データ解析.md」を参照

- DecodeBcd(byte[] data)：BCDデコード
- UnpackBits(byte[] data)：ビット展開
- HexStringToBytes(string hexString)：16進数文字列→バイト配列
- BytesToHexString(byte[] data)：バイト配列→16進数文字列
- ExtractWordDwordData(byte[] buffer, int splitPos)：Word/Dword分離
- ParseAsciiHex(string asciiData, int startIndex, int length)：ASCII16進数パース
- ParseAsciiBitData(string asciiData)：ASCIIビットパース
- ParseAsciiWordData(string asciiData)：ASCIIワードパース
- ParseBinaryBitData(byte[] binaryData, int count)：Binaryビットパース
- ParseBinaryWordData(byte[] binaryData)：Binaryワードパース

---

## CsvFileWriter ヘルパーメソッド

### GenerateFileName（ファイル名生成）

**機能：** CSV出力ファイル名の生成

**Input:**
- targetName（string型）：データ識別名
- continuousMode（bool型）：継続データモード
- timestamp（DateTime型、オプション）：タイムスタンプ

**Output:** ファイル名（string型）

**生成規則:**
- continuousMode=false：`{targetName}_yyyyMMdd_HHmmss.csv`
- continuousMode=true：`{targetName}_continuous.csv`

**使用箇所:**
- WriteToFileAsync内部処理

---

### FormatCsvRow（CSVデータ行フォーマット）

**機能：** 構造化データのCSV行文字列への変換

**Input:**
- deviceData（Dictionary<string, object>型）：デバイスデータ
- timestamp（DateTime型）：タイムスタンプ

**Output:** CSV行文字列（string型）

**フォーマット:**
- タイムスタンプ（ISO 8601形式） + デバイス値（カンマ区切り）
- 例：`2025-01-01T12:00:00,true,false,1234,5678`

**エスケープ処理:**
- カンマを含む値のダブルクォート囲み
- ダブルクォートのエスケープ（""）

**使用箇所:**
- WriteToFileAsync内部処理

---

### EnsureDirectoryExists（ディレクトリ存在確認）

**機能：** 出力先ディレクトリの存在確認・作成

**Input:** filePath（string型）：出力ファイルパス

**Output:** void（例外スロー方式）

**処理内容:**
- ディレクトリパスの抽出
- 存在確認
- 不存在時の作成（Directory.CreateDirectory）

**エラーハンドリング:**
- アクセス権限エラー
- パス不正エラー

**使用箇所:**
- WriteToFileAsync開始時

---

## 共通ユーティリティ

### DateTimeHelper（日時関連ユーティリティ）

#### GetUtcNowMilliseconds
**機能：** 現在時刻のUTCミリ秒取得

**Output:** long（Unixエポックからのミリ秒）

**使用箇所:**
- タイムスタンプ記録
- パフォーマンス計測

---

#### FormatTimestamp
**機能：** タイムスタンプの標準フォーマット

**Input:** timestamp（DateTime型）

**Output:** フォーマット済み文字列（ISO 8601形式）

**使用箇所:**
- ログ出力
- CSV出力

---

### MemoryHelper（メモリ関連ユーティリティ）

#### GetCurrentMemoryUsageKB
**機能：** 現在のメモリ使用量取得

**Output:** long（KB単位のメモリ使用量）

**使用箇所:**
- メモリ監視
- 低メモリモード判定

---

#### ForceGarbageCollection
**機能：** 強制ガベージコレクション実行

**Input:** なし

**Output:** void

**注意:**
- 通常は自動GCに任せる
- 明示的な解放が必要な場合のみ使用

**使用箇所:**
- 低メモリ警告時
- 長時間稼働後のメモリ最適化

---

### ValidationHelper（検証関連ユーティリティ）

#### IsValidIpAddress
**機能：** IPアドレス形式の検証

**Input:** ipAddress（string型）

**Output:** bool（有効：true、無効：false）

**検証内容:**
- IPv4形式チェック
- IPv6形式チェック（オプション）

---

#### IsValidPortNumber
**機能：** ポート番号の検証

**Input:** port（int型）

**Output:** bool（有効：true、無効：false）

**検証内容:**
- 範囲チェック（1-65535）

---

#### IsValidDeviceCode
**機能：** デバイスコードの検証

**Input:** deviceCode（string型）

**Output:** bool（有効：true、無効：false）

**検証内容:**
- サポートデバイスコードとの照合
- 対応表：
  - M: 90
  - D: A8
  - X: 9C
  - Y: 9D
  - その他（仕様書準拠）

---

## 設計方針

### 静的メソッド優先
- 状態を持たない処理は静的メソッドとして実装
- インスタンス化のオーバーヘッド回避

### 単一責務原則
- 各ヘルパーメソッドは1つの責務のみ
- 複雑な処理は適切に分割

### 再利用性
- 複数箇所で利用可能な汎用性
- 依存関係の最小化

### テスト容易性
- 入出力が明確
- 副作用の最小化
- モック不要な設計
