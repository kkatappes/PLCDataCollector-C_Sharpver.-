# メモリ・リソース管理

◆基本方針
    ・システム保護を最優先とする
    ・他アプリケーションへの影響を最小化
    ・データ保護は可能な範囲で実施
    ・予防的制御による安定動作を重視

**メモリ使用量の段階的制御により安定動作を維持**

◆監視対象
    ・メモリ使用量（アプリケーション全体）
    ・データバッファサイズ
    ・ログバッファサイズ

◆制限値・閾値設定
- SystemResourcesConfig活用項目
    ・MemoryLimitKB: 512KB（アプリケーション全体の使用上限）
    ・MaxBufferSize: 2048バイト（単一処理での最大バッファ）
    ・MemoryThresholdKB: 256KB（警告レベルの閾値）

- 段階的制御レベル
    ・正常レベル: メモリ使用率 ～70%以下
    →全機能有効、通常処理
    ・注意レベル: メモリ使用率 ～85%以下
    →詳細ログ削減、バッファ最適化
    ・警告レベル: メモリ使用率 ～95%以下
    →新規データ取得制限、古いデータ優先削除
    ・危険レベル: メモリ使用率 ～100%
    →データ取得完全停止、緊急データ保存

◆監視方法
- 監視タイミング
    ・リアルタイム監視: データ処理前後
    ・定期監視: 1秒間隔
    ・詳細監視: 10秒間隔（ログ出力用）

- 監視項目
    ・現在のメモリ使用量
    ・使用率（usedKB/MemoryLimitKB × 100%）
    ・最大使用量（起動後のピーク値）
    ・ガベージコレクション発生回数

◆データ管理ポリシー
- 保持期間
    ・受信データ: 最大10分または1000件
    ・解析済みデータ: 出力完了後即座に削除
    ・ログデータ: 設定に従いローテーション

- 削除優先順位
    ・古いデータから順次削除
    ・出力済みデータを優先削除
    ・重要度の低いログから削除

◆各レベルでの具体的制御動作
- 正常レベル（0-70%）
    ・全機能有効
    ・通常の処理間隔
    ・詳細ログ出力

- 注意レベル（70-85%）
    ・非重要ログの削減
    ・バッファサイズの最適化
    ・データ保持期間の短縮

- 警告レベル（85-95%）
    ・新規データ取得を制限
    ・緊急データのみ処理
    ・不要なキャッシュを削除

- 危険レベル（95-100%）
    ・データ取得完全停止
    ・重要データの緊急保存
    ・システム保護モードに移行

◆復旧条件
- 正常レベルへの復旧条件
    ・メモリ使用率が70%以下に回復
    ・ガベージコレクション完了確認

- 段階的復旧
    ・危険→警告: 使用率が90%以下
    ・警告→注意: 使用率が80%以下
    ・注意→正常: 使用率が70%以下

◆異常時の対応
- メモリ使用量超過時
    ・MemoryLimitKB超過
    →クリーンアップ実行
    ・MemoryThresholdKB超過
    →警告ログ出力、制御レベル変更
    ・MaxBufferSize超過
    →データ分割処理、バッファサイズ調整

- リソース枯渇時の優先度
    ・最優先: 既取得データの安全な保存
    ・次点: 新規データ取得の制限
    ・最後: 詳細ログ出力の削減

◆実装制御機能
**ResourceManagerクラス による統合制御**

- メモリ使用量監視機能
    ・システムAPI連携でリアルタイム取得
    ・各コンポーネント別使用量の詳細把握
    ・GCメモリ・プロセス作業セット両方を監視

- メモリレベル自動判定機能
    ・Normal（正常）: 70%以下 → 全機能有効
    ・Warning（注意）: 70-85% → ログ削減・バッファ最適化
    ・Critical（危険）: 85%以上 → データ取得制限・緊急保存
    ・設定値（MemoryLimitKB、MemoryThresholdKB）基準で自動判定

- データ・ログポリシー適用機能
    ・メモリレベルに応じた制御ポリシー自動適用
    ・MaxBufferSize、LowMemoryMode設定の動的制御
    ・各レベルでの具体的制限内容を自動実行

- メモリ最適化実行機能
    ・対象: PlcCommunicationManager、ConfigToFrameManager、LoggingManager
    ・レベル別最適化: 軽度クリーンアップ～強制GC実行
    ・削減メモリ量の定量的把握・報告

- メモリ状況ログ出力機能
    ・使用状況・レベル・最適化結果の詳細記録
    ・ファイル・コンソール両方への出力対応
    ・運用監視・トラブルシューティング支援

- 監視ループ実行機能
    ・MonitoringIntervalMs設定に従う継続監視
    ・各監視項目の定期チェック・制御実行
    ・異常検知時の即座な制御レベル変更

◆システム連携制御
**他コンポーネントとの協調動作**

- 設定管理との連携
    ・ConfigToFrameManager.LoadConfigAsync()から制限値取得
    ・SystemResourcesConfig設定の動的反映
    ・設定変更時の制御パラメータ自動更新

- PLC通信との連携
    ・PlcCommunicationManager各メソッドのメモリ使用監視
    ・通信バッファサイズの動的制御
    ・データ受信制限の自動適用

- ログシステムとの連携
    ・LoggingManager.LogStateAsync()での状況記録
    ・ログ出力レベルの動的制御
    ・メモリ不足時のログ削減実行

- データ出力との連携
    ・DataOutputManager処理でのメモリ使用量監視
    ・出力完了データの即座削除制御
    ・出力待機データの優先度制御

◆監視・制御の実装詳細
**具体的な監視・制御方式**

- 監視タイミング制御
    ・リアルタイム: データ処理直前・直後での使用量チェック
    ・定期監視: 1秒間隔での使用率・レベル判定
    ・詳細監視: 10秒間隔での統計情報・ログ出力
    ・MonitoringIntervalMs設定値との協調制御

- メモリ使用量取得方式
    ・GC.GetTotalMemory(): マネージドヒープ使用量
    ・Process.WorkingSet64: プロセス全体の物理メモリ使用量
    ・各クラス内部状態: バッファ・キャッシュサイズ
    ・KB単位での精密な使用量把握

- 制御実行方式
    ・予防的制御: 閾値到達前の段階的制限適用
    ・即座制御: 危険レベル到達時の緊急処理実行
    ・復旧制御: 使用量回復時の段階的機能復帰
    ・統計記録: 制御実行結果・効果の定量的記録