# メモリ・リソース管理

◆基本方針
    ・システム保護を最優先とする
    ・他アプリケーションへの影響を最小化
    ・データ保護は可能な範囲で実施
    ・予防的制御による安定動作を重視

**メモリ使用量の段階的制御により安定動作を維持**

◆監視対象
    ・メモリ使用量（アプリケーション全体）
    ・データバッファサイズ
    ・ログバッファサイズ
    ・ファイルハンドル数
    ・スレッド数

◆制限値・閾値設定
- SystemResourcesConfig活用項目
    ・MemoryLimitKB: 512KB（アプリケーション全体の使用上限）
    ・MaxBufferSize: 2048バイト（単一処理での最大バッファ）
    ・MemoryThresholdKB: 256KB（警告レベルの閾値）

- 段階的制御レベル
    ・正常レベル: 0-70%使用率
    →全機能有効、通常処理
    ・注意レベル: 70-85%使用率
    →詳細ログ削減、バッファ最適化
    ・警告レベル: 85-95%使用率
    →新規データ取得制限、古いデータ優先削除
    ・危険レベル: 95-100%使用率
    →データ取得完全停止、緊急データ保存

◆監視方法
- 監視タイミング
    ・リアルタイム監視: データ処理前後
    ・定期監視: 1秒間隔
    ・詳細監視: 10秒間隔（ログ出力用）

- 監視項目
    ・現在のメモリ使用量
    ・使用率（現在値/上限値 × 100%）
    ・最大使用量（起動後のピーク値）
    ・ガベージコレクション発生回数

◆データ管理ポリシー
- 保持期間
    ・受信データ: 最大10分または1000件
    ・解析済みデータ: 出力完了後即座に削除
    ・ログデータ: 設定に従いローテーション

- 削除優先順位
    ・古いデータから順次削除
    ・出力済みデータを優先削除
    ・重要度の低いログから削除

◆各レベルでの具体的制御動作
- 正常レベル（0-70%）
    ・全機能有効
    ・通常の処理間隔
    ・詳細ログ出力

- 注意レベル（70-85%）
    ・非重要ログの削減
    ・バッファサイズの最適化
    ・データ保持期間の短縮

- 警告レベル（85-95%）
    ・新規データ取得を制限
    ・緊急データのみ処理
    ・不要なキャッシュを削除

- 危険レベル（95-100%）
    ・データ取得完全停止
    ・重要データの緊急保存
    ・システム保護モードに移行

◆復旧条件
- 正常レベルへの復旧条件
    ・メモリ使用率が70%以下に回復
    ・ガベージコレクション完了確認

- 段階的復旧
    ・危険→警告: 使用率が90%以下
    ・警告→注意: 使用率が80%以下
    ・注意→正常: 使用率が70%以下

◆異常時の対応
- メモリ使用量超過時
    ・MemoryLimitKB超過
    →緊急クリーンアップ実行
    ・MemoryThresholdKB超過
    →警告ログ出力、制御レベル変更
    ・MaxBufferSize超過
    →データ分割処理、バッファサイズ調整

- リソース枯渇時の優先度
    ・最優先: 既取得データの安全な保存
    ・次点: 新規データ取得の制限
    ・最後: 詳細ログ出力の削減