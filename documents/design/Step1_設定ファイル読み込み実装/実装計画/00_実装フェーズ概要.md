# Step1: 設定ファイル読み込み - 実装フェーズ概要

## 文書の目的

Step1_最終設計仕様.mdの長大な内容を、段階的に実装できるよう5つのフェーズに分割しました。
各フェーズは独立してテスト・検証可能な単位となっており、順次実装することで確実にStep1を完成させることができます。

---

## 実装フェーズ一覧

### Phase1: 基本設計とモデル定義
**ファイル**: Phase1_基本設計とモデル定義.md

**目的**: Step1の基盤となるモデルクラスと定数クラスを実装

**主要実装内容**:
- PlcConfigurationクラス（設定情報保持）
- DeviceSpecificationクラス（デバイス情報保持）
- DeviceCodeMapクラス（24種類デバイスコード変換）
- SlmpFixedSettingsクラス（固定通信パラメータ）

**成果物**:
- 基本的なデータ構造の確立
- デバイスコード変換機能
- 固定通信パラメータ定義

**依存関係**: なし（最初に実装）

---

### Phase2: Excel読み込み基礎機能
**ファイル**: Phase2_Excel読み込み基礎機能.md

**目的**: Excelファイルを検索・読み込み、基本的な設定情報を取得

**主要実装内容**:
- Excelファイル検索機能（DiscoverExcelFiles）
- ファイルロック確認機能（IsFileLocked）
- "settings"シート読み込み（5項目）
- "データ収集デバイス"シート読み込み（基礎）
- 複数ファイル一括読み込み（LoadAllPlcConnectionConfigs）

**成果物**:
- ConfigurationLoaderクラス（基礎実装）
- Excel読み込み機能
- EPPlusライブラリ導入

**依存関係**: Phase1

---

### Phase3: デバイス情報変換と正規化
**ファイル**: Phase3_デバイス情報変換と正規化.md

**目的**: Excelから読み込んだデバイス情報を、SLMP通信フレームで使用できる形式に変換

**主要実装内容**:
- デバイス情報正規化処理（NormalizeDevice）
- デバイス番号バイト変換処理（ConvertDeviceNumberToBytes）
- 10進デバイス変換アルゴリズム
- 16進デバイス変換アルゴリズム

**成果物**:
- デバイス情報の完全な正規化
- 3バイトリトルエンディアン変換
- 24種類全デバイス対応

**依存関係**: Phase1, Phase2

---

### Phase4: ビット最適化とバリデーション
**ファイル**: Phase4_ビット最適化とバリデーション.md

**目的**: 設定全体の妥当性を検証（必須）、ビット最適化（オプション）

**主要実装内容**:
- **必須**: 設定検証処理（ValidateConfiguration）
  - 接続情報検証（IPアドレス、ポート）
  - データ取得周期検証
  - デバイスリスト検証
  - 総点数制限チェック（255点）
  - 出力設定検証
- **オプション**: ビットデバイス最適化（OptimizeBitDevices）
  - 16点単位ワード化
  - 通信効率向上

**成果物**:
- 完全な設定検証機能
- エラー早期検出
- （オプション）通信最適化

**依存関係**: Phase1, Phase2, Phase3

**注意**: ビット最適化は複雑なため、Phase4では必須のバリデーション機能のみ実装し、最適化はPhase5で余力があれば実装

---

### Phase5: 複数設定管理と統合
**ファイル**: Phase5_複数設定管理と統合.md

**目的**: 複数のPLC設定を一元管理し、Step1全体を完成させる

**主要実装内容**:
- MultiPlcConfigManagerクラス実装
  - 複数設定の保持と管理
  - 名前ベースでの設定取得
  - 統計情報取得
- ConfigurationLoaderとの統合
- DIコンテナへの登録

**成果物**:
- 複数PLC設定管理機能
- Step1の完全実装
- Step2への橋渡し

**依存関係**: Phase1, Phase2, Phase3, Phase4

**オプション機能**（余力がある場合）:
- ビットデバイス最適化（Phase4でスキップした場合）
- 設定ファイル変更監視（ConfigurationWatcher）

---

## 実装順序とマイルストーン

```
Phase1 → Phase2 → Phase3 → Phase4 → Phase5
  ↓        ↓        ↓        ↓        ↓
基礎    Excel    変換     検証     統合
       読込     正規化

各フェーズでテスト・検証を実施
```

### マイルストーン

| Phase | 完了条件 | テスト対象 |
|-------|---------|-----------|
| Phase1 | モデルクラス・定数クラス実装完了 | DeviceCodeMap、SlmpFixedSettings |
| Phase2 | Excel読み込み機能完了 | ConfigurationLoader（基礎） |
| Phase3 | デバイス情報変換完了 | NormalizeDevice、ConvertDeviceNumberToBytes |
| Phase4 | 設定検証機能完了 | ValidateConfiguration |
| Phase5 | 複数設定管理完了、Step1完成 | MultiPlcConfigManager、統合テスト |

---

## 各フェーズの読み方

### 1. まず全体構造を把握
各フェーズの文書は以下の構造になっています：
- Phase目的
- 実装対象機能
- 詳細設計
- 成功条件
- テスト計画
- 実装手順

### 2. 実装前の確認事項
- 前フェーズの完了を確認
- 必要な依存ライブラリの導入
- テストデータの準備

### 3. 実装中の作業フロー
1. 実装対象機能の理解
2. 詳細設計の確認
3. コード実装
4. 単体テスト作成・実行
5. 統合テスト作成・実行
6. 成功条件のチェック
7. 次フェーズへ

### 4. 実装後の確認
- 全テストがパスしていること
- 成功条件を満たしていること
- ログ出力が適切であること
- エラーハンドリングが正しく動作すること

---

## 推奨される実装スケジュール

### 1日目: Phase1
- モデルクラス定義
- 定数クラス実装
- 単体テスト作成・実行
- **目標**: 基礎構造の確立

### 2日目: Phase2
- EPPlusライブラリ導入
- Excel読み込み機能実装
- テスト用Excelファイル作成
- 単体テスト作成・実行
- **目標**: Excel読み込み機能の完成

### 3日目: Phase3
- デバイス情報変換実装
- 10進/16進デバイス変換実装
- 単体テスト作成・実行
- **目標**: デバイス情報正規化の完成

### 4日目: Phase4
- 設定検証機能実装
- エラーケース用Excelファイル作成
- 単体テスト作成・実行
- **目標**: バリデーション機能の完成

### 5日目: Phase5
- MultiPlcConfigManager実装
- ConfigurationLoaderとの統合
- 統合テスト作成・実行
- **目標**: Step1全体の完成

**注意**: 上記はあくまで目安です。実際の進行状況に応じて調整してください。

---

## トラブルシューティング

### Phase1での問題

**問題**: DeviceCodeMapで正しいコードが返らない
- **原因**: デバイス名の大文字小文字が異なる
- **対処**: ToUpper()で統一

### Phase2での問題

**問題**: Excelファイルが読み込めない
- **原因1**: ファイルが開かれている → IsFileLocked()で除外
- **原因2**: EPPlusライセンス未設定 → LicenseContext.NonCommercial設定

### Phase3での問題

**問題**: 16進デバイスの変換が正しくない
- **原因**: Excelの値が10進数で記載されている
- **対処**: ToString("X6")で16進文字列に変換後、3バイトに分割

### Phase4での問題

**問題**: 総点数計算が正しくない
- **原因**: Dwordを2点として計算していない
- **対処**: totalDwordPoints * 2 として計算

### Phase5での問題

**問題**: 設定が重複して登録される
- **原因**: ConfigurationNameが同じファイル名になっている
- **対処**: ログで警告し、上書き処理

---

## 参考資料

### 元文書
- `Step1_最終設計仕様.md` - 全体設計書

### 関連設計書
- `設定読み込み仕様.md` - 出力JSON構造
- `memo.md` - PLC送信フレーム仕様
- `CLAUDE.md` - プロジェクト構造

### 参考実装
- ConMoni (sample) - Step1処理フロー
- ConMoniデバイスコード変換テーブル（24種類）

---

## Step1完成後の次のステップ

Phase5完了により、Step1の全機能が完成します。

### Step2への移行

**Step2: フレーム構築**
- ConfigToFrameManager.BuildReadRandomFrameFromConfig()
- SlmpFrameBuilder.BuildReadRandomRequest()
- デバイス指定部分の構築
- フレームヘッダの結合

**Step1からの引き継ぎ**:
- PlcConfiguration → Step2で使用
- DeviceSpecification → フレーム構築に使用
- SlmpFixedSettings → フレームヘッダ構築に使用

---

## 最終確認チェックリスト

Step1完成前に以下を確認：

### ✅ 機能面
- [ ] 実行フォルダ内の全.xlsxファイルを自動検出できる
- [ ] Excelの"settings"シートから5項目を正確に読み込める
- [ ] Excelの"データ収集デバイス"シートから全デバイス情報を読み込める
- [ ] デバイスコード24種類全てに対応できる
- [ ] 10進/16進デバイスを正しく判別・変換できる
- [ ] 不正な設定値を検出してエラーを返す
- [ ] 複数のExcelファイルを同時に管理できる
- [ ] 通信設定が全てmemo.md送信フレームと一致する

### ✅ テスト面
- [ ] 全単体テストがパスする
- [ ] 全統合テストがパスする
- [ ] エラーケースで適切な例外がスローされる
- [ ] ログ出力が適切に行われる

### ✅ ドキュメント面
- [ ] 実装記録が作成されている
- [ ] テスト結果が記録されている
- [ ] 判断根拠が記録されている

---

**作成日**: 2025年11月26日
**最終更新**: 2025年11月26日
