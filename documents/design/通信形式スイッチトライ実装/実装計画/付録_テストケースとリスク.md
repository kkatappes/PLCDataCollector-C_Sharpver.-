# 付録: テストケース一覧、リスク、拡張案、スケジュール

**最終更新**: 2025-11-28

## テストケース一覧（TDD順）

### Phase 1: ConnectionResponseモデル拡張テスト

| テストID | テスト名 | Red状態 | Green状態 | 検証内容 |
|---------|---------|---------|----------|---------|
| TC_P1_001 | UsedProtocol_初期TCP成功時_TCPを返す | コンパイルエラー | テスト成功 | UsedProtocolプロパティの存在と値 |
| TC_P1_002 | IsFallbackConnection_代替プロトコル使用時_Trueを返す | コンパイルエラー | テスト成功 | IsFallbackConnectionプロパティの存在と値 |
| TC_P1_003 | FallbackErrorDetails_初期プロトコル失敗時_エラー詳細を保持 | コンパイルエラー | テスト成功 | FallbackErrorDetailsプロパティの存在と値 |

### Phase 2: 接続ロジック実装テスト（PlcCommunicationManagerTests.cs）

| テストID | テスト名 | Red状態 | Green状態 | 検証内容 |
|---------|---------|---------|----------|---------|
| TC_P2_001 | ConnectAsync_初期TCP成功_TCPで接続しIsFallbackConnectionがFalse | Assert失敗 | テスト成功 | 初期プロトコル成功時の動作 |
| TC_P2_002 | ConnectAsync_初期UDP成功_UDPで接続しIsFallbackConnectionがFalse | Assert失敗 | テスト成功 | UDP初期プロトコル成功時の動作 |
| TC_P2_003 | ConnectAsync_TCP失敗UDP成功_UDPで接続しIsFallbackConnectionがTrue | Assert失敗 | テスト成功 | TCP→UDP代替プロトコル切替 |
| TC_P2_004 | ConnectAsync_UDP失敗TCP成功_TCPで接続しIsFallbackConnectionがTrue | Assert失敗 | テスト成功 | UDP→TCP代替プロトコル切替 |
| TC_P2_005 | ConnectAsync_両プロトコル失敗_失敗ステータスと詳細エラー | Assert失敗 | テスト成功 | 両プロトコル失敗時のエラー情報 |
| TC_P2_006 | ConnectAsync_タイムアウト処理_指定時間内に完了 | Assert失敗 | テスト成功 | タイムアウト設定の適用 |

### Phase 3: ログ出力実装テスト（PlcCommunicationManagerTests.cs）

| テストID | テスト名 | Red状態 | Green状態 | 検証内容 |
|---------|---------|---------|----------|---------|
| TC_P3_001 | ConnectAsync_初期プロトコル成功_接続開始ログのみ出力 | Verify失敗 | テスト成功 | 初期成功時のログ出力 |
| TC_P3_002 | ConnectAsync_代替プロトコル成功_警告ログと成功ログ出力 | Verify失敗 | テスト成功 | 代替成功時のログ出力 |
| TC_P3_003 | ConnectAsync_両プロトコル失敗_詳細エラーログ出力 | Verify失敗 | テスト成功 | 失敗時のログ出力 |

### Phase 4: 統合テスト（Step3_6_IntegrationTests.cs）

| テストID | テスト名 | Red状態 | Green状態 | 検証内容 |
|---------|---------|---------|----------|---------|
| TC_P4_001 | Integration_TCPからUDPへの自動切り替え_正常にデータ送受信 | Assert失敗 | テスト成功 | TCP→UDP切替での送受信動作 |
| TC_P4_002 | Integration_UDPからTCPへの自動切り替え_正常にデータ送受信 | Assert失敗 | テスト成功 | UDP→TCP切替での送受信動作 |
| TC_P4_003 | Integration_両プロトコル失敗_適切なエラーハンドリング | Assert失敗 | テスト成功 | 完全失敗時の統合動作 |

### Phase 5: 実機テスト

| テストID | テスト名 | テスト環境 | 期待結果 |
|---------|---------|----------|---------|
| TC_P5_001 | 実機_TCP接続のみ許可環境 | TCP許可/UDP拒否 | 初期TCPで接続成功 |
| TC_P5_002 | 実機_UDP接続のみ許可環境 | TCP拒否/UDP許可 | TCP失敗→UDP切替成功 |
| TC_P5_003 | 実機_ネットワーク遮断環境 | 全プロトコル拒否 | 両プロトコル失敗、適切なエラーメッセージ |

## リスクと対策

### リスク1: タイムアウト時間の倍増

**内容:**
両プロトコル試行により、接続確立までの最大時間が2倍になる

**影響度:** 中
**発生確率:** 高（初期プロトコルが誤設定の場合）

**対策:**
- 初期プロトコルの選択を適切に行う（環境に応じた推奨設定のドキュメント化）
- タイムアウト値を適切に設定（デフォルト5秒 = 最大10秒）
- 将来的に並行試行の検討（オプション機能として）

**対策の実施状況:**
- [ ] ドキュメントに推奨設定を記載
- [ ] デフォルトタイムアウト値の妥当性確認
- [ ] 並行試行オプションの検討（将来）

---

### リスク2: ログの増加

**内容:**
代替プロトコルでの接続が常態化した場合、警告ログが大量に出力される

**影響度:** 低
**発生確率:** 中（設定ミスが放置された場合）

**対策:**
- 初回警告後は定期的な警告のみ出力（例: 1時間ごと）
- 設定ファイルの修正を促すメッセージを出力
- ログレベルによる出力制御

**対策の実施状況:**
- [ ] 定期的な警告出力の実装（将来）
- [ ] 設定修正を促すメッセージの追加（Phase 3で実施済み）
- [ ] ログレベル制御の確認

---

### リスク3: PLC側の負荷

**内容:**
複数プロトコルでの接続試行がPLCに負荷をかける可能性

**影響度:** 低
**発生確率:** 低（通常のPLCは両プロトコルに対応）

**対策:**
- 接続試行間に適切な待機時間を設ける（オプション）
- PLC側の接続ログを確認し、問題がないことを検証

**対策の実施状況:**
- [ ] 待機時間オプションの検討（将来）
- [ ] 実機テストでPLC側のログ確認（Phase 5で実施）

---

### リスク4: 既存コードへの影響

**内容:**
ConnectionResponseの変更により、既存の呼び出し元に影響が出る可能性

**影響度:** 低
**発生確率:** 低（新規プロパティは全てオプショナル）

**対策:**
- 新規プロパティは全てnull許容またはデフォルト値あり
- 既存テストの実行で影響範囲を確認
- 影響箇所があれば優先的に修正

**対策の実施状況:**
- [x] 新規プロパティのnull許容設計（Phase 1で実施済み）
- [ ] 既存テスト実行での影響確認（Phase 2-4で実施）
- [ ] 影響箇所の修正（必要に応じて）

---

## 今後の拡張案

### 拡張1: 並行試行モード（オプション）

**概要:**
両プロトコルを同時に試行し、先に成功した方を使用する。

**メリット:**
- 接続時間を短縮できる（最大タイムアウト時間が半分になる）
- ユーザー体験の向上

**デメリット:**
- 実装複雑度が増加
- PLC側の負荷が一時的に増加
- リソース消費（ソケット2つ同時使用）

**実装優先度:** 低
**実装時期:** 現行機能の安定動作確認後

---

### 拡張2: 成功プロトコルの記憶

**概要:**
前回成功したプロトコルを記憶し、次回接続時に優先的に使用する。

**メリット:**
- 初回接続時間が短縮される（成功率が高いプロトコルを優先）
- ネットワーク環境に自動適応

**デメリット:**
- 状態管理が必要（メモリまたはファイル）
- ネットワーク環境変更時に古い情報が悪影響

**実装方法:**
1. メモリ内保持（アプリケーション再起動で初期化）
2. 設定ファイルへの自動反映（永続化）

**実装優先度:** 中
**実装時期:** 現行機能の運用実績確認後

---

### 拡張3: プロトコル切り替え通知

**概要:**
代替プロトコルで接続した場合、外部システムへの通知機能（メール、Slack等）。

**メリット:**
- 設定ミスの早期発見
- 運用担当者への即時通知

**デメリット:**
- 外部システム連携の実装が必要
- 通知先の設定が必要

**実装優先度:** 低
**実装時期:** 運用要件が明確になった後

---

### 拡張4: プロトコル切り替え統計

**概要:**
プロトコル切り替えの発生頻度・傾向を統計データとして記録。

**メリット:**
- ネットワーク環境の問題点を可視化
- 設定最適化の指標

**デメリット:**
- データ記録・分析機能の実装が必要

**実装優先度:** 低
**実装時期:** 運用データ分析が必要になった時点

---

## 実装スケジュール（TDD順、想定工数）

| Phase | ステップ | 作業内容 | 想定工数 | 備考 |
|-------|---------|---------|---------|------|
| **Phase 1** | **Red** | ConnectionResponseテスト作成（失敗状態） | 0.5h | コンパイルエラー確認 |
|  | **Green** | ConnectionResponseに新規プロパティ追加 | 0.3h | テスト成功確認 |
|  | **Refactor** | XMLコメント追加・妥当性確認 | 0.2h | テスト成功維持 |
| | **小計** | | **1h** | |
| **Phase 2** | **Red** | ConnectAsyncテスト作成（失敗状態） | 1h | Assert失敗確認 |
|  | **Green** | 代替プロトコル試行ロジック実装 | 1.5h | テスト成功確認 |
|  | **Refactor** | 重複コード削除・メッセージ統一 | 0.5h | テスト成功維持 |
| | **小計** | | **3h** | |
| **Phase 3** | **Red** | ログ出力検証テスト作成（失敗状態） | 0.5h | Verify失敗確認 |
|  | **Green** | ログ出力実装 | 0.3h | テスト成功確認 |
|  | **Refactor** | ログメッセージ集約・メソッド分離 | 0.2h | テスト成功維持 |
| | **小計** | | **1h** | |
| **Phase 4** | **Red** | 統合テスト作成（失敗状態） | 0.5h | Assert失敗確認 |
|  | **Green** | 統合動作確認・必要に応じて修正 | 1h | テスト成功確認 |
|  | **Refactor** | テストケース追加・モック共通化 | 0.5h | テスト成功維持 |
| | **小計** | | **2h** | |
| **Phase 5** | **Red** | 実機テストシナリオ作成 | 0.3h | 失敗基準明確化 |
|  | **Green** | 実機検証実施・修正 | 0.5h | 全シナリオ成功 |
|  | **Refactor** | ドキュメント整備 | 0.2h | 実装完了レビュー |
| | **小計** | | **1h** | |
| **合計** | | | **8h** | 各Phase後にテスト成功を確認 |

**注意事項:**
- 各PhaseでRed→Green→Refactorサイクルを厳守
- Greenステップ完了時点でテスト成功を必ず確認
- Refactorステップでテスト成功が維持されることを確認
- 次のPhaseに進む前に、現在のPhaseの全テストが成功していることを確認

---

## 承認・レビュー

| 項目 | 担当者 | 日付 | ステータス |
|-----|-------|------|----------|
| 設計レビュー | - | - | 未実施 |
| 実装レビュー | - | - | 未実施 |
| テストレビュー | - | - | 未実施 |
| 最終承認 | - | - | 未実施 |

---

## 関連ドキュメント

### 設計ドキュメント
- `documents/design/クラス設計.md`: PlcCommunicationManagerの詳細設計
- `documents/design/エラーハンドリング.md`: エラー処理方針
- `documents/design/ログ機能設計.md`: ログ出力仕様

### 実装計画ドキュメント
- `documents/design/step1-3テスト/実装計画/Phase4_JSON廃止計画.md`: JSON廃止・Excel専用システム移行計画
- `documents/design/Step1_設定ファイル読み込み実装/実装計画/00_実装フェーズ概要.md`: Step1実装フェーズ概要

### その他
- `documents/design/ハードコード実装置き換え対応/ハードコード状況確認.md`: ハードコード値の調査結果

---

## 変更履歴

| 日付 | 変更内容 | 変更者 |
|------|---------|-------|
| 2025-11-28 | 初版作成（Phase 0-5の実装計画） | - |
| 2025-11-28 | Excel専用システム対応（JSON廃止） | - |
