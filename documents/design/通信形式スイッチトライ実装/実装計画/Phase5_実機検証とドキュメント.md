# Phase 5: 実機検証とドキュメント更新

**最終更新**: 2025-11-28

## 概要

実機PLC環境でのテストシナリオ作成・検証を実施し、ドキュメントを整備します。

## 前提条件

- Phase 1完了（ConnectionResponseに新規プロパティ追加済み）
- Phase 2完了（代替プロトコル試行ロジック実装済み）
- Phase 3完了（ログ出力実装済み）
- Phase 4完了（統合テスト完了）

## TDDサイクル

### Step 5-Red: 実機テストシナリオ作成

**作業内容:**
1. 実機環境でのテストシナリオ文書作成:

```markdown
# 実機テストシナリオ

## テスト環境

### 環境1: TCP接続のみ許可
- PLC設定: TCP通信有効、UDP通信無効
- ネットワーク: TCP ポート5000開放、UDP遮断
- 期待動作: TCP接続成功（初期プロトコル）

### 環境2: UDP接続のみ許可
- PLC設定: TCP通信無効、UDP通信有効
- ネットワーク: TCP遮断、UDP ポート5000開放
- 期待動作: TCP失敗→UDP接続成功（代替プロトコル）

### 環境3: ネットワーク遮断
- PLC設定: 正常
- ネットワーク: TCP/UDP両方遮断
- 期待動作: 両プロトコル失敗、適切なエラーメッセージ

## テストシナリオ詳細

### TC_P5_001: TCP接続のみ許可環境

**準備:**
1. Excel設定ファイルの`ConnectionMethod`を"TCP"に設定
2. PLC側でTCP通信を有効化
3. ネットワークでUDP通信を遮断

**実行手順:**
1. アプリケーションを起動
2. PLC接続処理を実行

**期待結果:**
- ✅ 接続成功（Status=Connected）
- ✅ UsedProtocol="TCP"
- ✅ IsFallbackConnection=false
- ✅ ログ: "PLC接続試行開始: ..., プロトコル: TCP"
- ✅ 代替プロトコル試行なし

**判定基準:**
- 接続が5秒以内に完了
- データ送受信が正常に動作
- ログに警告・エラーが出力されない

---

### TC_P5_002: UDP接続のみ許可環境

**準備:**
1. Excel設定ファイルの`ConnectionMethod`を"TCP"に設定
2. PLC側でUDP通信を有効化
3. ネットワークでTCP通信を遮断

**実行手順:**
1. アプリケーションを起動
2. PLC接続処理を実行

**期待結果:**
- ✅ 接続成功（Status=Connected）
- ✅ UsedProtocol="UDP"
- ✅ IsFallbackConnection=true
- ✅ FallbackErrorDetailsに"TCP失敗"の記録あり
- ✅ ログ: "TCP接続失敗: .... 代替プロトコル(UDP)で再試行します。"
- ✅ ログ: "代替プロトコル(UDP)で接続成功: ..."

**判定基準:**
- 接続が10秒以内に完了（TCP試行5秒+UDP試行5秒）
- データ送受信が正常に動作
- 警告ログが1回出力される（TCP失敗の通知）
- エラーログは出力されない

---

### TC_P5_003: ネットワーク遮断環境

**準備:**
1. Excel設定ファイルの`ConnectionMethod`を"TCP"に設定
2. PLC側は正常動作
3. ネットワークでTCP/UDP両方を遮断

**実行手順:**
1. アプリケーションを起動
2. PLC接続処理を実行

**期待結果:**
- ✅ 接続失敗（Status=Failed または Timeout）
- ✅ UsedProtocolはnull
- ✅ ErrorMessageに"TCP/UDP両プロトコルで接続失敗"
- ✅ ErrorMessageに"TCP接続エラー: ..."
- ✅ ErrorMessageに"UDP接続エラー: ..."
- ✅ ログ: "PLC接続失敗: .... TCP/UDP両プロトコルで接続に失敗しました。"

**判定基準:**
- 接続失敗が10秒以内に確定（TCP試行5秒+UDP試行5秒）
- アプリケーションがクラッシュしない
- エラーログが適切に出力される
- エラーメッセージが明確で対処可能

---

## 実機テスト用チェックシート

| 項目 | TC_P5_001 | TC_P5_002 | TC_P5_003 | 備考 |
|-----|-----------|-----------|-----------|------|
| 環境準備完了 | □ | □ | □ | |
| 接続ステータス | □ Connected | □ Connected | □ Failed | |
| UsedProtocol | □ TCP | □ UDP | □ null | |
| IsFallbackConnection | □ false | □ true | □ - | |
| 接続時間（秒） | □ ___ | □ ___ | □ ___ | |
| データ送受信 | □ 成功 | □ 成功 | □ N/A | |
| ログ出力確認 | □ 正常 | □ 正常 | □ 正常 | |
| エラーメッセージ | □ なし | □ なし | □ あり（明確） | |
```

2. 期待結果の明確化（失敗基準の定義）:
   - 接続時間が規定値を超える場合は失敗
   - エラーメッセージが不明確な場合は失敗
   - アプリケーションがクラッシュした場合は失敗

**期待される結果:**
- テストシナリオ文書が作成される
- 各テストケースの期待結果と判定基準が明確

---

### Step 5-Green: 実機検証実施

**作業内容:**
1. 実PLC環境でテストシナリオを実行:
   - TC_P5_001: TCP接続のみ許可環境
   - TC_P5_002: UDP接続のみ許可環境
   - TC_P5_003: ネットワーク遮断環境

2. 問題があれば修正→テスト（Red-Greenサイクル繰り返し）:
   - エラーメッセージの改善
   - タイムアウト値の調整
   - ログ出力の改善

3. 全シナリオ成功を確認

**期待される結果:**
- TC_P5_001: ✅ 成功（TCP接続のみ許可）
- TC_P5_002: ✅ 成功（UDP接続のみ許可）
- TC_P5_003: ✅ 成功（ネットワーク遮断）

**実機テスト結果記録:**
```markdown
# 実機テスト結果

## 実施日時: YYYY-MM-DD HH:MM

### TC_P5_001: TCP接続のみ許可環境
- ✅ 成功
- 接続時間: 2.3秒
- UsedProtocol: TCP
- IsFallbackConnection: false
- 備考: 問題なし

### TC_P5_002: UDP接続のみ許可環境
- ✅ 成功
- 接続時間: 7.8秒（TCP試行5秒+UDP成功2.8秒）
- UsedProtocol: UDP
- IsFallbackConnection: true
- 備考: 警告ログが適切に出力された

### TC_P5_003: ネットワーク遮断環境
- ✅ 成功
- 接続失敗確定時間: 10.0秒
- ErrorMessage: 両プロトコルのエラー詳細あり
- 備考: エラーメッセージが明確
```

---

### Step 5-Refactor: ドキュメント整備

**作業内容:**
1. README更新: 自動プロトコル切り替え機能の説明追加

```markdown
# andon - PLC通信アプリケーション

## 主要機能

### 通信プロトコル自動切り替え
PLC接続時に、設定ファイルで指定されたプロトコル（TCP/UDP）での接続が失敗した場合、自動的に代替プロトコルで再試行します。

**動作:**
- 初期プロトコル（設定ファイル指定）で接続試行
- 失敗時、自動的に代替プロトコルで再試行
- 両プロトコル失敗時、詳細なエラーメッセージを出力

**メリット:**
- ネットワーク環境に応じた柔軟な接続
- 手動設定変更不要
- 接続の信頼性向上
```

2. 運用ガイド更新: トラブルシューティング情報追加

```markdown
# 運用ガイド

## トラブルシューティング

### PLC接続エラー

#### 症状: 「TCP/UDP両プロトコルで接続失敗」エラー

**原因:**
1. PLCの電源が入っていない
2. ネットワーク接続が遮断されている
3. ファイアウォールで両プロトコルが遮断されている

**対処方法:**
1. PLCの電源を確認
2. ネットワークケーブルの接続を確認
3. ファイアウォール設定を確認（TCP/UDPポート5000を開放）

#### 症状: 「TCP接続失敗. 代替プロトコル(UDP)で再試行します。」警告

**原因:**
- PLC側でTCP通信が無効になっている
- ファイアウォールでTCPポートが遮断されている

**対処方法:**
1. Excel設定ファイルの`ConnectionMethod`を"UDP"に変更（推奨）
2. またはPLC側でTCP通信を有効化
3. またはファイアウォールでTCPポートを開放

**注意:**
- 代替プロトコルで接続成功している場合、データ通信は正常に動作します
- 警告が頻繁に出力される場合は、設定ファイルのプロトコル設定を変更してください
```

3. コード内XMLコメント: 各メソッドのドキュメントコメント追加

```csharp
/// <summary>
/// PLC接続を試行します。初期プロトコルで失敗した場合、自動的に代替プロトコルで再試行します。
/// </summary>
/// <returns>
/// 接続結果を含むConnectionResponseオブジェクト。
/// IsFallbackConnection=trueの場合、代替プロトコルで接続されたことを示します。
/// </returns>
public async Task<ConnectionResponse> ConnectAsync()

/// <summary>
/// 指定されたプロトコルで接続を試行します。
/// </summary>
/// <param name="useTcp">TCPを使用する場合true、UDPを使用する場合false</param>
/// <param name="timeoutMs">接続タイムアウト（ミリ秒）</param>
/// <returns>接続結果（成功/失敗、ソケット、エラー詳細）のタプル</returns>
private async Task<(bool success, Socket? socket, string? error)>
    TryConnectWithProtocolAsync(bool useTcp, int timeoutMs)

/// <summary>
/// 代替プロトコルの名称を取得します。
/// </summary>
/// <param name="useTcp">現在のプロトコルがTCPかどうか</param>
/// <returns>代替プロトコル名（"TCP"または"UDP"）</returns>
private string GetAlternativeProtocol(bool useTcp)
```

4. 実装完了レビュー:
   - 全Phase完了確認
   - 全テスト成功確認
   - ドキュメント網羅性確認

**期待される結果:**
- README、運用ガイドが更新される
- XMLコメントが充実する
- 実装が完了状態になる

---

## テストケース一覧

| テストID | テスト名 | テスト環境 | 期待結果 |
|---------|---------|----------|---------|
| TC_P5_001 | 実機_TCP接続のみ許可環境 | TCP許可/UDP拒否 | 初期TCPで接続成功 |
| TC_P5_002 | 実機_UDP接続のみ許可環境 | TCP拒否/UDP許可 | TCP失敗→UDP切替成功 |
| TC_P5_003 | 実機_ネットワーク遮断環境 | 全プロトコル拒否 | 両プロトコル失敗、適切なエラーメッセージ |

## 実装後の確認事項

### 必須確認項目

1. ✅ 全実機テストが成功
2. ✅ README更新完了
3. ✅ 運用ガイド更新完了
4. ✅ XMLコメント追加完了
5. ✅ 実装完了レビュー完了

### ドキュメント確認

1. **README**:
   - 自動プロトコル切り替え機能の説明
   - 動作フロー
   - メリット

2. **運用ガイド**:
   - トラブルシューティング情報
   - エラーメッセージの意味
   - 対処方法

3. **コードコメント**:
   - 各メソッドのXMLコメント
   - パラメータと戻り値の説明
   - 注意事項

## 想定工数

| ステップ | 作業内容 | 想定工数 | 備考 |
|---------|---------|---------|------|
| **Red** | 実機テストシナリオ作成 | 0.3h | 失敗基準明確化 |
| **Green** | 実機検証実施・修正 | 0.5h | 全シナリオ成功 |
| **Refactor** | ドキュメント整備 | 0.2h | 実装完了レビュー |
| **合計** | | **1h** | |

## 完了判定

以下の全条件が満たされた場合、Phase 5完了とする:

1. ✅ TC_P5_001（TCP接続のみ許可環境）成功
2. ✅ TC_P5_002（UDP接続のみ許可環境）成功
3. ✅ TC_P5_003（ネットワーク遮断環境）成功
4. ✅ README更新完了
5. ✅ 運用ガイド更新完了
6. ✅ XMLコメント追加完了

## 次のステップ

Phase 5完了後、**通信プロトコル自動切り替え機能の実装は完了**です。

必要に応じて、将来の拡張案（並行試行モード、成功プロトコルの記憶等）を検討してください。
