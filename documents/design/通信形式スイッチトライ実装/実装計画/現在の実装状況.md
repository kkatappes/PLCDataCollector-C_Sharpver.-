# 現在の実装状況（2025-11-28確認）

**最終更新**: 2025-11-28

## ❌ 実装状況サマリー: 未実装（Phase 0）

本実装計画に記載されている通信プロトコル自動切り替え機能は、**現時点で実装されていません**。

**TDD進行状況:**
- **現在のPhase**: Phase 0（実装開始前）
- **次のステップ**: Phase 1-Red（ConnectionResponseモデルの失敗テストを作成）
- **次に書くべきテスト**:
  1. `UsedProtocol_初期TCP成功時_TCPを返す()` テスト
  2. `IsFallbackConnection_代替プロトコル使用時_Trueを返す()` テスト
  3. `FallbackErrorDetails_初期プロトコル失敗時_エラー詳細を保持()` テスト

---

## ⚠️ 重要な前提条件の変更（2025-11-28）

**設定ファイル形式の変更:**
- **JSON形式**: Phase4_JSON廃止計画により廃止
- **Excel形式**: 現在の標準設定ファイル形式
- 本実装計画はExcel形式を前提として更新されています

**関連実装状況:**
- ✅ PlcConfiguration（Excel専用モデル）: 実装済み
- ✅ ConfigurationLoaderExcel（Excel読み込み機能）: 実装済み
- ✅ Excel設定ファイルからの基本接続設定読み込み: 実装済み

---

## 🔍 詳細確認結果

### 1. ConnectionResponseモデルの実装状況

**ファイル:** `andon/Core/Models/ConnectionResponse.cs`

**現在の実装（実装済みプロパティ）:**
```csharp
public class ConnectionResponse
{
    public required ConnectionStatus Status { get; init; }
    public Socket? Socket { get; init; }
    public DateTime? ConnectedAt { get; init; }
    public double? ConnectionTime { get; init; }
    public string? ErrorMessage { get; init; }
}
```

**不足プロパティ（通信プロトコル自動切り替え機能実装時に追加予定）:**
- ❌ `UsedProtocol` (string? - 実際に使用されたプロトコル: "TCP"/"UDP") - **未実装**
- ❌ `IsFallbackConnection` (bool - 代替プロトコルで接続したか) - **未実装**
- ❌ `FallbackErrorDetails` (string? - 初期プロトコル失敗時のエラー詳細) - **未実装**

**既存プロパティ（実装済み）:**
- ✅ `Status` (ConnectionStatus列挙型 - Connected/Failed/Timeout)
- ✅ `Socket` (Socket? - ソケットインスタンス)
- ✅ `ConnectedAt` (DateTime? - 接続完了時刻)
- ✅ `ConnectionTime` (double? - 接続所要時間ミリ秒)
- ✅ `ErrorMessage` (string? - エラーメッセージ)

---

### 2. ConnectAsyncメソッドの実装状況

**ファイル:** `andon/Core/Managers/PlcCommunicationManager.cs`

**本実装計画で追加する機能:**
```
初期プロトコルで接続試行
  ↓ 失敗
代替プロトコルで接続試行
  ↓ 失敗
両プロトコル失敗を記録して返却
```

**実際の実装状況:**
- ✅ 初期プロトコル（TCP/UDP）での接続試行は実装済み
- ✅ タイムアウト処理は実装済み
- ✅ 例外処理（SocketException, TimeoutException等）は実装済み
- ❌ **代替プロトコルでの再試行ロジックは未実装**
- ❌ **両プロトコル失敗時のエラー詳細記録は未実装**

**実装されている処理フロー（現状）:**
```
初期プロトコル（ConnectionConfig.UseTcpフラグに基づく）で接続試行
  ↓ 成功
ConnectionResponse返却（Status=ConnectionStatus.Connected, Socket設定済み）
  ↓ 失敗
例外スロー（TimeoutException/SocketException/PlcConnectionException等）
→ 処理終了
```

→ **代替プロトコルへのフォールバック処理が存在しない**

**注意**:
- 現在の実装は`ConnectionConfig`を使用（`PlcConfiguration`は直接使用していない）
- `ConnectionConfig`は`PlcConfiguration`から変換して作成される

---

### 3. 内部ヘルパーメソッドの実装状況

**本実装計画で追加する内部メソッド:**
- `GetAlternativeProtocol(bool useTcp)` - ❌ **未実装**
  - 引数: bool型（true=TCP, false=UDP）
  - 戻り値: string型（"TCP"または"UDP"）
- `TryConnectWithProtocolAsync(bool useTcp, int timeoutMs)` - ❌ **未実装**
  - 引数: プロトコル指定（bool）とタイムアウト（ミリ秒）
  - 戻り値: Task<(bool success, Socket? socket, string? error)>

**確認結果:**
- `PlcCommunicationManager.cs` 内に該当メソッドは存在しない
- 現在の`ConnectAsync()`メソッドは初期プロトコルでの接続試行のみ実装

---

### 4. ログ出力の実装状況

**本実装計画で追加するログ出力:**
- 接続試行開始ログ
- 初期プロトコル失敗時の警告ログ
- 代替プロトコル成功時の情報ログ
- 両プロトコル失敗時のエラーログ

**実際の実装状況:**
```csharp
// [TODO: ログ出力] 接続開始
// LoggingManager: $"PLC接続開始 - IP:{_connectionConfig.IpAddress}, ..."

// [TODO: ログ出力] タイムアウト設定
// LoggingManager: $"Socketタイムアウト設定 - ..."

// [TODO: ログ出力] 接続完了
// LoggingManager: $"PLC接続完了 - 接続時間:{connectionTime:F2}ms, ..."
```

→ **全てTODOコメントのみで、実際のログ出力実装なし**

---

## 🔧 設定情報の変換について

**重要: PlcConfigurationとConnectionConfigの役割分担**

**PlcConfiguration** (Excel読み込み専用):
- Excel設定ファイルから読み込んだ全設定情報を保持
- プロパティ例:
  - `IpAddress` (string)
  - `Port` (int)
  - `ConnectionMethod` (string: "TCP"/"UDP")
  - `Timeout` (int: ミリ秒)
  - `FrameVersion` (string: "3E"/"4E")
  - `IsBinary` (bool)
  - `MonitoringIntervalMs` (int)
  - `Devices` (List<DeviceSpecification>)

**ConnectionConfig** (PLC通信専用):
- PLC通信時に使用する接続設定のみを保持
- プロパティ例:
  - `IpAddress` (string)
  - `Port` (int)
  - `UseTcp` (bool: TCP使用フラグ)
  - `ConnectionType` (string計算プロパティ: "TCP"/"UDP")
  - `IsBinary` (bool)
  - `FrameVersion` (FrameVersion列挙型: Frame3E/Frame4E)

**TimeoutConfig** (タイムアウト設定専用):
- プロパティ例:
  - `ConnectTimeoutMs` (int)
  - `SendTimeoutMs` (int)
  - `ReceiveTimeoutMs` (int)

**変換フロー:**
```
Excel設定ファイル (*.xlsx)
  ↓ ConfigurationLoaderExcel.LoadFromExcel()
PlcConfiguration
  ↓ ★変換処理（未実装）
ConnectionConfig + TimeoutConfig
  ↓ PlcCommunicationManagerコンストラクタ
PlcCommunicationManager
```

→ **PlcConfigurationからConnectionConfig/TimeoutConfigへの変換処理が必要**

---

## 📋 実装に必要な作業

### Phase 1: ConnectionResponseモデル拡張

1. `ConnectionResponse`クラスに以下のプロパティを追加:
   ```csharp
   public string? UsedProtocol { get; init; }          // "TCP"/"UDP"
   public bool IsFallbackConnection { get; init; }     // 代替プロトコルで接続したか
   public string? FallbackErrorDetails { get; init; }  // 初期プロトコル失敗時のエラー詳細
   ```

2. 既存プロパティは変更せず維持:
   - `Status`, `Socket`, `ConnectedAt`, `ConnectionTime`, `ErrorMessage`

### Phase 2: PlcCommunicationManager拡張

1. 内部ヘルパーメソッド実装（privateメソッド）:
   ```csharp
   private string GetAlternativeProtocol(bool useTcp)
   private async Task<(bool success, Socket? socket, string? error)>
       TryConnectWithProtocolAsync(bool useTcp, int timeoutMs)
   ```

2. `ConnectAsync()`メソッドを拡張:
   - 初期プロトコル（`ConnectionConfig.UseTcp`）で接続試行
   - 失敗時に代替プロトコルで再試行
   - 新規プロパティ（`UsedProtocol`, `IsFallbackConnection`, `FallbackErrorDetails`）を適切に設定

### Phase 3: ログ出力実装

- 現在TODOコメントになっている箇所を実装:
  - 接続開始ログ
  - 初期プロトコル失敗時の警告ログ
  - 代替プロトコル成功時の情報ログ
  - 両プロトコル失敗時のエラーログ

### Phase 4: 統合テスト

- `Step3_6_IntegrationTests.cs`に統合テストを追加:
  - TCP→UDP自動切り替えでの送受信テスト
  - UDP→TCP自動切り替えでの送受信テスト
  - 両プロトコル失敗時のエラーハンドリングテスト

### Phase 5: 実機検証とドキュメント

- 実機テストシナリオ作成・実施:
  - TCP接続のみ許可環境でのテスト
  - UDP接続のみ許可環境でのテスト
  - ネットワーク遮断環境でのテスト
- ドキュメント更新:
  - README
  - 運用ガイド
  - XMLコメント

---

## ⚠️ 実装前の確認事項

1. **PlcConfiguration → ConnectionConfig変換処理の確認**
   - 変換処理が実装されているか確認
   - 未実装の場合は先に実装が必要

2. **既存テストへの影響確認**
   - `ConnectionResponse`に新規プロパティを追加するため、既存テストの修正が必要
   - `PlcCommunicationManagerTests.cs`の更新

3. **呼び出し側への影響確認**
   - `ExecutionOrchestrator`等、`ConnectAsync()`を呼び出している箇所の確認
   - 新規プロパティ（`UsedProtocol`, `IsFallbackConnection`）の利用方法を検討

---

## 📝 次のアクション（TDD手順）

### ステップ1: Phase 1-Red開始
1. `ConnectionResponseTests.cs`を開く
2. 以下の3つの**失敗するテスト**を作成:
   - `UsedProtocol_初期TCP成功時_TCPを返す()`
   - `IsFallbackConnection_代替プロトコル使用時_Trueを返す()`
   - `FallbackErrorDetails_初期プロトコル失敗時_エラー詳細を保持()`
3. テスト実行 → **コンパイルエラー（Red状態）を確認**

### ステップ2: Phase 1-Green
1. `ConnectionResponse.cs`に新規プロパティを追加
2. テスト実行 → **全テスト成功（Green状態）を確認**

### ステップ3: Phase 1-Refactor
1. XMLコメント追加・妥当性確認
2. テスト実行 → **全テスト成功を維持**

### ステップ4: Phase 2以降
Phase 1完了後、Phase 2-Redに進む（各Phase文書参照）

---

## 注意事項

**テストファースト原則を厳守**:
- 実装前に必ず失敗するテストを書く
- 各Phaseを完了してから次に進む
- 常にテスト成功を維持（Refactorステップでテストが壊れていないことを確認）

**依存関係の確認**:
- PlcConfiguration → ConnectionConfig/TimeoutConfigの変換処理が未実装の場合は先に対応が必要
- 既存の`ConnectionResponse`を使用しているコードへの影響を確認

---

## 実装完了の定義

以下の全条件が満たされた場合、通信プロトコル自動切り替え機能の実装は完了とする:

1. ✅ Phase 1完了（ConnectionResponseモデル拡張）
2. ✅ Phase 2完了（接続ロジック実装）
3. ✅ Phase 3完了（ログ出力実装）
4. ✅ Phase 4完了（統合テスト）
5. ✅ Phase 5完了（実機検証とドキュメント）
6. ✅ 全テストがGreen状態
7. ✅ 実機テスト3シナリオが全て成功
8. ✅ ドキュメント更新完了

---

## 実装状況チェックリスト

### Phase 1: ConnectionResponseモデル拡張
- [ ] Red: 失敗するテスト作成
- [ ] Green: 新規プロパティ追加
- [ ] Refactor: XMLコメント追加
- [ ] 全テスト成功確認

### Phase 2: 接続ロジック実装
- [ ] Red: 失敗するテスト作成
- [ ] Green: 代替プロトコル試行ロジック実装
- [ ] Refactor: コード改善
- [ ] 全テスト成功確認

### Phase 3: ログ出力実装
- [ ] Red: 失敗するテスト作成
- [ ] Green: ログ出力実装
- [ ] Refactor: ログメッセージ統一
- [ ] 全テスト成功確認

### Phase 4: 統合テスト
- [ ] Red: 失敗する統合テスト作成
- [ ] Green: 統合動作確認
- [ ] Refactor: テストケース追加
- [ ] 全テスト成功確認

### Phase 5: 実機検証とドキュメント
- [ ] Red: 実機テストシナリオ作成
- [ ] Green: 実機検証実施
- [ ] Refactor: ドキュメント整備
- [ ] 全シナリオ成功確認

---

## 変更履歴

| 日付 | 変更内容 | 変更者 |
|------|---------|-------|
| 2025-11-28 | 初版作成（実装状況確認） | - |
| 2025-11-28 | Excel専用システム対応追記 | - |
