# Step7 データ出力機能 実装計画概要

## 目的
本実装計画は、`実装ガイド.md`と`実装時対応関係.md`の長大な内容を、段階的な実装フェーズに分割したものです。各フェーズごとに明確な実装範囲と完了条件を定義し、TDD手法に沿った実装を可能にします。

---

## フェーズ構成

### Phase1: 基本構造・モデル実装
**期間**: 1～2日
**難易度**: ★☆☆☆☆
**ファイル**: `Phase1_基本構造・モデル実装.md`

#### 実装内容
- `IDataOutputManager`インターフェース定義
- `DataOutputManager`へのインターフェース実装明示
- `DeviceEntryInfo`の移動（オプション）

#### 完了条件
- [ ] インターフェース定義が完了
- [ ] `dotnet build`が成功
- [ ] 既存テストがパス

#### 依存関係
- 前提: 既存の`DataOutputManager`が実装済み
- 次Phase: Phase2（JSON生成機能実装）

---

### Phase2: JSON生成機能実装
**期間**: 1～2日
**難易度**: ★★☆☆☆
**ファイル**: `Phase2_JSON生成機能実装.md`

#### 実装内容
- device.numberの3桁ゼロ埋めフォーマット
- ディレクトリ存在確認・作成処理
- ログ出力の追加
- **単体テスト実装（TDD）**

#### 完了条件
- [ ] device.numberが3桁ゼロ埋めで出力
- [ ] ディレクトリ自動作成が動作
- [ ] ログ出力が正常動作
- [ ] **単体テスト（TC_P2_001～TC_P2_005）が実装・パス**

#### 依存関係
- 前提: Phase1完了
- 次Phase: Phase3（ビットデバイス分割処理実装）

---

### Phase3: ビットデバイス分割処理実装
**期間**: 3～5日
**難易度**: ★★★★☆（最重要・最難関）
**ファイル**: `Phase3_ビットデバイス分割処理実装.md`

#### 実装内容
- items配列生成ロジックの全面改修
- ビットデバイス16ビット分割処理
- deviceConfig辞書の拡張（呼び出し側で対応）

#### 完了条件
- [ ] ビットデバイスが16ビット分に展開される
- [ ] ワード/ダブルワードは分割されない
- [ ] 単体テスト（TC_P3_001～TC_P3_007）がパス

#### 依存関係
- 前提: Phase2完了
- 次Phase: Phase4（エラーハンドリング実装）

#### 注意事項
**重要**: このPhaseがStep7データ出力機能の核心部分です。十分な時間を確保してください。

---

### Phase4: エラーハンドリング実装
**期間**: 2～3日
**難易度**: ★★★☆☆
**ファイル**: `Phase4_エラーハンドリング実装.md`

#### 実装内容
- try-catchブロックの追加
- データ検証処理（ValidateInputData）
- ファイル出力エラー処理の詳細化
- ログ出力の強化
- OutputResultクラスの実装（オプション）

#### 完了条件
- [ ] データ検証処理が実装されている
- [ ] try-catchブロックが実装されている
- [ ] エラーログが各catch節で出力される
- [ ] エラーケーステストがパス

#### 依存関係
- 前提: Phase3完了
- 次Phase: Phase5（テスト実装）

---

### Phase5: 統合テスト・検証
**期間**: 2～3日
**難易度**: ★★★☆☆
**ファイル**: `Phase5_テスト実装.md`

#### 実装内容
- **統合テスト**（Step3～Step7の一貫処理）
- **パフォーマンステスト**（オプション）
- **全Phaseテストの再実行・確認**
- **5JRS_N2.xlsx実ファイルテスト**

#### 完了条件
- [ ] 統合テスト（Step1-2設定読み込み→Step7出力）が実装・パス
- [ ] 全Phase（Phase2-4）のテストが再実行されパスする
- [ ] テストカバレッジが80%以上
- [ ] **Step1で保留中の5JRS_N2.xlsx統合テストが実行・パス**

#### 依存関係
- 前提: Phase4完了
- 次Phase: なし（実装完了）

#### 注意事項
**重要**: Phase2-4で各Phaseのテストは実装済みのため、Phase5では統合テストと全体検証に専念します。

---

## 実装順序とスケジュール

### 推奨スケジュール（合計: 10～15日）

```
Day 1-2:   Phase1 基本構造・モデル実装（既存テスト確認）
Day 3-4:   Phase2 JSON生成機能実装 + 単体テスト（TDD）
Day 5-9:   Phase3 ビットデバイス分割処理実装 + 単体テスト（TDD） ← 最重要
Day 10-12: Phase4 エラーハンドリング実装 + エラーテスト（TDD）
Day 13-15: Phase5 統合テスト・全体検証
```

### TDD実装サイクル（重要）
各Phase（Phase2-4）で以下のサイクルを**テストケースごとに1つずつ**厳守:
1. **Red**: 1つのテストメソッドを実装（失敗することを確認）
2. **Green**: そのテストをパスさせる最小限の機能を実装（テストがパスすることを確認）
3. **Refactor**: コードリファクタリング（テストは継続パス）
4. **次のテストケースへ**: 上記1-3を繰り返す

**禁止事項**:
- ❌ すべてのテストメソッドを一度に実装してから機能実装する
- ❌ 機能を先に実装してからテストを書く
- ❌ Phase5でまとめてテストを実装する

**推奨事項**:
- ✅ 1つのテストケースごとにRed-Green-Refactorサイクルを完結させる
- ✅ テスト失敗理由が「機能未実装」であることを確認する
- ✅ 各ステップで`dotnet test`を実行して状態を確認する

### 最優先Phaseと理由

#### 1. Phase3（ビットデバイス分割処理実装）
**理由**: Step7データ出力機能の核心部分であり、最も複雑な実装

#### 2. Phase4（エラーハンドリング実装）
**理由**: 本番運用時の安定性に直結

#### 3. Phase2-4各Phase（TDD実装）
**理由**: 各Phaseで実装と同時にテストを実装することで、品質を早期に保証

---

## 各Phaseの難易度マトリックス

| Phase | 難易度 | 実装量 | テスト量 | 重要度 | 推奨期間 | TDD |
|-------|--------|--------|----------|--------|----------|-----|
| Phase1 | ★☆☆☆☆ | 小 | 小 | 中 | 1～2日 | N/A（既存テスト確認のみ） |
| Phase2 | ★★☆☆☆ | 小 | 中 | 中 | 1～2日 | ✅ 必須 |
| Phase3 | ★★★★☆ | 大 | 大 | 最高 | 3～5日 | ✅ 必須 |
| Phase4 | ★★★☆☆ | 中 | 中 | 高 | 2～3日 | ✅ 必須 |
| Phase5 | ★★★☆☆ | 小 | 中 | 高 | 2～3日 | N/A（統合テストのみ） |

---

## 実装時の重要な注意事項

### 1. TDD手法の厳守（最重要）
- **Phase2-4では必ずテストを先に実装**してから機能実装する
- 各Phaseでテスト→実装→リファクタリングのサイクルを完結させる
- **Phase5でまとめてテストを実装することは禁止**（TDDの原則に反する）
- テストなしでPhase完了とは認めない

### 2. ビルド確認の頻度
- 各Phaseの各ステップ完了後に`dotnet build`を実行
- コンパイルエラーを早期に発見

### 3. コミット戦略
- 各Phaseの完了時点でGitコミット
- コミットメッセージ例: "Phase1完了: IDataOutputManagerインターフェース定義"

### 4. Phase3の重要性
**Phase3はStep7データ出力機能の核心部分です。以下の点に注意してください**:
- 十分な時間を確保（3～5日）
- ビットデバイス分割処理の理解を深める
- 単体テストを先に実装（TDD）
- deviceConfig辞書の構築処理も忘れずに対応

### 5. エラーハンドリングの徹底
Phase4では**すべてのエラーケース**を網羅的に実装してください:
- データ検証エラー
- ファイルI/Oエラー
- 予期しないエラー

---

## 既存実装との対応関係

### 現在の実装状況（Phase0）
- ✅ `DataOutputManager.OutputToJson()` メソッド実装済み
- ✅ `DeviceEntryInfo` クラス実装済み
- ❌ `IDataOutputManager` インターフェース未定義
- ❌ ビットデバイス16ビット分割処理未実装
- ❌ device.number 3桁ゼロ埋め未対応
- ❌ エラーハンドリング未実装

### 各Phaseで解決される問題

| Phase | 解決される問題 |
|-------|----------------|
| Phase1 | インターフェース未定義 |
| Phase2 | device.number 3桁ゼロ埋め未対応、ログ出力不足 |
| Phase3 | ビットデバイス16ビット分割処理未実装 |
| Phase4 | エラーハンドリング未実装 |
| Phase5 | テスト不足 |

---

## トラブルシューティング

### Phase3でビットデバイス分割処理がうまくいかない場合
1. `DeviceCode.IsBitDevice()` が正常動作しているか確認
2. ビット抽出処理（`(bitValue >> i) & 1`）が正しいか確認
3. deviceConfig辞書に16エントリが正しく登録されているか確認
4. 単体テストでデバッグ

### Phase4でエラーハンドリングが期待通り動作しない場合
1. try-catchブロックが正しく配置されているか確認
2. 各例外の再スロー（`throw;`）が実装されているか確認
3. ログ出力が各catch節に実装されているか確認

### Phase5でテストがパスしない場合
1. モックデータが正しく生成されているか確認
2. 期待値が正しく設定されているか確認
3. テスト対象メソッドの実装が正しいか確認

---

## 完了後のチェックリスト

### 全Phase完了後の確認項目
- [ ] すべてのPhaseの完了条件を満たしている
- [ ] `dotnet build` が成功する
- [ ] `dotnet test` がすべてパスする
- [ ] テストカバレッジが80%以上
- [ ] 実機テストが成功する（PLC接続環境）
- [ ] ドキュメントが最新化されている

### 実装記録の作成
各Phaseの完了時に、以下の実装記録を作成してください:
- **場所**: `documents/implementation_records/method_records/`
- **内容**: 実装判断の根拠、技術選択の理由、発生した問題と解決方法

---

## 参照文書

### メイン文書
- `実装ガイド.md`: 全体的な実装仕様
- `実装時対応関係.md`: 既存実装との連携方法

### 設計文書
- `クラス設計/Step7_データ出力.md`: クラス設計詳細
- `クラス設計/インターフェース定義.md`: インターフェース設計
- `クラス設計/補助クラス・データモデル.md`: データモデル定義

### 各Phase文書
- `Phase1_基本構造・モデル実装.md`
- `Phase2_JSON生成機能実装.md`
- `Phase3_ビットデバイス分割処理実装.md`
- `Phase4_エラーハンドリング実装.md`
- `Phase5_テスト実装.md`

---

## 質問・問題発生時の対応

### 仕様が不明確な場合
1. `実装ガイド.md` を確認
2. `実装時対応関係.md` を確認
3. ユーザーに質問

### 実装方法が不明確な場合
1. 各Phase文書の「実装手順」セクションを確認
2. コード例を参照
3. 既存実装を確認

### テストがパスしない場合
1. 各Phase文書の「テスト要件」セクションを確認
2. モックデータが正しいか確認
3. デバッガを使用して原因を特定

---

## 作成日時
- **作成日**: 2025年11月27日
- **対象**: Step7データ出力機能実装
- **対象Phase**: Phase1～Phase5
